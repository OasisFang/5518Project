<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Pillbox Controller V6_fix_4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <style>
        body { 
            padding: 20px; 
            background-color: #f8f9fa; 
            font-size: 0.95rem;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        .card { 
            margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            border-radius: 12px; 
            border: none;
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .card-header { 
            background-color: #0d6efd; 
            color: white; 
            font-weight: 600; 
            border-top-left-radius: 12px; 
            border-top-right-radius: 12px; 
            padding: 1rem;
            border-bottom: none;
        }
        .card-body { 
            padding: 1.25rem; 
            background-color: #fff;
        }
        .status-disconnected { 
            color: #dc3545; 
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        .status-connected { 
            color: #198754; 
            font-weight: 600;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .mode-indicator { 
            font-size: 0.9em; 
            padding: 8px 16px; 
            border-radius: 20px; 
            display: inline-block; 
            margin-left: 15px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mode-simulation { 
            background-color: #ffc107; 
            color: #000; 
        }
        .mode-real { 
            background-color: #20c997; 
            color: white; 
        }
        .log-box { 
            max-height: 200px; 
            overflow-y: auto; 
            border: 1px solid #e9ecef; 
            padding: 15px; 
            font-family: 'Consolas', monospace; 
            font-size: 0.85em; 
            background-color: #f8f9fa; 
            border-radius: 8px; 
            margin-top: 15px;
        }
        .btn {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0b5ed7;
        }
        .form-control {
            border-radius: 8px;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            transition: border-color 0.2s ease-in-out;
        }
        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25);
        }
        .alert {
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .alert-info {
            background-color: #e7f5ff;
            color: #0c5460;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease-in-out;
        }
        .step-circle.active {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(13,110,253,0.2);
        }
        .real-time-weight {
            font-size: 1.2em;
            font-weight: 600;
            color: #0d6efd;
            padding: 10px;
            background-color: #e7f5ff;
            border-radius: 8px;
            margin-top: 10px;
        }
        .weight-stable {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .table {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .table td {
            vertical-align: middle;
        }
        .table-active-pc-med td:first-child {
            font-weight: 600;
            background-color: #e7f5ff !important;
        }
        .nav-pills .nav-link {
            border-radius: 20px;
            padding: 8px 16px;
            margin: 0 4px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            box-shadow: 0 2px 4px rgba(13,110,253,0.2);
        }
        .nav-pills .nav-link:hover:not(.active) {
            background-color: #e9ecef;
        }
        .section { display: none; } 
        .table th, .table td { vertical-align: middle; font-size: 0.9rem; }
        .table-active-pc-med td:first-child { font-weight: bold; background-color: #cfe2ff !important; }
        .small-text, .form-label-sm, small { font-size: 0.85em; color: #6c757d;}
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .form-control-sm { font-size: 0.875rem; padding: 0.25rem 0.5rem; }
        .nav-pills .nav-link { font-size: 0.9rem; cursor: pointer; } 
        .nav-pills .nav-link.active { background-color: #0d6efd; color: white; }
        .sub-section { margin-top: 1rem; padding: 0.75rem; border: 1px solid #e0e0e0; border-radius: 0.25rem; background-color: #fdfdfd; }
        h6.section-title { color: #0056b3; margin-bottom: 0.75rem; font-weight:600; font-size: 1rem; }
        .step-label { font-weight: 500; color: #333; display: block; margin-bottom: 0.3rem;}
        .consumption-log-entry { font-size: 0.9em; padding: 0.25rem 0.5rem; border-bottom: 1px dashed #eee; }
        .consumption-log-entry:last-child { border-bottom: none; }
        /* 盖子开合指示 */
        .lid-indicator { display: inline-block; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-size: 0.9rem; }
        .lid-open { background-color: #d4edda; color: #155724; }
        .lid-closed { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0" style="font-size: 1.75rem;">Smart Pillbox Controller V6_fix_4</h1>
            <div>
                <span id="connectionStatus" class="status-disconnected">Disconnected</span>
                <div id="modeIndicator" class="mode-indicator mode-simulation">Simulation Mode</div>
                <div id="lidIndicator" class="lid-indicator lid-closed">Closed</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Global Control</div>
            <div class="card-body d-flex justify-content-start align-items-center">
                <button class="btn btn-warning me-2 btn-sm" onclick="setMode('simulation')">Simulation Mode</button>
                <button class="btn btn-success me-2 btn-sm" onclick="setMode('real')">Real Mode</button>
                <div class="vr mx-2"></div>
                <button class="btn btn-primary me-2 btn-sm" onclick="setStage(0)">Weighing/Setup Stage</button>
                <button class="btn btn-info me-2 btn-sm" onclick="setStage(1)">Medication Stage</button>
                <button class="btn btn-secondary me-2 btn-sm" onclick="location.href='/calendar'">Calendar Reminders</button>
                <button class="btn btn-danger btn-sm" onclick="setStage(2)">Reset System (Arduino)</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header">Arduino Real-Time Status</div>
                    <div class="card-body">
                        <p class="mb-1 small-text"><strong>Stage:</strong> <span id="arduinoStageName">N/A</span></p>
                        <p class="mb-1 small-text"><strong>Current Medication:</strong> <span id="arduinoCurrentMed">N/A</span></p>
                        <p class="mb-1 small-text"><strong>Medication WPP (g):</strong> <span id="arduinoCurrentMedWPP">N/A</span></p>
                        <p class="mb-1 small-text"><strong>Pillbox Total Weight (g):</strong> <span id="arduinoTotalWeight">N/A</span></p>
                        <p class="mb-1 small-text"><strong>Pill Count:</strong> <span id="arduinoCurrentMedCount">N/A</span></p>
                        <details class="mt-2"><summary class="small-text text-muted" style="cursor:pointer;">Raw Data</summary>
                            <code id="rawData" style="font-size:0.8em; display:block; max-height: 50px; overflow-y:auto;">N/A</code>
                        </details>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header">PC-Managed Medication Status (<span id="pcActiveMedicationDisplay" class="text-warning">Current: None</span>)</div>
                    <div class="card-body">
                        <!-- 添加新的药物输入区域 -->
                        <div class="row g-3 align-items-end mb-3">
                            <div class="col-md-6">
                                <label for="newMedNameInput" class="form-label form-label-sm">Add New Medication:</label>
                                <input type="text" id="newMedNameInput" class="form-control form-control-sm" placeholder="Enter medication name">
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-success btn-sm w-100" onclick="addOrUpdateKnownMedication()">Add to PC List</button>
                            </div>
                        </div>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead><tr><th>Medication</th><th>WPP (g)</th><th>Total Weight (g)</th><th>Count</th></tr></thead>
                                <tbody id="pcManagedMedicationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="medicationManagementCard" class="card">
            <div class="card-header">Medication Management (PC-Defined Medication List)</div>
            <div class="card-body">
                <!-- 步骤1: 添加或选择药物 -->
                <div id="wppStep1" class="wpp-step-content">
                    <h6 class="step-label">Step 1: Add or Select Medication</h6>
                    <hr>
                    <h6 class="section-title">PC Known Medication List (Click Name to Set as Current Medication)</h6>
                    <table class="table table-hover table-sm mb-3">
                        <thead><tr><th>Medication Name (Set Active)</th><th>WPP (g)</th><th>Total Weight (g)</th><th>Estimated Count</th></tr></thead>
                        <tbody id="knownMedicationsClickableTableBody"></tbody>
                    </table>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary btn-sm" onclick="moveToWppStep(2)">Next: Select Measurement Mode</button>
                    </div>
                </div>
                <!-- 只有选中药物后才显示后续步骤 -->
                <div id="wppSettingSectionForActiveMed" class="sub-section" style="display:none;"> 
                    <!-- 步骤式WPP测量界面（步骤2~6） -->
                    <div class="card bg-light mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Step-by-Step WPP Measurement</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-center align-items-center mb-3">
                                <div id="wppStepCircle1" class="rounded-circle d-flex justify-content-center align-items-center me-2" style="width:50px; height:50px; background-color:#007bff; color:white; font-weight:bold;">1</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="wppStepCircle2" class="rounded-circle d-flex justify-content-center align-items-center mx-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">2</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="wppStepCircle3" class="rounded-circle d-flex justify-content-center align-items-center mx-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">3</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="wppStepCircle4" class="rounded-circle d-flex justify-content-center align-items-center mx-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">4</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="wppStepCircle5" class="rounded-circle d-flex justify-content-center align-items-center mx-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">5</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="wppStepCircle6" class="rounded-circle d-flex justify-content-center align-items-center ms-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">6</div>
                            </div>
                            
                            <!-- 步骤2: 选择测量模式 -->
                            <div id="wppStep2" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 2: Select Measurement Mode</h6>
                                <p class="small-text mb-2">Choose an appropriate setting for WPP measurement of single pill weight</p>
                                <div class="d-flex mb-3">
                                    <button class="btn btn-outline-primary me-2" onclick="moveToWppStep(3, 'simulated')">Simulated Environment: Manual Input of Single Pill Weight</button>
                                    <button class="btn btn-outline-success" onclick="moveToWppStep(3, 'real')">Real/Simulated Environment: Measure Single Pill Weight</button>
                                </div>
                            </div>
                            
                            <!-- 步骤3: 模拟环境输入 -->
                            <div id="wppStep3-simulated" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 3: Input Single Pill Weight</h6>
                                <div class="row g-2 align-items-end mb-3">
                                    <div class="col">
                                        <label for="simulatedSinglePillWeightInput" class="form-label form-label-sm">Input the weight of this <strong class="text-danger">single pill</strong> in simulated mode (g):</label>
                                        <input type="number" step="0.001" id="simulatedSinglePillWeightInput" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-success btn-sm" onclick="setWPPFromSimulatedSinglePillWeight()">Confirm and Update WPP</button>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="moveToWppStep(2, 'simulated')">Back</button>
                                    <button class="btn btn-sm btn-primary" onclick="moveToWppStep(4)">Next: Confirm WPP Settings</button>
                                </div>
                            </div>
                            
                            <!-- 步骤3: 真实环境测量 -->
                            <div id="wppStep3-real" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 3: Prepare to Measure Single Pill Weight</h6>
                                <p class="small-text">In real mode, WPP is set through actual sensor readings. In simulated mode, you can manually input simulated values.</p>
                                <div id="realMeasureWPPButtonContainer">
                                    <button class="btn btn-outline-secondary btn-sm mb-2" onclick="tareArduinoForMeasurement()">Prepare Measurement: Tare (Arduino Zero) the Pillbox</button>
                                    <p class="small-text mb-1">(Physical operation) Place '<span class="current-active-med-name-wpp text-primary"></span>'s <strong class="text-danger">single pill</strong> in the pillbox and wait for weight stabilization.</p>
                                    
                                    <!-- 在真实模式下显示实时重量 -->
                                    <div id="realTimeWeightContainerInStep3" class="real-time-weight mt-3" style="display:none;">
                                        <strong>Real-Time Weight:</strong> <span id="realTimeWeightValueInStep3">0.00</span>g
                                        <div class="small-text text-muted">(From Arduino real-time data)</div>
                                        <button class="btn btn-sm btn-outline-warning mt-2" onclick="tareArduinoForMeasurement()">Sensor Tare/Zero</button>
                                    </div>
                                    
                                    <!-- 添加模拟模式下的手动输入 -->
                                    <div id="simulatedWPPInputContainer" style="display:none;" class="mt-3">
                                        <div class="row g-2 align-items-end">
                                            <div class="col">
                                                <label for="simulatedRealModeWeightInput" class="form-label form-label-sm">Simulated Measurement: Input the weight of this <strong class="text-danger">single pill</strong> (g):</label>
                                                <input type="number" step="0.001" id="simulatedRealModeWeightInput" class="form-control form-control-sm">
                                            </div>
                                            <div class="col-auto">
                                                <button class="btn btn-success btn-sm" onclick="setWPPFromRealModeSimulatedWeight()">Confirm and Update WPP</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="moveToWppStep(2, 'real')">Back</button>
                                    <button class="btn btn-sm btn-primary" onclick="moveToStep4WithCurrentWeight()">Next: Confirm Measurement</button>
                                </div>
                            </div>
                            
                            <!-- 步骤4: 确认WPP -->
                            <div id="wppStep4" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 4: Confirm WPP Settings</h6>
                                <p class="small-text mb-2">WPP has been set up correctly, please confirm the information is accurate</p>
                                <div class="alert alert-info">
                                    <div><strong>Medication:</strong> <span id="wppConfirmMedName">-</span></div>
                                    <div><strong>Single Pill Weight (WPP):</strong> <span id="wppConfirmValue">-</span>g</div>
                                    <div id="realTimeWeightContainer" style="display:none;">
                                        <div class="mt-2"><strong>Real-Time Weight:</strong> <span id="realTimeWeightValue">-</span>g</div>
                                        <div class="small-text text-muted">(From Arduino real-time data)</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="moveToWppStep(3)">Back</button>
                                    <button class="btn btn-sm btn-primary" onclick="moveToWppStep(5)">Next: Set Inventory</button>
                                </div>
                            </div>

                            <!-- 步骤5: 设置库存 -->
                            <div id="wppStep5" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 5: Set Medication Inventory</h6>
                                <p class="small-text mb-2">Set the number/total weight of '<span class="current-active-med-name-wpp text-primary"></span>' in the pillbox</p>
                                
                                <!-- 实时重量显示卡片 -->
                                <div class="card mb-3" id="realTimeWeightCard">
                                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Current Pillbox Real-Time Weight</h6>
                                        <button type="button" class="btn btn-sm btn-light" id="refreshWeightBtnStep5" onclick="refreshWeightStep5()">
                                            <i class="fas fa-sync-alt"></i> Refresh Weight
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center mb-3">
                                            <h3 id="currentWeightDisplayInStep5">0.000</h3>
                                            <p class="text-muted mb-0">g</p>
                                            <small id="weightUpdateStatusInStep5" class="text-muted">Waiting for data...</small>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <h6>Pill Calculation</h6>
                                            <div class="d-flex justify-content-between">
                                                <span>Single Pill Weight:</span>
                                                <span id="wppDisplayInStep5">0.000 g</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Estimated Pill Count:</span>
                                                <span id="pillCountDisplayInStep5">0</span>
                                            </div>
                                            <div class="progress mt-2">
                                                <div id="pillCountProgressBarInStep5" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid gap-2 mt-3">
                                            <button type="button" class="btn btn-success" id="confirmWeightBtnInStep5" onclick="confirmWeightAndSetInventory()">
                                                确认重量和药片数量
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="tareWeightBtnInStep5" onclick="tareArduinoForMeasurement()">
                                                <i class="fas fa-balance-scale"></i> Tare/Calibrate
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="weighingSimModeOnlyControls"> 
                                    <ul class="nav nav-pills mb-3 nav-fill" id="simInventoryUpdateModeTab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="inv-sim-measure-total-tab" data-bs-toggle="pill" data-bs-target="#inv-sim-measure-total-pane" type="button" role="tab" aria-controls="inv-sim-measure-total-pane" aria-selected="true" onclick="showTab('inv-sim-measure-total-pane', this)">Update via Total Weight (Simulated Measurement)</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="inv-sim-manual-count-tab" data-bs-toggle="pill" data-bs-target="#inv-sim-manual-count-pane" type="button" role="tab" aria-controls="inv-sim-manual-count-pane" aria-selected="false" onclick="showTab('inv-sim-manual-count-pane', this)">Update via Manual Count</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content" id="simInventoryUpdateModeTabContent">
                                        <div class="tab-pane fade show active" id="inv-sim-measure-total-pane" role="tabpanel" aria-labelledby="inv-sim-measure-total-tab">
                                            <p class="small-text">Simulated measurement of the total weight of active medication in the pillbox.</p>
                                            <button class="btn btn-outline-secondary btn-sm mb-2" onclick="tareArduinoForMeasurement()">Step A1: Tare (Arduino Zero) Current Medication Batch</button>
                                            <p class="small-text mb-1">Step A2: (Virtual operation) Place all pills of '<span class="current-active-med-name-wpp text-primary"></span>' into the pillbox.</p>
                                            <div class="row g-2 align-items-end">
                                                <div class="col">
                                                    <label for="simBatchTotalWeightInput" class="form-label form-label-sm">Step A3: Input the simulated total weight of this batch of medication (g):</label>
                                                    <input type="number" step="0.01" id="simBatchTotalWeightInput" class="form-control form-control-sm">
                                                </div>
                                                <div class="col-auto">
                                                    <button class="btn btn-primary btn-sm" onclick="setInventoryBySimulatedBatchWeight()">Set Total Weight & Calculate Count</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="inv-sim-manual-count-pane" role="tabpanel" aria-labelledby="inv-sim-manual-count-tab">
                                            <p class="small-text">Manual input of the total number of active medication in the pillbox.</p>
                                            <div class="row g-2 align-items-end">
                                                <div class="col">
                                                    <label for="inventoryManualPillCountInput" class="form-label form-label-sm">Step B1: Input the total number of pills of '<span class="current-active-med-name-wpp text-primary"></span>' (as counted by hand):</label>
                                                    <input type="number" id="inventoryManualPillCountInput" class="form-control form-control-sm" min="0">
                                                </div>
                                                <div class="col-auto">
                                                    <button class="btn btn-primary btn-sm" onclick="setInventoryByManualPillCount()">Set Count & Calculate Total Weight</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="small-text mt-2" id="weighingRealModeInfoForInventory" style="display:none;">In real mode, the total weight and count of the pillbox are determined by actual sensor readings, and WPP has been set up correctly. <br>The real-time weight will automatically update, please confirm that the medication count has been calculated correctly before clicking the button below to complete the setup.</p>
                                
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="moveToWppStep(4)">Back</button>
                                </div>
                            </div>

                            <!-- 步骤6: 完成设置 -->
                            <div id="wppStep6" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 6: Complete Setup</h6>
                                <div class="alert alert-success">
                                    <div><strong>Medication Name:</strong> <span id="summaryMedName">-</span></div>
                                    <div><strong>Single Pill Weight (WPP):</strong> <span id="summaryWPP">-</span>g</div>
                                    <div><strong>Total Count:</strong> <span id="summaryCount">-</span> pills</div>
                                    <div><strong>Total Weight:</strong> <span id="summaryTotalWeight">-</span>g</div>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-sm btn-outline-primary" onclick="startNewMedicationSetup()">Continue Adding Other Medications</button>
                                    <button class="btn btn-sm btn-success" onclick="completeAllMedicationSetup()">Complete All Medication Setup</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="small-text mt-1" id="wppSettingNoActiveMedInfo">Please select a medication from the list above to operate on.</p>
            </div>
        </div>
        
        <div id="stageMedicationContent" class="section card">
             <div class="card-header bg-light text-dark">Stage: Medication (PC-Operated Medication: <span class="current-active-med-name-stage text-primary">No Medication Selected</span>)</div>
            <div class="card-body">
                <div id="medicationStageActiveMedControls" style="display:none;">
                    <p class="small-text">Arduino currently believes the selected medication is "<span id="medStageArduinoMedName" class="text-info">N/A</span>", with an estimated count: <strong id="medStageArduinoMedCount" class="text-info">0</strong></p>
                    
                    <!-- 顺序服药流程界面 -->
                    <div class="card bg-light mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Sequential Medication Process - Precise Record of Medication Consumption</h6>
                        </div>
                        <div class="card-body">
                            <div id="medicationSessionStatus" class="alert alert-secondary" style="display:none;">
                                药物服用会话状态: <span id="sessionStatusText">未开始</span>
                            </div>
                            
                            <div class="d-flex justify-content-center align-items-center mb-3">
                                <div id="stepCircle1" class="rounded-circle d-flex justify-content-center align-items-center me-2" style="width:50px; height:50px; background-color:#007bff; color:white; font-weight:bold;">1</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="stepCircle2" class="rounded-circle d-flex justify-content-center align-items-center mx-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">2</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="stepCircle3" class="rounded-circle d-flex justify-content-center align-items-center ms-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">3</div>
                            </div>
                            
                            <!-- 步骤1: 开始服药会话 -->
                            <div id="medicationStep1" class="step-content">
                                <h6 class="step-label">Step 1: Select a medication and start the medication session</h6>
                                <p class="small-text mb-2">Select the medication you want to take; the system will record the initial weight</p>
                                <div class="row g-2 mb-3">
                                    <div class="col">
                                        <select id="medicationToTakeSelect" class="form-select form-select-sm">
                                            <option value="" disabled selected>Select medication...</option>
                                            <!-- 药物选项会通过JS动态填充 -->
                                        </select>
                                    </div>
                                    <div class="col-auto">
                                        <button id="startMedicationSessionBtn" class="btn btn-primary btn-sm" onclick="startMedicationSession()">Start Medication Session</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 步骤2: 解锁药格取药 -->
                            <div id="medicationStep2" class="step-content" style="display:none;">
                                <h6 class="step-label">Step 2: Unlock Compartment and Take Medication</h6>
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-2">Current Medication: </span>
                                    <span id="currentSessionMedName" class="badge bg-info me-2">None Selected</span>
                                    <span class="me-2">Initial Weight: </span>
                                    <span id="sessionStartWeight" class="badge bg-secondary">0.00g</span>
                                </div>
                                <p class="small-text mb-2">Click the button below to unlock the compartment, then remove the required medication</p>
                                <div class="d-flex mb-3">
                                    <button id="unlockCompartmentBtn" class="btn btn-warning btn-sm me-2" onclick="unlockMedicationCompartment()">Unlock Compartment</button>
                                    <button id="cancelSessionBtn" class="btn btn-outline-danger btn-sm" onclick="cancelMedicationSession()">Cancel Session</button>
                                </div>
                            </div>
                            
                            <!-- 步骤3: 锁定药格并记录 -->
                            <div id="medicationStep3" class="step-content" style="display:none;">
                                <h6 class="step-label">Step 3: Lock Compartment and Record Medication Consumption</h6>
                                <p class="small-text mb-2">After removing medication, click the button below to lock the compartment and automatically record consumption</p>
                                <!-- 新增：测量减少重量并计算服用数量 -->
                                <div class="mb-3 d-flex align-items-center">
                                    <button id="measureConsumptionBtn" class="btn btn-outline-primary btn-sm me-2" onclick="measureConsumption()">Measure Weight Reduction</button>
                                    <div>
                                        <span>Weight Reduced: <strong id="measuredWeightReduced">-</strong> g</span>
                                        <span class="ms-3">Pills Consumed: <strong id="measuredPillCount">-</strong> pills</span>
                                    </div>
                                </div>
                                <div class="d-flex mb-3">
                                    <button id="lockAndRecordBtn" class="btn btn-success btn-sm" onclick="lockAndRecordConsumption()">Complete Medication and Record</button>
                                </div>

                                <!-- 传统服药方式 -->
                                <div class="mt-4">
                                    <h6 class="section-title">Traditional Medication Method</h6>
                                    <ul class="nav nav-pills mb-3 nav-fill" id="simConsumeModeTab" role="tablist">
                                        <!-- 隐藏按数量服用选项 -->
                                        <li class="nav-item" style="display:none;" role="presentation">
                                            <button class="nav-link" id="consume-manual-count-tab" data-bs-toggle="pill" data-bs-target="#consume-manual-count-pane" type="button" role="tab" aria-controls="consume-manual-count-pane" aria-selected="false">Consume by Count</button>
                                        </li>
                                        <li class="nav-item" role="presentation" id="consumeByWeightTabItem">
                                            <button class="nav-link" id="consume-sim-weight-tab" data-bs-toggle="pill" data-bs-target="#consume-sim-weight-pane" type="button" role="tab" aria-controls="consume-sim-weight-pane" aria-selected="false" onclick="showTab('consume-sim-weight-pane', this)">Consume by Weight (Simulated)</button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content">
                                        <!-- 隐藏手动数量面板 -->
                                        <div class="tab-pane fade" id="consume-manual-count-pane" role="tabpanel" aria-labelledby="consume-manual-count-tab" style="display:none;"></div>
                                        <div class="tab-pane fade" id="consume-sim-weight-pane" role="tabpanel" aria-labelledby="consume-sim-weight-tab">
                                            <div class="input-group mb-3">
                                                <input type="number" step="0.01" id="weightToReduceInput" class="form-control form-control-sm" placeholder="输入减少的重量 (g)" min="0.01">
                                                <button class="btn btn-info btn-sm" onclick="consumePillsBySimulatedWeight()">Confirm Consumption (by Weight)</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 服药结果显示 -->
                            <div id="medicationResult" class="mt-3 p-3 border rounded" style="display:none;">
                                <h6>Medication Records:</h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="mb-1"><strong>Medication:</strong> <span id="resultMedName">-</span></div>
                                        <div class="mb-1"><strong>Pills Consumed:</strong> <span id="resultPillCount">-</span> pills</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-1"><strong>Initial Weight:</strong> <span id="resultStartWeight">-</span>g</div>
                                        <div class="mb-1"><strong>Weight Reduced:</strong> <span id="resultWeightReduced">-</span>g</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="resetMedicationUI()">Start New Medication Session</button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="section-title">Current Session Medication Records</h6>
                    <div id="consumptionLogThisSession" class="log-box" style="max-height: 100px;">
                        <p class="small-text text-center">No medication records yet</p>
                    </div>
                </div>
                 <p class="small-text mt-1" id="medicationStageNoActiveMedInfo">Please select a medication to operate on from the Medication Management section.</p>
            </div>
        </div>
        <div id="stageResetContent" class="section card">
            <div class="card-header bg-light text-dark">Stage: Resetting</div>
            <div class="card-body"><p>System is resetting... Arduino will clear its weight and medication state.</p></div>
        </div>
        
        <div class="card"><div class="card-header">Operation Log (Global)</div><div class="card-body"><div id="logBox" class="log-box"></div></div></div>
    </div>

<script>
    // --- Global Variables ---
    let currentIsSimulationGlobal = true; 
    let pcActiveMedicationNameGlobal = null; 
    let arduinoRawStateGlobal = {}; 
    let pc_managed_medication_details = {}; // 确保初始化这个全局变量
    let consumptionLogEntries = []; 
    // 新增：记录盖子开合状态，用于变动日志
    let lastLidOpenState = null; 
    // 新增：实时测量服药减少重量定时器
    let consumptionUpdateInterval = null;

    // 添加显式的Tab切换函数
    function showTab(tabPaneId, tabButton) {
        console.log(`Showing tab: ${tabPaneId}`);
        
        // 移除所有active类
        const navPills = tabButton.closest('.nav-pills');
        navPills.querySelectorAll('.nav-link').forEach(el => {
            el.classList.remove('active');
            el.setAttribute('aria-selected', 'false');
        });
        
        // 移除所有tab-pane的active类
        const tabContent = document.getElementById(tabButton.getAttribute('aria-controls')).closest('.tab-content');
        tabContent.querySelectorAll('.tab-pane').forEach(el => {
            el.classList.remove('show', 'active');
        });
        
        // 添加active类到当前按钮和面板
        tabButton.classList.add('active');
        tabButton.setAttribute('aria-selected', 'true');
        
        const tabPane = document.getElementById(tabPaneId);
        if(tabPane) {
            tabPane.classList.add('show', 'active');
            addLog(`切换到标签页: ${tabButton.textContent}`, "info");
        }
    }

    // --- Utility Functions ---
    function addLog(message, type = 'info') {
        console.log(`LOG [${type.toUpperCase()}]: ${message}`); 
        const logBox = document.getElementById('logBox');
        const time = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `<strong>[${time}] ${type.toUpperCase()}:</strong> ${message}`;
        if (type === 'error') logEntry.style.color = 'red';
        if (type === 'success') logEntry.style.color = 'green';
        if (type === 'warn') logEntry.style.color = '#fd7e14';
        if(logBox) logBox.insertBefore(logEntry, logBox.firstChild);
    }
     function addConsumptionLogEntry(medName, count, weightReducedApprox = null) {
        console.log(`CONSUMPTION: ${medName}, Count: ${count}, WeightReduced: ${weightReducedApprox}`);
        const consumptionLogDiv = document.getElementById('consumptionLogThisSession');
        if (consumptionLogEntries.length === 0 && consumptionLogDiv) { 
            consumptionLogDiv.innerHTML = ''; 
        }
        // 使用完整日期时间并美化日志样式
        const dateTime = new Date().toLocaleString();
        const entry = document.createElement('div');
        entry.className = 'alert alert-info py-2';
        // 构造日志内容
        let html = `<strong>${dateTime}:</strong> 食用 <strong>${medName}</strong> ${count} 片`;
        if (weightReducedApprox !== null) {
            html += `，约减少 ${parseFloat(weightReducedApprox).toFixed(2)}g`;
        }
        entry.innerHTML = html;
        if(consumptionLogDiv) consumptionLogDiv.insertBefore(entry, consumptionLogDiv.firstChild);
        consumptionLogEntries.push(html); 
    }

    function fetchStatus() {
        // 如果存在上一个获取状态的Promise且仍在进行中，则返回它
        if (window.fetchStatusPromise && window.fetchStatusPromiseTimestamp && 
            (new Date().getTime() - window.fetchStatusPromiseTimestamp) < 500) {
            console.log("使用现有状态请求，避免重复请求");
            return window.fetchStatusPromise;
        }

        // 记录请求时间戳
        window.fetchStatusPromiseTimestamp = new Date().getTime();
        
        // 创建新的获取状态请求
        window.fetchStatusPromise = fetch('/get_status')
            .then(response => response.json())
            .then(data => {
                // 清除错误计数器，因为请求成功
                window.fetchStatusErrorCount = 0;
                
                updateUI(data);
                return data; // 返回数据以便链式处理
            })
            .catch(error => {
                console.error('Error fetching status:', error);
                
                // 递增错误计数
                window.fetchStatusErrorCount = (window.fetchStatusErrorCount || 0) + 1;
                
                // 如果连续错误超过5次，显示更明显的错误
                if (window.fetchStatusErrorCount > 5) {
                const connStatusEl = document.getElementById('connectionStatus');
                if(connStatusEl) {
                        connStatusEl.textContent = 'Disconnected';
                    connStatusEl.className = 'status-disconnected';
                }
                    
                    // 只在第5次和第10次错误时记录，避免日志过多
                    if (window.fetchStatusErrorCount % 5 === 0 && window.fetchStatusErrorCount <= 10) {
                        addLog(`获取状态失败 (${window.fetchStatusErrorCount}次): ${error}`, 'error');
                    }
                } else {
                    addLog('获取状态失败: ' + error, 'error');
                }
                
                throw error; // 将错误向上传递，保持Promise链
            })
            .finally(() => {
                // 请求完成后清除引用
                setTimeout(() => {
                    window.fetchStatusPromise = null;
                    window.fetchStatusPromiseTimestamp = null;
                }, 600);
            });
        
        return window.fetchStatusPromise;
    }

    function sendCommand(endpoint, body = {}, method = 'POST', successMessagePrefix = '操作') {
        console.log(`Sending command to ${endpoint} with body:`, body);
        addLog(`Sending request to ${endpoint}...`, "info");
        return fetch(endpoint, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: method !== 'GET' ? JSON.stringify(body) : null
        })
        .then(response => {
            if (!response.ok) { 
                return response.json().then(errData => {
                    const errorMessage = errData.message || response.statusText;
                    addLog(`请求失败 (${response.status}): ${errorMessage}`, 'error');
                    throw new Error(errorMessage);
                }).catch(() => { 
                    const errorMessage = `HTTP error ${response.status}: ${response.statusText}`;
                    addLog(errorMessage, 'error');
                    throw new Error(errorMessage);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log(`Response from ${endpoint}:`, data);
            if (data.status === 'success') {
                addLog((successMessagePrefix ? successMessagePrefix + ": " : "") + (data.message || '成功'), 'success');
                if (endpoint.includes('consume_pills')) {
                    if (data.consumed_med && data.consumed_count !== undefined) {
                         addConsumptionLogEntry(data.consumed_med, data.consumed_count, data.weight_reduced_approx);
                    }
                }
                // 主动刷新状态获取最新数据
                return fetchStatus()
                    .then(() => data)
                    .catch(error => {
                        console.error("Error calling fetchStatus:", error);
                        addLog("获取最新状态失败，但操作可能已成功", "warn");
                return data;
                    });
            } else {
                const errorMessage = (successMessagePrefix ? successMessagePrefix + "失败: " : "失败: ") + (data.message || '未知错误');
                addLog(errorMessage, 'error');
                throw new Error(errorMessage);
            }
        })
        .catch(error => {
            console.error(`Error sending command to ${endpoint}:`, error);
            addLog(`命令发送错误 (${endpoint}): ${error.message || String(error)}`, 'error');
            return Promise.reject(error);
        });
    }

    // --- Global Control ---
    function setMode(modeName) { 
        console.log("setMode called with:", modeName); 
        addLog(`Switching to ${modeName === 'simulation' ? 'Simulation' : 'Real'} Mode...`, "info");
        
        // 立即更新UI样式，提供即时反馈
        const modeIndicator = document.getElementById('modeIndicator');
        if (modeIndicator) {
            modeIndicator.textContent = modeName === 'simulation' ? 'Simulation Mode' : 'Real Mode';
            modeIndicator.className = `mode-indicator mode-${modeName}`;
        }
        
        sendCommand(`/set_mode/${modeName}`, {}, 'POST', `切换模式到 ${modeName}`);
    }
    function setStage(stageId) { 
        console.log("setStage called with:", stageId);
        
        if(stageId === 2) { // 重置系统
            if(!confirm("警告：这将重置整个系统，清除所有药物数据！确定继续吗？")) {
                return;
            }
            addLog("正在重置系统...", "warn");
        }
        
        sendCommand(`/set_stage/${stageId}`, {}, 'POST', `Switching to Stage ID ${stageId}`)
            .then(data => {
                if(data.status === 'success') {
                    if(stageId === 1) { 
                        consumptionLogEntries = []; 
                        const consumptionLogDiv = document.getElementById('consumptionLogThisSession');
                        if (consumptionLogDiv) consumptionLogDiv.innerHTML = '<p class="small-text text-center">暂无服药记录</p>';
                    } else if(stageId === 2) { // 重置系统
                        // 清空界面所有状态
                        resetMedicationUI();
                        
                        // 清空药物选择框
                        const medicationToTakeSelect = document.getElementById('medicationToTakeSelect');
                        if(medicationToTakeSelect) {
                            while(medicationToTakeSelect.options.length > 1) {
                                medicationToTakeSelect.remove(1);
                            }
                        }
                        
                        // 清空药物表格
                        const pcManagedTableBody = document.getElementById('pcManagedMedicationsTable');
                        if(pcManagedTableBody) {
                            pcManagedTableBody.innerHTML = '<tr><td colspan="4" class="text-center small-text">No medications defined on PC</td></tr>';
                        }
                        
                        const knownMedsClickableTable = document.getElementById('knownMedicationsClickableTableBody');
                        if(knownMedsClickableTable) {
                            knownMedsClickableTable.innerHTML = '<tr><td colspan="4" class="text-center small-text">Please add a medication first</td></tr>';
                        }
                        
                        addLog("系统已完全重置，所有数据已清除", "success");
                        
                        // 强制刷新状态
                        setTimeout(fetchStatus, 500);
                    }
                }
            });
    }

    // --- Medication Definition & WPP (Section 1) ---
    function addOrUpdateKnownMedication() {
        console.log("addOrUpdateKnownMedication called");
        const nameEl = document.getElementById('newMedNameInput');
        if (!nameEl) { console.error("Medication input element not found"); return; }

        const name = nameEl.value.trim();
        if (!name) { addLog("药物名称不能为空。", "error"); return; }
        
        sendCommand('/add_or_update_known_medication', { name: name, wpp: 0.0 }, 'POST', '添加/更新PC药物列表')
            .then(() => {
                nameEl.value = '';
                // 添加成功后自动刷新状态
                fetchStatus();
            });
    }

    function tareArduinoForMeasurement() { 
        console.log("tareArduinoForMeasurement called");
        sendCommand('/tare_arduino_sim_only', {}, 'POST', `为测量进行Arduino去皮`);
    }

    // --- 顺序服药流程函数 ---
    function startMedicationSession() {
        const select = document.getElementById('medicationToTakeSelect');
        const medicationName = select.value;
        if (!medicationName) {
            addLog("请先选择要服用的药物", "error");
            return;
        }

        addLog(`开始 '${medicationName}' 的服药会话...`, "info");
        sendCommand('/start_medication_session', { medication_name: medicationName }, 'POST', `开始服药会话`)
            .then(data => {
                if (data.status === 'success') {
                    // 更新UI到步骤2
                    moveToMedicationStep(2);
                    
                    // 更新会话状态显示
                    updateSessionStatus(true, `正在进行 '${medicationName}' 的服药会话`);
                    
                    // 显示当前药物和初始重量
                    const medNameEl = document.getElementById('currentSessionMedName');
                    const startWeightEl = document.getElementById('sessionStartWeight');
                    if (medNameEl) medNameEl.textContent = medicationName;
                    if (startWeightEl) startWeightEl.textContent = `${data.session_data.start_weight.toFixed(2)}g`;
                }
            });
    }

    function unlockMedicationCompartment() {
        addLog("正在解锁药格...", "info");
        sendCommand('/unlock_medication_compartment', {}, 'POST', `解锁药格`)
            .then(data => {
                if (data.status === 'success') {
                    // 更新UI到步骤3
                    moveToMedicationStep(3);
                    
                    // 更新会话状态
                    updateSessionStatus(true, `药格已解锁，请取出 '${data.session_data.current_medication}' 药物`);
                }
            });
    }

    /**
     * 测量当前减少重量并估算服用数量（直接使用去皮后的原始重量绝对值）
     */
    function measureConsumption() {
        // 获取 Arduino 缓存的当前重量，避免串口冲突导致超时
        fetch('/get_current_weight')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success' && data.weight !== undefined) {
                    const currentWeight = parseFloat(data.weight) || 0;
                    // 直接用绝对值作为消耗重量
                    const weightReduced = Math.abs(currentWeight);
                    const weightReducedEl = document.getElementById('measuredWeightReduced');
                    const pillCountEl = document.getElementById('measuredPillCount');
                    if (weightReducedEl) weightReducedEl.textContent = weightReduced.toFixed(2);
                    const details = pc_managed_medication_details[pcActiveMedicationNameGlobal] || {};
                    const wpp = parseFloat(details.wpp) || 0;
                    const pillCount = wpp > 0 ? Math.round(weightReduced / wpp) : 0;
                    if (pillCountEl) pillCountEl.textContent = pillCount;
                    addLog(`测量减少重量: ${weightReduced.toFixed(2)}g, 估算服用: ${pillCount} 片`, 'info');
                } else {
                    addLog('测量减少重量失败: 无效数据', 'error');
                }
            })
            .catch(error => {
                console.error('测量减少重量失败:', error);
                addLog('测量减少重量时出错', 'error');
            });
    }

    function lockAndRecordConsumption() {
        // 在模拟模式下，直接使用模拟消费功能
        if (currentIsSimulationGlobal) {
            addLog("模拟模式下，使用按重量减少功能进行服药", "info");
            consumePillsBySimulatedWeight();
            return;
        }
        // 实时模式下，获取当前重量并锁定记录
        addLog("获取当前重量以获取最新数据...", "info");
        fetch('/get_current_weight')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog('重量获取成功', 'success');
                } else {
                    addLog(`重量获取失败: ${data.message || '未知错误'}`, 'error');
                }
            })
            .catch(err => {
                console.error('重量获取错误:', err);
                addLog('获取重量请求出错', 'error');
            })
            .finally(() => {
                addLog("正在锁定药格并记录服药量...", "info");
                sendCommand('/lock_and_record_consumption', {}, 'POST', `完成服药并记录`)
                    .then(data => {
                        if (data.status === 'success') {
                            updateSessionStatus(false, `服药会话已完成`);
                            showMedicationResult(data.completed_session);
                        }
                    });
            });
    }

    function cancelMedicationSession() {
        if (!confirm("确定要取消当前服药会话吗？")) {
            return;
        }
        
        addLog("正在取消服药会话...", "info");
        sendCommand('/cancel_medication_session', {}, 'POST', `取消服药会话`)
            .then(data => {
                if (data.status === 'success') {
                    // 重置UI
                    resetMedicationUI();
                    addLog("服药会话已取消", "warn");
                }
            });
    }

    function updateSessionStatus(isActive, statusText) {
        const statusEl = document.getElementById('medicationSessionStatus');
        const statusTextEl = document.getElementById('sessionStatusText');
        
        if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.className = isActive ? 'alert alert-info' : 'alert alert-secondary';
        }
        
        if (statusTextEl) {
            statusTextEl.textContent = statusText || (isActive ? '进行中' : '未开始');
        }
    }

    function moveToMedicationStep(stepNumber) {
        // 隐藏所有步骤
        document.querySelectorAll('.step-content').forEach(el => {
            el.style.display = 'none';
        });
        
        // 重置所有步骤圆圈样式
        for (let i = 1; i <= 3; i++) {
            const stepCircle = document.getElementById(`stepCircle${i}`);
            if (stepCircle) {
                stepCircle.style.backgroundColor = i <= stepNumber ? '#007bff' : '#6c757d';
            }
        }
        
        // 显示当前步骤
        const currentStep = document.getElementById(`medicationStep${stepNumber}`);
        if (currentStep) {
            currentStep.style.display = 'block';
        }
        
        // 隐藏结果区域
        const resultEl = document.getElementById('medicationResult');
        if (resultEl) {
            resultEl.style.display = 'none';
        }
        
        // 新增：进入步骤3时开启实时测量减少重量，并在离开时停止
        if (stepNumber === 3) {
            if (!consumptionUpdateInterval) {
                consumptionUpdateInterval = setInterval(measureConsumption, 200);
            }
        } else {
            if (consumptionUpdateInterval) {
                clearInterval(consumptionUpdateInterval);
                consumptionUpdateInterval = null;
            }
        }
    }

    function showMedicationResult(sessionData) {
        // 清除实时测量减少重量定时器，避免在结果页继续测量
        if (consumptionUpdateInterval) {
            clearInterval(consumptionUpdateInterval);
            consumptionUpdateInterval = null;
        }
        // 隐藏所有步骤
        document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
        
        // 更新结果信息
        document.getElementById('resultMedName').textContent = sessionData.current_medication || '-';
        document.getElementById('resultPillCount').textContent = sessionData.pills_consumed || '0';
        document.getElementById('resultStartWeight').textContent = sessionData.start_weight.toFixed(2);
        document.getElementById('resultWeightReduced').textContent = sessionData.weight_consumed.toFixed(2);
        
        // 显示结果区域
        const resultEl = document.getElementById('medicationResult');
        if (resultEl) {
            resultEl.style.display = 'block';
        }
        // 将本次服药记录添加到日志
        addConsumptionLogEntry(sessionData.current_medication, sessionData.pills_consumed, sessionData.weight_consumed);
    }

    function resetMedicationUI() {
        // 重置为步骤1
        moveToMedicationStep(1);
        
        // 重置会话状态
        updateSessionStatus(false, '未开始');
        
        // 清空选择框
        const select = document.getElementById('medicationToTakeSelect');
        if (select) {
            select.selectedIndex = 0;
        }
    }

    // --- WPP测量步骤式UI函数 ---
    function moveToWppStep(stepNumber, mode) {
        console.log(`移动到WPP步骤${stepNumber}，模式=${mode}`);
        
        // 在进入步骤5之前，检查WPP是否已正确设置
        if (stepNumber === 5) {
            const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
            if (!details || !details.wpp || details.wpp <= 0.0001) {
                addLog("警告：WPP未正确设置，将使用实时重量进行临时计算", "warn");
                // 在真实模式下，我们只发出警告，但不使用模拟接口
                if (!currentIsSimulationGlobal) {
                    addLog("真实模式下，请确保已通过Arduino正确测量并设置了WPP", "warn");
                }
                // 允许继续，但在模拟模式下使用实时重量作为临时WPP
                else if (arduinoRawStateGlobal.total_weight_in_box_arduino !== undefined) {
                    const tempWPP = parseFloat(arduinoRawStateGlobal.total_weight_in_box_arduino);
                    if (tempWPP > 0) {
                        sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: tempWPP }, 'POST', `设置临时WPP为${tempWPP.toFixed(2)}g`)
                            .then(data => {
                                if (data.status === 'success') {
                                    addLog(`已设置临时WPP为${tempWPP.toFixed(2)}g`, "info");
                                }
                            });
                    }
                }
            }
        }
        
        // 隐藏所有WPP步骤内容
        document.querySelectorAll('.wpp-step-content').forEach(el => {
            el.style.display = 'none';
        });
        
        // 重置所有步骤圆圈样式
        for (let i = 1; i <= 6; i++) {
            const stepCircle = document.getElementById(`wppStepCircle${i}`);
            if (stepCircle) {
                stepCircle.style.backgroundColor = i <= stepNumber ? '#007bff' : '#6c757d';
            }
        }
        
        // 确保wppSettingSectionForActiveMed显示
        const wppSettingSection = document.getElementById('wppSettingSectionForActiveMed');
        if (wppSettingSection) {
            wppSettingSection.style.display = 'block';
        }
        
        // 根据步骤号显示对应内容
        if (stepNumber === 4) {
            const step4El = document.getElementById('wppStep4');
            if (step4El) {
                step4El.style.display = 'block';
                // 强制刷新数据
                fetchStatus();
                // 更新确认信息
                setTimeout(function() {
                    document.getElementById('wppConfirmMedName').textContent = pcActiveMedicationNameGlobal || '-';
                    const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
                    if (details && details.wpp) {
                        document.getElementById('wppConfirmValue').textContent = details.wpp.toFixed(3);
                    } else {
                        document.getElementById('wppConfirmValue').textContent = '-';
                    }
                    
                    // 在真实模式下，显示实时重量
                    if (!currentIsSimulationGlobal) {
                        const realTimeWeightContainer = document.getElementById('realTimeWeightContainer');
                        if (realTimeWeightContainer) {
                            realTimeWeightContainer.style.display = 'block';
                            // 开始实时重量监测
                            startRealTimeWeightMeasurement();
                        }
                    }
                }, 300);
            }
        } else if (stepNumber === 5) {
            const step5El = document.getElementById('wppStep5');
            if (step5El) {
                step5El.style.display = 'block';
                
                // 根据模式显示或隐藏控件
                const simControls = document.getElementById('weighingSimModeOnlyControls');
                const realModeInfo = document.getElementById('weighingRealModeInfoForInventory');
                
                if (simControls && realModeInfo) {
                    if (currentIsSimulationGlobal) {
                        simControls.style.display = 'block';
                        realModeInfo.style.display = 'none';
                    } else {
                        simControls.style.display = 'none';
                        realModeInfo.style.display = 'block';
                        
                        // 在真实模式下，自动开始测量总重
                        startRealTimeWeightMeasurement();
                    }
                }
            }
        } else if (stepNumber === 1) {
            const step1El = document.getElementById('wppStep1');
            if (step1El) step1El.style.display = 'block';
        } else if (stepNumber === 2) {
            const step2El = document.getElementById('wppStep2');
            if (step2El) {
                step2El.style.display = 'block';
                console.log("显示步骤2:", step2El);
            } else {
                console.error("步骤2元素不存在!");
                addLog("UI错误: 步骤2元素不存在", "error");
            }
        } else if (stepNumber === 3 && mode) {
            const step3El = document.getElementById(`wppStep3-${mode}`);
            if (step3El) {
                step3El.style.display = 'block';
                // 为"真实/模拟环境"测量模式设置正确的UI
                if (mode === 'real') {
                    // 显示或隐藏模拟输入容器
                    const simulatedInputContainer = document.getElementById('simulatedWPPInputContainer');
                    if (simulatedInputContainer) {
                        simulatedInputContainer.style.display = currentIsSimulationGlobal ? 'block' : 'none';
                    }
                    
                    // 在真实模式下显示实时重量区域
                    const realTimeWeightContainerInStep3 = document.getElementById('realTimeWeightContainerInStep3');
                    if (realTimeWeightContainerInStep3 && !currentIsSimulationGlobal) {
                        realTimeWeightContainerInStep3.style.display = 'block';
                        
                        // 开始实时重量监测，并更新步骤3的实时重量显示
                        if (!window.step3WeightUpdateInterval) {
                            // 添加错误计数和最后成功时间
                            window.weightUpdateErrorCount = 0;
                            window.lastSuccessfulWeightUpdate = Date.now();
                            
                            window.step3WeightUpdateInterval = setInterval(() => {
                                fetch('/get_current_weight')
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log("获取到实时重量数据:", data);
                                        
                                        // 检查返回的状态
                                        if (data.status === 'error') {
                                            console.error("获取重量出错:", data.message);
                                            window.weightUpdateErrorCount++;
                                            
                                            // 显示错误状态
                                            const weightValueEl = document.getElementById('realTimeWeightValueInStep3');
                                            if (weightValueEl) {
                                                weightValueEl.textContent = "读取错误";
                                                weightValueEl.classList.add('text-danger');
                                            }
                                            return;
                                        }
                                        
                                        // 检查数据是否过期
                                        if (data.age && data.age > 10) {
                                            console.warn(`重量数据可能已过期 (${data.age.toFixed(1)}秒)`);
                                            const weightValueEl = document.getElementById('realTimeWeightValueInStep3');
                                            if (weightValueEl) {
                                                weightValueEl.textContent = parseFloat(data.weight).toFixed(2) + " (旧数据)";
                                                weightValueEl.classList.add('text-warning');
                                            }
                                            return;
                                        }
                                        
                                        if (data.weight !== undefined) {
                                            // 重置错误计数
                                            window.weightUpdateErrorCount = 0;
                                            window.lastSuccessfulWeightUpdate = Date.now();
                                            
                                            const weight = parseFloat(data.weight);
                                            const weightValueEl = document.getElementById('realTimeWeightValueInStep3');
                                            if (weightValueEl) {
                                                weightValueEl.textContent = weight.toFixed(2);
                                                console.log("更新实时重量显示:", weight.toFixed(2));
                                                
                                                // 添加重量变化视觉反馈
                                                if (weight > 0.01) {
                                                    weightValueEl.classList.add('text-success');
                                                    weightValueEl.classList.remove('text-danger', 'text-warning');
                    } else {
                                                    weightValueEl.classList.add('text-danger');
                                                    weightValueEl.classList.remove('text-success', 'text-warning');
                                                }
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        console.error("获取重量失败:", error);
                                        window.weightUpdateErrorCount++;
                                        
                                        // 检查是否需要显示连接问题警告
                                        if (window.weightUpdateErrorCount >= 3) {
                                            const weightValueEl = document.getElementById('realTimeWeightValueInStep3');
                                            if (weightValueEl) {
                                                weightValueEl.textContent = "连接问题";
                                                weightValueEl.classList.add('text-danger');
                                                weightValueEl.classList.remove('text-success', 'text-warning');
                                            }
                                            
                                            // 如果连续失败太多次，减慢请求频率
                                            if (window.weightUpdateErrorCount > 10) {
                                                clearInterval(window.step3WeightUpdateInterval);
                                                window.step3WeightUpdateInterval = setInterval(() => {
                                                    // 完整的重量获取代码
                                                    fetch('/get_current_weight')
                                                        .then(response => response.json())
                                                        .then(data => {
                                                            // 重置错误计数器
                                                            if (data.status === 'success' && data.weight !== undefined) {
                                                                window.weightUpdateErrorCount = 0;
                                                                const weightValueEl = document.getElementById('realTimeWeightValueInStep3');
                                                                if (weightValueEl) {
                                                                    const weight = parseFloat(data.weight);
                                                                    weightValueEl.textContent = weight.toFixed(2);
                                                                    weightValueEl.classList.remove('text-danger');
                                                                    weightValueEl.classList.add('text-success');
                                                                    console.log("恢复正常连接，重量更新正常");
                                                                }
                                                            }
                                                        })
                                                        .catch(error => {
                                                            console.error("重连后仍然获取重量失败:", error);
                                                        });
                                                }, 2000); // 增加到2秒一次
                                                console.log("由于连续错误，减慢重量更新频率");
                                            }
                                        }
                                    });
                            }, 500); // 更新频率改为500ms，更快地反馈重量变化
                        }
                    }
                }
            }
        } else if (stepNumber === 6) {
            const step6El = document.getElementById('wppStep6');
            if (step6El) {
                step6El.style.display = 'block';
                // 强制刷新数据
                fetchStatus();
                setTimeout(function() {
                    const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
                    if (details) {
                        document.getElementById('summaryMedName').textContent = pcActiveMedicationNameGlobal;
                        document.getElementById('summaryWPP').textContent = details.wpp ? details.wpp.toFixed(3) : '-';
                        document.getElementById('summaryCount').textContent = details.count_in_box !== undefined ? details.count_in_box : '-';
                        document.getElementById('summaryTotalWeight').textContent = details.total_weight_in_box ? details.total_weight_in_box.toFixed(2) : '-';
                    } else {
                        document.getElementById('summaryMedName').textContent = '-';
                        document.getElementById('summaryWPP').textContent = '-';
                        document.getElementById('summaryCount').textContent = '-';
                        document.getElementById('summaryTotalWeight').textContent = '-';
                    }
                }, 300);
            }
        }
        
        // 如果离开步骤3，清除步骤3的实时重量更新定时器
        if (stepNumber !== 3 && window.step3WeightUpdateInterval) {
            clearInterval(window.step3WeightUpdateInterval);
            window.step3WeightUpdateInterval = null;
        }
        
        addLog(`WPP Measurement: Enter Step ${stepNumber}${mode ? ` (${mode === 'simulated' ? 'Simulated' : 'Real'} Mode)` : ''}`, "info");
    }

    // 添加实时重量测量函数
    function startRealTimeWeightMeasurement() {
        if (!currentIsSimulationGlobal) {
            addLog("开始实时测量总重...", "info");
            // 显示实时重量显示区域
            const realTimeWeightContainer = document.getElementById('realTimeWeightContainer');
            if (realTimeWeightContainer) {
                realTimeWeightContainer.style.display = 'block';
            }
            
            // 清除之前可能存在的定时器
            if (window.currentWeightUpdateInterval) {
                clearInterval(window.currentWeightUpdateInterval);
            }
            
            // 创建错误计数器
            window.weightUpdateErrorCount = 0;
            
            // 每1000ms更新一次重量显示，减少请求频率
            const weightUpdateInterval = setInterval(() => {
                // 每次新的请求前检查是否有太多错误
                if (window.weightUpdateErrorCount > 10) {
                    addLog("由于连接问题，停止自动重量更新", "warn");
                    clearInterval(weightUpdateInterval);
                    
                    // 添加手动刷新按钮
                    const realTimeWeightContainer = document.getElementById('realTimeWeightContainer');
                    if (realTimeWeightContainer) {
                        const refreshBtn = document.createElement('button');
                        refreshBtn.className = 'btn btn-sm btn-outline-secondary mt-2';
                        refreshBtn.textContent = '手动刷新重量';
                        refreshBtn.onclick = function() {
                            fetchStatus()
            .then(() => {
                                    addLog("手动刷新重量成功", "success");
                                })
                                .catch(() => {
                                    addLog("手动刷新重量失败", "error");
                                });
                        };
                        realTimeWeightContainer.appendChild(refreshBtn);
                    }
                    return;
                }
                
                // 使用缓存接口获取重量，避免串口冲突导致超时
                fetch('/get_current_weight')
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success' && data.weight !== undefined) {
                            const realTimeWeightValue = document.getElementById('realTimeWeightValueInStep3');
                            if (realTimeWeightValue) {
                                realTimeWeightValue.textContent = parseFloat(data.weight).toFixed(2);
                            }
                            window.weightUpdateErrorCount = 0;
                        }
                    })
                    .catch(error => {
                        console.error("获取重量失败:", error);
                        window.weightUpdateErrorCount++;
                    });
            }, 2000); // 调整为2秒一次，减少请求频率
            
            // 存储interval ID以便后续清除
            window.currentWeightUpdateInterval = weightUpdateInterval;
            
            // 在真实模式下，添加一个按钮让用户手动完成步骤
            const step5El = document.getElementById('wppStep5');
            if (step5El) {
                // 检查是否已经添加了完成按钮
                let completeRealModeBtn = document.getElementById('completeRealModeBtn');
                if (!completeRealModeBtn) {
                    completeRealModeBtn = document.createElement('button');
                    completeRealModeBtn.id = 'completeRealModeBtn';
                    completeRealModeBtn.className = 'btn btn-success btn-sm mt-3';
                    completeRealModeBtn.textContent = '确认实时重量并完成设置';
                    completeRealModeBtn.onclick = function() {
                        // 直接移动到步骤6，不调用模拟接口
                        if (window.currentWeightUpdateInterval) {
                            clearInterval(window.currentWeightUpdateInterval);
                        }
                        
                        // 即使无法获取最新状态，也允许继续
                        fetchStatus()
                            .then(() => {
                                setTimeout(() => {
                                    moveToWppStep(6);
                                    updateSummaryInfo();
                }, 500);
            })
                            .catch(() => {
                                // 即使状态获取失败，也继续流程
                                addLog("无法刷新状态，但将继续进行设置", "warn");
                                setTimeout(() => {
                                    moveToWppStep(6);
                                    updateSummaryInfo();
                                }, 500);
                            });
                    };
                    
                    // 找到合适的位置添加按钮
                    const realModeInfoEl = document.getElementById('weighingRealModeInfoForInventory');
                    if (realModeInfoEl) {
                        realModeInfoEl.after(completeRealModeBtn);
                        realModeInfoEl.style.display = 'block';
                    } else {
                        step5El.appendChild(completeRealModeBtn);
                    }
                }
            }
        }
    }

    // 添加使用实时重量更新库存的函数
    function setInventoryByRealTimeWeight(weight) {
        if (!pcActiveMedicationNameGlobal) {
            addLog("请先选择药物", "error");
            return;
        }
        
        // 在真实模式下，不应该调用模拟接口
        if (!currentIsSimulationGlobal) {
            addLog(`在真实模式下，药盒总重和数量由实际传感器读数决定，无需手动更新`, "info");
            
            // 直接获取最新数据并进入完成步骤
            fetchStatus().then(() => {
                setTimeout(() => {
                    moveToWppStep(6);
                    updateSummaryInfo();
                }, 500);
            });
            
            return;
        }
        
        // 在模拟模式下继续使用模拟接口
        addLog(`使用实时重量 ${weight.toFixed(2)}g 更新 '${pcActiveMedicationNameGlobal}' 库存...`, "info");
        
        sendCommand('/set_simulated_total_weight_for_active_med', { weight: weight }, 'POST', `通过实时重量更新 '${pcActiveMedicationNameGlobal}' 库存`)
                .then(data => {
                if (data && data.status === 'success') {
                    addLog(`库存更新成功，进入完成步骤...`, "success");
                            fetchStatus().then(() => {
                        setTimeout(() => {
                            moveToWppStep(6);
                            updateSummaryInfo();
                        }, 500);
                    });
                }
            });
    }

    // --- Weighing Stage: Update Inventory for Active Med (Section 2) ---
    function setInventoryBySimulatedBatchWeight() { 
        console.log("setInventoryBySimulatedBatchWeight called");
        if (!currentIsSimulationGlobal) { addLog("此功能仅模拟模式可用。", "warn"); return; }
        if (!pcActiveMedicationNameGlobal) { addLog("请先选择药物。", "error"); return; }
        const inputEl = document.getElementById('simBatchTotalWeightInput');
        if (!inputEl) { console.error("simBatchTotalWeightInput not found"); return; }
        const weightStr = inputEl.value;
        if (weightStr === "" || isNaN(parseFloat(weightStr)) || parseFloat(weightStr) < 0) { 
            addLog("请输入有效的模拟总重量 (非负数)。", "error"); return; 
        }
        
        const weight = parseFloat(weightStr);
        addLog(`通过总重 ${weight}g 更新 '${pcActiveMedicationNameGlobal}' 库存...`, "info");
        
        sendCommand('/set_simulated_total_weight_for_active_med', { weight: weight }, 'POST', `通过总重更新 '${pcActiveMedicationNameGlobal}' 库存`)
            .then(data => {
                if(data && data.status === 'success') {
                    inputEl.value = '';
                    
                    addLog(`刷新数据并进入完成步骤...`, "info");
                    
                    // 确保获取到最新数据后再进入下一步
                    fetchStatus().then(() => {
                        // 再次获取和输出最新的数据，用于调试
                        console.log("最新药物数据:", pc_managed_medication_details);
                        if(pcActiveMedicationNameGlobal && pc_managed_medication_details[pcActiveMedicationNameGlobal]) {
                            console.log("当前药物详细信息:", pc_managed_medication_details[pcActiveMedicationNameGlobal]);
                        }
                        
                        setTimeout(() => {
                            moveToWppStep(6);
                            updateSummaryInfo();  // 额外调用一次更新摘要信息
                        }, 500);
                    });
                }
            });
    }

    function setInventoryByManualPillCount() {
        console.log("setInventoryByManualPillCount called");
        if (!pcActiveMedicationNameGlobal) { addLog("请先选择药物。", "error"); return; }
        const inputEl = document.getElementById('inventoryManualPillCountInput');
        if (!inputEl) { console.error("inventoryManualPillCountInput not found"); return; }
        const countStr = inputEl.value;
        if (countStr === "" || isNaN(parseInt(countStr)) || parseInt(countStr) < 0) {
            addLog("请输入有效的药片数量 (非负整数)。", "error"); return;
        }
        
        const count = parseInt(countStr);
        addLog(`正在通过手动数量 ${count} 片更新"${pcActiveMedicationNameGlobal}"库存...`, "info");
        
        sendCommand('/update_state_from_manual_count_for_active_med', { count: count }, 'POST', `通过数量更新 '${pcActiveMedicationNameGlobal}' 库存`)
            .then(data => {
                if(data && data.status === 'success') {
                    inputEl.value = '';
                    
                    addLog(`刷新数据并进入完成步骤...`, "info");
                    
                    // 确保获取到最新数据后再进入下一步
                    fetchStatus().then(() => {
                        // 再次获取和输出最新的数据，用于调试
                        console.log("最新药物数据:", pc_managed_medication_details);
                        if(pcActiveMedicationNameGlobal && pc_managed_medication_details[pcActiveMedicationNameGlobal]) {
                            console.log("当前药物详细信息:", pc_managed_medication_details[pcActiveMedicationNameGlobal]);
                        }
                        
                        setTimeout(() => {
                            moveToWppStep(6);
                            updateSummaryInfo();  // 额外调用一次更新摘要信息
                        }, 500);
                    });
                }
            });
    }

    // --- Medication Stage ---
    function consumePillsForActiveMedPC() {
        console.log("consumePillsForActiveMedPC called");
        if (!pcActiveMedicationNameGlobal) { addLog("请先选择要服用的药物。", "error"); return; }
        const inputEl = document.getElementById('pillsToConsumeInput');
        if (!inputEl) { console.error("pillsToConsumeInput not found"); return; }
        const countStr = inputEl.value;
        if (countStr === "" || isNaN(parseInt(countStr)) || parseInt(countStr) <= 0) { addLog("请输入有效的服用数量 (正整数)。", "error"); return; }
        sendCommand('/consume_pills_for_active_med', { count: parseInt(countStr) }, 'POST', `服用 '${pcActiveMedicationNameGlobal}'`)
            .then(()=> { if(inputEl) inputEl.value = ''; });
    }
    function consumePillsBySimulatedWeight() {
        console.log("consumePillsBySimulatedWeight called");
        if (!currentIsSimulationGlobal) { addLog("按重量减少仅为模拟模式功能。", "warn"); return; }
        if (!pcActiveMedicationNameGlobal) { addLog("请先选择要服用的药物。", "error"); return; }
        const inputEl = document.getElementById('weightToReduceInput');
        if (!inputEl) { console.error("weightToReduceInput not found"); return; }
        const weightStr = inputEl.value;
        if (weightStr === "" || isNaN(parseFloat(weightStr)) || parseFloat(weightStr) <= 0) {
            addLog("请输入有效的减少重量 (正数)。", "error"); return;
        }
        const weightValue = parseFloat(weightStr);
        sendCommand('/consume_pills_by_weight_simulated', { weight_to_reduce: weightValue }, 'POST', `按重量服用 '${pcActiveMedicationNameGlobal}'`)
            .then(data => {
                if (inputEl) inputEl.value = '';
                // 更新界面显示消费结果
                const weightReducedEl = document.getElementById('measuredWeightReduced');
                const pillCountEl = document.getElementById('measuredPillCount');
                if (weightReducedEl) weightReducedEl.textContent = data.weight_reduced_approx.toFixed(2);
                if (pillCountEl) pillCountEl.textContent = data.consumed_count;
                addLog(`传统模拟消费完成: ${data.consumed_count} 片, 减少重量: ${data.weight_reduced_approx.toFixed(2)}g`, 'success');
                // 刷新状态并更新 PC 表格
                fetchStatus();
            });
    }
    
    // --- PC Active Medication Selection ---
    function setPcActiveMedication(medName) {
        console.log("setPcActiveMedication called with:", medName);
        sendCommand('/set_pc_active_medication', { name: medName }, 'POST', `设置PC当前操作药物为 '${medName}'`);
    }

    // --- UI Update Function ---
    function updateUI(data) {
        try { 
            arduinoRawStateGlobal = data.arduino_state || {}; 
            // 重要：更新全局变量
            pc_managed_medication_details = data.pc_managed_medication_details || {};
            
            console.log("UI更新，当前药物:", pcActiveMedicationNameGlobal);
            console.log("药物详情数据:", pc_managed_medication_details);
            
            const connStatusEl = document.getElementById('connectionStatus');
            const arduinoStage = arduinoRawStateGlobal.stage_name || 'Unknown';
            if (connStatusEl) {
                connStatusEl.textContent = (arduinoStage === 'Disconnected' || arduinoStage === 'Initializing' || arduinoStage === 'Unknown') ? arduinoStage : 'Connected';
                connStatusEl.className = (arduinoStage === 'Disconnected' || arduinoStage === 'Initializing' || arduinoStage === 'Unknown') ? 'status-disconnected' : 'status-connected';
            }
            
            currentIsSimulationGlobal = data.is_simulation;
            const modeIndicator = document.getElementById('modeIndicator');
            if (modeIndicator) {
                modeIndicator.textContent = currentIsSimulationGlobal ? 'Simulation Mode' : 'Real Mode';
                modeIndicator.className = `mode-indicator mode-${currentIsSimulationGlobal ? 'simulation' : 'real'}`;
            }
            // 更新盖子状态指示
            const lidIndicator = document.getElementById('lidIndicator');
            if (lidIndicator) {
                const open = arduinoRawStateGlobal.lid_open;
                lidIndicator.textContent = open ? 'Open' : 'Closed';
                lidIndicator.className = `lid-indicator lid-${open ? 'open' : 'closed'}`;
            }
            // 新增：检测盖子开合状态变化并记录日志
            if (typeof lastLidOpenState === 'boolean') {
                if (arduinoRawStateGlobal.lid_open !== lastLidOpenState) {
                    addLog(arduinoRawStateGlobal.lid_open ? 'Pillbox lid opened' : 'Pillbox lid closed', arduinoRawStateGlobal.lid_open ? 'success' : 'warn');
                }
            }
            lastLidOpenState = arduinoRawStateGlobal.lid_open;

            const arduinoStageNameEl = document.getElementById('arduinoStageName');
            if (arduinoStageNameEl) arduinoStageNameEl.textContent = arduinoStage;
            
            const arduinoTotalWeightEl = document.getElementById('arduinoTotalWeight');
            if (arduinoTotalWeightEl) arduinoTotalWeightEl.textContent = arduinoRawStateGlobal.total_weight_in_box_arduino !== undefined ? parseFloat(arduinoRawStateGlobal.total_weight_in_box_arduino).toFixed(2) : 'N/A';
            
            const arduinoCurrentMedEl = document.getElementById('arduinoCurrentMed');
            if (arduinoCurrentMedEl) arduinoCurrentMedEl.textContent = arduinoRawStateGlobal.current_med_on_arduino || 'N/A';

            const arduinoCurrentMedWPPEl = document.getElementById('arduinoCurrentMedWPP');
            if (arduinoCurrentMedWPPEl) arduinoCurrentMedWPPEl.textContent = arduinoRawStateGlobal.wpp_arduino_current_med !== undefined ? parseFloat(arduinoRawStateGlobal.wpp_arduino_current_med).toFixed(3) : 'N/A';
            
            const arduinoCurrentMedCountEl = document.getElementById('arduinoCurrentMedCount');
            if (arduinoCurrentMedCountEl) arduinoCurrentMedCountEl.textContent = arduinoRawStateGlobal.pill_count_arduino_current_med !== undefined ? parseInt(arduinoRawStateGlobal.pill_count_arduino_current_med) : 'N/A';
            
            const rawDataEl = document.getElementById('rawData');
            if (rawDataEl) rawDataEl.textContent = arduinoRawStateGlobal.raw_data || 'N/A';
            
            pcActiveMedicationNameGlobal = data.pc_active_medication_name;
            const pcActiveMedDisplayEl = document.getElementById('pcActiveMedicationDisplay');
            if (pcActiveMedDisplayEl) pcActiveMedDisplayEl.textContent = pcActiveMedicationNameGlobal || 'None';
            
            document.querySelectorAll('.current-active-med-name-stage').forEach(el => el.textContent = pcActiveMedicationNameGlobal || 'No Medication Selected');
            document.querySelectorAll('.current-active-med-name-wpp').forEach(el => el.textContent = pcActiveMedicationNameGlobal || 'No Medication Selected');
            
            const pcManagedMeds = data.pc_managed_medication_details || {};
            const pcManagedTableBody = document.getElementById('pcManagedMedicationsTable');
            if (pcManagedTableBody) {
                pcManagedTableBody.innerHTML = '';
                if (Object.keys(pcManagedMeds).length === 0) {
                    pcManagedTableBody.innerHTML = '<tr><td colspan="4" class="text-center small-text">No medications defined on PC</td></tr>';
                } else {
                    for (const medName in pcManagedMeds) {
                        const details = pcManagedMeds[medName];
                        const tr = document.createElement('tr');
                        if (medName === pcActiveMedicationNameGlobal) tr.classList.add('table-active-pc-med');
                        tr.innerHTML = `
                            <td>${medName}</td>
                            <td>${parseFloat(details.wpp).toFixed(3)}</td>
                            <td>${parseFloat(details.total_weight_in_box).toFixed(2)}</td>
                            <td>${parseInt(details.count_in_box)}</td>
                        `;
                        pcManagedTableBody.appendChild(tr);
                    }
                }
            }
            
            const knownMedsClickableTable = document.getElementById('knownMedicationsClickableTableBody');
            if (knownMedsClickableTable) {
                knownMedsClickableTable.innerHTML = '';
                 if (Object.keys(pcManagedMeds).length === 0) {
                    knownMedsClickableTable.innerHTML = '<tr><td colspan="4" class="text-center small-text">Please add a medication first</td></tr>';
                } else {
                    for (const medName in pcManagedMeds) {
                        const details = pcManagedMeds[medName];
                        const tr = document.createElement('tr');
                        if (medName === pcActiveMedicationNameGlobal) tr.classList.add('table-active');
                        tr.innerHTML = `
                            <td style="cursor:pointer;" onclick="setPcActiveMedication('${medName}')">${medName} ${medName === pcActiveMedicationNameGlobal ? '<span class="badge bg-primary ms-1">Active</span>' : ''}</td>
                            <td>${parseFloat(details.wpp).toFixed(3)}</td>
                            <td>${parseFloat(details.total_weight_in_box).toFixed(2)}</td>
                            <td>${parseInt(details.count_in_box)}</td>
                        `;
                        knownMedsClickableTable.appendChild(tr);
                    }
                }
            }

            // 隐藏所有阶段内容
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            
            // 根据当前阶段显示对应内容
            const medManagementCard = document.getElementById('medicationManagementCard');
            if (medManagementCard) {
                // 只在称重或未知阶段显示药物管理卡片
                medManagementCard.style.display = (arduinoStage === 'Weighing' || arduinoStage === 'Unknown' || arduinoStage === 'Initializing') ? 'block' : 'none';
            }
            
            // 根据当前阶段显示对应内容
            if (arduinoStage === 'Weighing') {
                const stageWeighingContentEl = document.getElementById('stageWeighingContent');
                if(stageWeighingContentEl) stageWeighingContentEl.style.display = 'block';
                
                // 隐藏重置阶段内容
                const stageResetContentEl = document.getElementById('stageResetContent');
                if(stageResetContentEl) stageResetContentEl.style.display = 'none';
                
                // 隐藏服药阶段内容
                const stageMedicationContentEl = document.getElementById('stageMedicationContent');
                if(stageMedicationContentEl) stageMedicationContentEl.style.display = 'none';
                
            } else if (arduinoStage === 'Medication') {
                const stageMedicationContentEl = document.getElementById('stageMedicationContent');
                if(stageMedicationContentEl) stageMedicationContentEl.style.display = 'block';
                
                // 隐藏称重阶段内容
                const stageWeighingContentEl = document.getElementById('stageWeighingContent');
                if(stageWeighingContentEl) stageWeighingContentEl.style.display = 'none';
                
                // 隐藏重置阶段内容
                const stageResetContentEl = document.getElementById('stageResetContent');
                if(stageResetContentEl) stageResetContentEl.style.display = 'none';
                
                const medStageArduinoMedNameEl = document.getElementById('medStageArduinoMedName');
                if(medStageArduinoMedNameEl) medStageArduinoMedNameEl.textContent = arduinoRawStateGlobal.current_med_on_arduino || 'N/A';
                
                const medStageArduinoMedCountEl = document.getElementById('medStageArduinoMedCount');
                if(medStageArduinoMedCountEl) medStageArduinoMedCountEl.textContent = arduinoRawStateGlobal.pill_count_arduino_current_med !== undefined ? parseInt(arduinoRawStateGlobal.pill_count_arduino_current_med) : '0';
                
                // 在服药阶段始终显示药物管理流程，隐藏未选药物提示
                const medicationStageActiveMedControlsEl = document.getElementById('medicationStageActiveMedControls');
                if (medicationStageActiveMedControlsEl) medicationStageActiveMedControlsEl.style.display = 'block';
                const medicationStageNoActiveMedInfoEl = document.getElementById('medicationStageNoActiveMedInfo');
                if (medicationStageNoActiveMedInfoEl) medicationStageNoActiveMedInfoEl.style.display = 'none';
                
                const consumeByWeightTabItemEl = document.getElementById('consumeByWeightTabItem');
                if(consumeByWeightTabItemEl) consumeByWeightTabItemEl.style.display = currentIsSimulationGlobal ? 'block' : 'none';
                
                const consumeSimWeightTab = document.getElementById('consume-sim-weight-tab');
                const consumeManualCountTabEl = document.getElementById('consume-manual-count-tab');
                if(!currentIsSimulationGlobal && consumeSimWeightTab && consumeSimWeightTab.classList.contains('active')){
                     if(consumeManualCountTabEl){
                        const consumeManualCountTabInstance = bootstrap.Tab.getInstance(consumeManualCountTabEl) || new bootstrap.Tab(consumeManualCountTabEl);
                        if(consumeManualCountTabInstance) consumeManualCountTabInstance.show();
                     }
                }
            } else if (arduinoStage === 'Resetting') {
                const stageResetContentEl = document.getElementById('stageResetContent');
                if(stageResetContentEl) stageResetContentEl.style.display = 'block';
                
                // 隐藏称重阶段内容
                const stageWeighingContentEl = document.getElementById('stageWeighingContent');
                if(stageWeighingContentEl) stageWeighingContentEl.style.display = 'none';
                
                // 隐藏服药阶段内容
                const stageMedicationContentEl = document.getElementById('stageMedicationContent');
                if(stageMedicationContentEl) stageMedicationContentEl.style.display = 'none';
            }

            // 更新药物选择下拉列表
            const medicationToTakeSelect = document.getElementById('medicationToTakeSelect');
            if (medicationToTakeSelect) {
                // 保存当前选中值
                const currentValue = medicationToTakeSelect.value;
                
                // 清空旧选项（除了第一个）
                while (medicationToTakeSelect.options.length > 1) {
                    medicationToTakeSelect.remove(1);
                }
                
                // 添加药物选项
                for (const medName in pcManagedMeds) {
                    const option = document.createElement('option');
                    option.value = medName;
                    option.textContent = `${medName} (${pcManagedMeds[medName].count_in_box}片)`;
                    medicationToTakeSelect.appendChild(option);
                }
                
                // 恢复之前的选择（如果存在）
                if (currentValue) {
                    for (let i = 0; i < medicationToTakeSelect.options.length; i++) {
                        if (medicationToTakeSelect.options[i].value === currentValue) {
                            medicationToTakeSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
            }
            
            // 检查并更新会话状态
            fetch('/get_medication_session_status')
                .then(response => response.json())
                .then(sessionData => {
                    if (sessionData.session_active) {
                        const session = sessionData.session_data;
                        
                        // 更新会话状态显示
                        updateSessionStatus(true, `正在进行 '${session.current_medication}' 的服药会话`);
                        
                        // 显示当前药物和初始重量
                        const medNameEl = document.getElementById('currentSessionMedName');
                        const startWeightEl = document.getElementById('sessionStartWeight');
                        if (medNameEl) medNameEl.textContent = session.current_medication;
                        if (startWeightEl) startWeightEl.textContent = `${session.start_weight.toFixed(2)}g`;
                        
                        // 移动到正确的步骤
                        moveToMedicationStep(session.compartment_unlocked ? 3 : 2);
                    }
                })
                .catch(error => {
                    console.error("获取会话状态失败:", error);
                });
                
            // 更新实时重量显示
            const realTimeWeightContainer = document.getElementById('realTimeWeightContainer');
            const realTimeWeightValue = document.getElementById('realTimeWeightValue');
            if (realTimeWeightContainer && realTimeWeightValue) {
                if (!currentIsSimulationGlobal && arduinoRawStateGlobal.total_weight_in_box_arduino !== undefined) {
                    realTimeWeightContainer.style.display = 'block';
                    realTimeWeightValue.textContent = parseFloat(arduinoRawStateGlobal.total_weight_in_box_arduino).toFixed(2);
                    
                    // 只在模拟模式下检测重量稳定并自动更新库存
                    if (currentIsSimulationGlobal && window.lastWeightReadings) {
                        window.lastWeightReadings.push(parseFloat(arduinoRawStateGlobal.total_weight_in_box_arduino));
                        if (window.lastWeightReadings.length > 3) {
                            window.lastWeightReadings.shift();
                        }
                        
                        if (window.lastWeightReadings.length === 3) {
                            const maxDiff = Math.max(...window.lastWeightReadings) - Math.min(...window.lastWeightReadings);
                            if (maxDiff < 0.01) {
                                // 重量稳定，自动更新库存
                                const stableWeight = window.lastWeightReadings.reduce((a, b) => a + b) / 3;
                                setInventoryByRealTimeWeight(stableWeight);
                                // 清除定时器
                                if (window.currentWeightUpdateInterval) {
                                    clearInterval(window.currentWeightUpdateInterval);
                                }
                            }
                        }
                    } else if (currentIsSimulationGlobal) {
                        window.lastWeightReadings = [];
                    }
                } else {
                    realTimeWeightContainer.style.display = 'none';
                }
            }
        } catch (e) {
            console.error("Error in updateUI:", e);
            addLog("UI 更新时发生错误: " + e.message, "error");
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded: Script starting.");
        addLog("Smart Pillbox Controller V6_fix_4 loaded.");
        
        // 初始化WPP步骤UI
        moveToWppStep(1);
        
        // 初始化顺序服药UI（如果已实现moveToMedicationStep函数）
        if(typeof moveToMedicationStep === 'function') {
            moveToMedicationStep(1);
        }
        
        // 获取初始状态
        fetchStatus(); 
        setInterval(fetchStatus, 200); 
        
        // 显式初始化所有Bootstrap Tab组件
        document.querySelectorAll('.nav-pills .nav-link[data-bs-toggle="pill"]').forEach(function(tabEl) {
            // 手动初始化每个tab元素
            new bootstrap.Tab(tabEl);
            
            // 添加额外的点击事件监听，防止Bootstrap事件失效
            tabEl.addEventListener('click', function() {
                const target = document.querySelector(this.dataset.bsTarget);
                if (target) {
                    // 先移除所有active类
                    this.closest('.nav-pills').querySelectorAll('.nav-link').forEach(el => {
                        el.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-pane').forEach(el => {
                        el.classList.remove('show', 'active');
                    });
                    
                    // 添加active类到当前tab和目标面板
                    this.classList.add('active');
                    target.classList.add('show', 'active');
                }
            });
        });
        
        console.log("DOMContentLoaded: Tab initialization completed.");
    });

    function showMedicationSummary() {
        // 隐藏所有WPP步骤内容
        document.querySelectorAll('.wpp-step-content').forEach(el => {
            el.style.display = 'none';
        });
        
        // 更新摘要信息
        const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
        if (details) {
            document.getElementById('summaryMedName').textContent = pcActiveMedicationNameGlobal;
            document.getElementById('summaryWPP').textContent = details.wpp.toFixed(3);
            document.getElementById('summaryCount').textContent = details.count_in_box;
            document.getElementById('summaryTotalWeight').textContent = details.total_weight_in_box.toFixed(2);
        }
        
        // 显示摘要区域
        const summaryEl = document.getElementById('medicationSummary');
        if (summaryEl) {
            summaryEl.style.display = 'block';
        }
        
        addLog(`完成 '${pcActiveMedicationNameGlobal}' 的设置`, "success");
    }

    function startNewMedicationSetup() {
        // 重置到步骤1
        moveToWppStep(1);
        
        // 清空当前选中的药物
        setPcActiveMedication(null);
        
        addLog("准备添加新的药物", "info");
    }

    function completeAllMedicationSetup() {
        // 重置到步骤1
        moveToWppStep(1);
        
        // 清空当前选中的药物
        setPcActiveMedication(null);
        
        addLog("所有药物设置已完成", "success");
    }

    // 新增函数：更新摘要信息
    function updateSummaryInfo() {
        console.log("执行updateSummaryInfo，当前药物:", pcActiveMedicationNameGlobal);
        console.log("药物详情数据:", pc_managed_medication_details);
        
        if(!pcActiveMedicationNameGlobal) {
            console.warn("没有选中的药物，无法更新摘要信息");
            return;
        }
        
        const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
        console.log("当前药物详情:", details);
        
        try {
        // 更新步骤4的确认信息
            const wppConfirmMedName = document.getElementById('wppConfirmMedName');
            const wppConfirmValue = document.getElementById('wppConfirmValue');
            if (wppConfirmMedName) wppConfirmMedName.textContent = pcActiveMedicationNameGlobal || '-';
            if (wppConfirmValue) {
                wppConfirmValue.textContent = details && details.wpp ? parseFloat(details.wpp).toFixed(3) : '-';
        }
        
        // 更新步骤6的摘要信息
            const summaryMedName = document.getElementById('summaryMedName');
            const summaryWPP = document.getElementById('summaryWPP');
            const summaryCount = document.getElementById('summaryCount');
            const summaryTotalWeight = document.getElementById('summaryTotalWeight');
            
            if (summaryMedName) summaryMedName.textContent = pcActiveMedicationNameGlobal || '-';
            if (summaryWPP) {
                summaryWPP.textContent = details && details.wpp ? parseFloat(details.wpp).toFixed(3) : '-';
            }
            if (summaryCount) {
                summaryCount.textContent = details && details.count_in_box !== undefined ? details.count_in_box : '-';
            }
            if (summaryTotalWeight) {
                summaryTotalWeight.textContent = details && details.total_weight_in_box ? 
                    parseFloat(details.total_weight_in_box).toFixed(2) : '-';
            }
        } catch (error) {
            console.error("更新摘要信息时发生错误:", error);
            addLog("更新摘要信息时发生错误: " + error.message, "error");
        }
    }

    // 修改现有的WPP相关函数
    function setWPPFromSimulatedSinglePillWeight() {
        console.log("setWPPFromSimulatedSinglePillWeight called");
        if (!pcActiveMedicationNameGlobal) { 
            addLog("请先从列表选择一个药物作为当前操作药物，才能为其设置WPP。", "error"); 
            return; 
        }
        const inputEl = document.getElementById('simulatedSinglePillWeightInput');
        if (!inputEl) { 
            console.error("simulatedSinglePillWeightInput not found"); 
            return; 
        }
        const singlePillWeightStr = inputEl.value.trim();
        if (singlePillWeightStr === "" || isNaN(parseFloat(singlePillWeightStr))) {
            addLog("请输入有效的数字。", "error"); 
            return;
        }
        const wpp = parseFloat(singlePillWeightStr);
        if (wpp <= 0.0001) {
            addLog("单粒药重必须大于0.0001g。", "error"); 
            return;
        }
        
        addLog(`设置 '${pcActiveMedicationNameGlobal}' 的WPP为 ${wpp}g...`, "info");
        
        sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: wpp }, 'POST', `设置 '${pcActiveMedicationNameGlobal}' WPP`)
            .then(data => {
                if (data.status === 'success') {
                    // 清空输入框
                    inputEl.value = '';
                    
                    // 延迟获取最新数据并移动到步骤4
                    setTimeout(() => {
                        fetchStatus()
                            .then(() => {
                                moveToWppStep(4);
                                updateSummaryInfo();
                            })
                            .catch(err => {
                                console.error("获取状态失败:", err);
                                addLog("获取最新状态失败，但WPP设置可能已成功。", "warn");
                                moveToWppStep(4);
                            });
                    }, 500);
        } else {
                    addLog(`设置WPP失败: ${data.message || '未知错误'}`, "error");
                }
            })
            .catch(err => {
                console.error("设置WPP时发生错误:", err);
                addLog(`设置WPP失败: ${err.message || err}`, "error");
            });
    }
    
    // 添加"真实/模拟"模式下的模拟重量输入处理函数
    function setWPPFromRealModeSimulatedWeight() {
        console.log("setWPPFromRealModeSimulatedWeight called");
        if (!pcActiveMedicationNameGlobal) { 
            addLog("请先从列表选择一个药物作为当前操作药物，才能为其设置WPP。", "error"); 
            return; 
        }
        const inputEl = document.getElementById('simulatedRealModeWeightInput');
        if (!inputEl) { 
            console.error("simulatedRealModeWeightInput not found"); 
            return; 
        }
        const singlePillWeightStr = inputEl.value.trim();
        if (singlePillWeightStr === "" || isNaN(parseFloat(singlePillWeightStr))) {
            addLog("请输入有效的数字。", "error"); 
            return;
        }
        const wpp = parseFloat(singlePillWeightStr);
        if (wpp <= 0.0001) {
            addLog("单粒药重必须大于0.0001g。", "error"); 
            return;
        }
        
        addLog(`设置 '${pcActiveMedicationNameGlobal}' 的WPP为 ${wpp}g...`, "info");
        
        sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: wpp }, 'POST', `设置 '${pcActiveMedicationNameGlobal}' WPP`)
            .then(data => {
                if (data.status === 'success') {
                    // 清空输入框
                    inputEl.value = '';
                    
                    // 延迟获取最新数据并移动到步骤4
                    setTimeout(() => {
                        fetchStatus()
                            .then(() => {
                                moveToWppStep(4);
                                updateSummaryInfo();
                            })
                            .catch(err => {
                                console.error("获取状态失败:", err);
                                addLog("获取最新状态失败，但WPP设置可能已成功。", "warn");
                                moveToWppStep(4);
                            });
                    }, 500);
                } else {
                    addLog(`设置WPP失败: ${data.message || '未知错误'}`, "error");
                }
            })
            .catch(err => {
                console.error("设置WPP时发生错误:", err);
                addLog(`设置WPP失败: ${err.message || err}`, "error");
            });
    }
    
     function measureSinglePillForActiveMedReal() {
        console.log("measureSinglePillForActiveMedReal called, sim mode:", currentIsSimulationGlobal);
        if (!pcActiveMedicationNameGlobal) { addLog("请先选择药物以测量其单片重。", "error"); return; }
        
        if (currentIsSimulationGlobal) { 
            const singlePillWeightStr = prompt(`模拟真实测量: 请为药物 "${pcActiveMedicationNameGlobal}" 输入单粒药的模拟重量 (g):`, "0.25");
            if (singlePillWeightStr === null) { console.log("Simulated real measurement cancelled by user."); return; }
            if (singlePillWeightStr === "" || isNaN(parseFloat(singlePillWeightStr)) || parseFloat(singlePillWeightStr) <= 0.0001) {
                 addLog("无效的模拟测量重量。", "error"); return;
            }
            const wpp = parseFloat(singlePillWeightStr);
            sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: wpp }, 'POST', `(模拟的真实测量) 设置 '${pcActiveMedicationNameGlobal}' WPP`)
                .then(data => {
                    if(data.status === 'success') {
                        // 移动到步骤4
                        moveToWppStep(4);
                    }
                });
        } else { 
            // 在真实模式下测量单片药重
            // 首先显示加载指示和反馈
            const confirmBtn = document.getElementById('confirmRealMeasurementBtn');
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 测量中...';
            }
            
            addLog(`正在命令Arduino测量 '${pcActiveMedicationNameGlobal}' 的单片重，请等待...`, "info");
            
            sendCommand('/measure_single_pill_real_mode_for_active_med', {}, 'POST', `命令Arduino测量 '${pcActiveMedicationNameGlobal}' 单片重`)
                .then(data => {
                    if(data.status === 'success') {
                        addLog(`正在测量 '${pcActiveMedicationNameGlobal}' 的单片重，请等待结果...`, "info");
                        
                        // 获取初始WPP以便检测变化
                        let initialWpp = null;
                        if (pcActiveMedicationNameGlobal && pc_managed_medication_details[pcActiveMedicationNameGlobal]) {
                            initialWpp = pc_managed_medication_details[pcActiveMedicationNameGlobal].wpp;
                        }
                        
                        // 定义一个函数来检查WPP是否已更新
                        let attempts = 0;
                        const checkWppUpdated = function() {
                            attempts++;
                            
                            // 尝试获取最新状态
                            fetchStatus()
                                .then(() => {
                                    // 检查WPP是否已更新
                                    if (pcActiveMedicationNameGlobal && pc_managed_medication_details[pcActiveMedicationNameGlobal]) {
                                        const currentWpp = pc_managed_medication_details[pcActiveMedicationNameGlobal].wpp;
                                        
                                        // 如果WPP已更新或已有有效WPP
                                        if ((initialWpp === null && currentWpp > 0.0001) || 
                                            (initialWpp !== null && Math.abs(currentWpp - initialWpp) > 0.0001)) {
                                            addLog(`成功测量并更新 '${pcActiveMedicationNameGlobal}' 的WPP为 ${currentWpp.toFixed(3)}g`, "success");
                                            
                                            // 重置按钮状态
                                            if (confirmBtn) {
                                                confirmBtn.disabled = false;
                                                confirmBtn.textContent = '确认测量单片重量';
                                            }
                                            
                                            // 移动到步骤4
                                            moveToWppStep(4);
                                            return;
                                        }
                                    }
                                    
                                    // 如果尚未更新但尝试次数未达上限，继续尝试
                                    if (attempts < 10) {
                                        setTimeout(checkWppUpdated, 1000);
                                    } else {
                                        // 尝试次数过多，提供手动继续选项
                                        addLog(`未能自动检测到WPP更新，但操作可能已成功。您可以点击下方按钮继续。`, "warn");
                                        
                                        // 重置按钮状态并更改为继续按钮
                                        if (confirmBtn) {
                                            confirmBtn.disabled = false;
                                            confirmBtn.textContent = '手动继续到下一步';
                                            confirmBtn.onclick = function() {
                                                moveToWppStep(4);
                                            };
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error("检查WPP更新时出错:", error);
                                    
                                    // 如果出错但尝试次数未达上限，继续尝试
                                    if (attempts < 5) {
                                        setTimeout(checkWppUpdated, 1000);
                                    } else {
                                        // 尝试次数过多，提供手动继续选项
                                        addLog(`由于连接问题，无法检测WPP更新，但操作可能已成功。`, "warn");
                                        
                                        // 重置按钮状态并更改为继续按钮
                                        if (confirmBtn) {
                                            confirmBtn.disabled = false;
                                            confirmBtn.textContent = '手动继续到下一步';
                                            confirmBtn.onclick = function() {
                                                moveToWppStep(4);
                                            };
                                        }
                                    }
                                });
                        };
                        
                        // 开始检查WPP更新
                        setTimeout(checkWppUpdated, 1500);
                    } else {
                        // 命令发送失败，重置按钮状态
                        if (confirmBtn) {
                            confirmBtn.disabled = false;
                            confirmBtn.textContent = '确认测量单片重量';
                        }
                        addLog(`命令Arduino测量单片重失败: ${data.message || '未知错误'}`, "error");
                    }
                })
                .catch(error => {
                    // 出错时重置按钮状态
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = '确认测量单片重量';
                    }
                    addLog(`命令Arduino测量单片重时出错: ${error.message || error}`, "error");
                });
        }
    }

    function moveToStep4WithCurrentWeight() {
        // 在真实模式下，使用当前重量作为WPP值
        if (!currentIsSimulationGlobal) {
            // 显示加载指示器
            addLog("正在获取最新重量数据...", "info");
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'text-center mt-2';
            loadingIndicator.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div><div class="mt-1">获取重量中...</div>';
            
            const weightContainer = document.getElementById('realTimeWeightContainerInStep3');
            if (weightContainer) {
                weightContainer.appendChild(loadingIndicator);
            }
            
            // 主动获取一次最新重量，确保数据准确
            fetch('/get_current_weight')
                .then(response => response.json())
                .then(data => {
                    // 移除加载指示器
                    if (loadingIndicator && loadingIndicator.parentNode) {
                        loadingIndicator.parentNode.removeChild(loadingIndicator);
                    }
                    
                    let currentWeight = 0;
                    let weightSource = "";
                    
                    if (data.status === 'success' && data.weight !== undefined) {
                        currentWeight = parseFloat(data.weight);
                        weightSource = "API";
                        console.log("获取到最新重量:", currentWeight);
                    } else {
                        // 如果API返回错误，尝试使用显示的值
                        try {
                            currentWeight = parseFloat(document.getElementById('realTimeWeightValueInStep3').textContent);
                            weightSource = "显示值";
                            console.log("使用显示的重量:", currentWeight);
                        } catch (e) {
                            console.error("无法解析显示的重量值:", e);
                        }
                    }
                    
                    if (!isNaN(currentWeight) && currentWeight > 0.0001) {
                        addLog(`使用${weightSource}获取的重量: ${currentWeight.toFixed(3)}g`, "info");
                        
                        sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: currentWeight }, 'POST', `设置WPP为当前重量`)
                            .then(data => {
                                if (data.status === 'success') {
                                    addLog(`已设置WPP为当前重量: ${currentWeight.toFixed(3)}g`, "success");
                                    
                                    // 清除步骤3的实时重量更新定时器
                                    if (window.step3WeightUpdateInterval) {
                                        clearInterval(window.step3WeightUpdateInterval);
                                        window.step3WeightUpdateInterval = null;
                                    }
                                    
                                    moveToWppStep(4);
                                } else {
                                    addLog(`设置WPP失败: ${data.message || '未知错误'}`, "error");
                                }
                            })
                            .catch(error => {
                                addLog(`设置WPP时发生错误: ${error.message || error}`, "error");
                            });
                    } else {
                        addLog("当前重量无效或太小 (小于0.0001g)，请重新测量", "error");
                    }
                })
                .catch(error => {
                    // 移除加载指示器
                    if (loadingIndicator && loadingIndicator.parentNode) {
                        loadingIndicator.parentNode.removeChild(loadingIndicator);
                    }
                    
                    console.error("获取最新重量失败:", error);
                    addLog("获取最新重量失败，尝试使用显示的值", "warn");
                    
                    // 尝试使用显示的值
                    try {
                        let displayedWeight = parseFloat(document.getElementById('realTimeWeightValueInStep3').textContent);
                        if (!isNaN(displayedWeight) && displayedWeight > 0.0001) {
                            addLog(`使用显示的重量值: ${displayedWeight.toFixed(3)}g`, "info");
                            
                            sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: displayedWeight }, 'POST', `设置WPP为显示重量`)
                                .then(data => {
                                    if (data.status === 'success') {
                                        addLog(`已设置WPP为显示重量: ${displayedWeight.toFixed(3)}g`, "success");
                                        moveToWppStep(4);
                                    } else {
                                        addLog(`设置WPP失败: ${data.message || '未知错误'}`, "error");
                                    }
                                })
                                .catch(error => {
                                    addLog(`设置WPP时发生错误: ${error.message || error}`, "error");
                                });
                        } else {
                            addLog("显示的重量值无效，请重新测量", "error");
                        }
                    } catch (e) {
                        addLog("无法读取显示的重量值，请重新测量", "error");
                        console.error("解析显示重量出错:", e);
                    }
                });
        } else {
            // 在模拟模式下，检查是否已输入重量
            const inputEl = document.getElementById('simulatedRealModeWeightInput');
            if (inputEl && inputEl.value && parseFloat(inputEl.value) > 0.0001) {
                setWPPFromRealModeSimulatedWeight();
            } else {
                addLog("请先输入有效的模拟重量", "warn");
                moveToWppStep(4);
            }
        }
    }

    // 添加到index.html的JS代码部分，放在script部分最后
    function forceRefreshWeight() {
        const refreshBtn = document.getElementById('refreshWeightBtn');
        const statusEl = document.getElementById('weightUpdateStatusInStep5');
        const weightEl = document.getElementById('currentWeightDisplayInStep5');
        if (refreshBtn) { refreshBtn.disabled = true; refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中'; }
        if (statusEl) { statusEl.textContent = '正在强制刷新...'; statusEl.classList.remove('text-success','text-danger'); }
        
        fetch('/force_refresh_weight', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const weight = parseFloat(data.weight);
                if (weightEl) weightEl.textContent = weight.toFixed(3);
                if (statusEl) { statusEl.textContent = '刷新成功: ' + (data.message || ''); statusEl.classList.add('text-success'); statusEl.classList.remove('text-danger'); }
            } else {
                if (statusEl) { statusEl.textContent = '刷新失败: ' + (data.message || '未知错误'); statusEl.classList.add('text-danger'); statusEl.classList.remove('text-success'); }
            }
        })
        .catch(error => {
            console.error("获取重量失败:", error);
            if (statusEl) { statusEl.textContent = '获取重量失败，请重试'; statusEl.classList.add('text-danger'); statusEl.classList.remove('text-success'); }
        })
        .finally(() => {
            if (refreshBtn) { refreshBtn.disabled = false; refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 刷新重量'; }
        });
    }

    function updateStep5WeightDisplay(weight) {
        const el = document.getElementById('currentWeightDisplayInStep5');
        if (el) el.textContent = weight.toFixed(3);
    }

    function confirmWeightAndSetInventory() {
        if (!pcActiveMedicationNameGlobal) {
            addLog("请先选择药物", "error");
            return;
        }
        
        const currentWeightEl = document.getElementById('currentWeightDisplayInStep5');
        const currentWeight = currentWeightEl ? parseFloat(currentWeightEl.textContent) : 0;
        const wpp = pc_managed_medication_details[pcActiveMedicationNameGlobal].wpp;
        
        if (wpp <= 0.001) {
            addLog("所选药物的单片重量无效，请先设置WPP", "error");
            return;
        }
        
        const pillCount = Math.round(currentWeight / wpp);
        const confirmBtn = document.getElementById('confirmWeightBtnInStep5');
        if (confirmBtn) { confirmBtn.disabled = true; confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中'; }
        
        // 使用已有的API更新状态
        fetch('/update_state_from_manual_count_for_active_med', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ count: pillCount })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                addLog(`已确认库存: ${pillCount}片 (${currentWeight.toFixed(3)}g)`, "success");
                // 进入下一步
                moveToWppStep(6);
            } else {
                addLog(data.message || "设置库存失败", "error");
            }
        })
        .catch(error => {
            console.error("设置库存失败:", error);
            addLog("无法连接到服务器", "error");
        })
        .finally(() => {
            if (confirmBtn) { confirmBtn.disabled = false; confirmBtn.textContent = '确认重量和药片数量'; }
        });
    }

    // 每次切换到步骤5时，自动开始重量监测
    function startStep5WeightMonitoring() {
        // 停止之前可能存在的定时器
        if (window.step5WeightInterval) {
            clearInterval(window.step5WeightInterval);
        }
        // 立即刷新一次
        refreshWeightStep5();
        // 周期刷新
        window.step5WeightInterval = setInterval(refreshWeightStep5, 2000);
    }

    // 新增：仅使用缓存接口刷新步骤5重量
    function refreshWeightStep5() {
      fetch('/get_current_weight')
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            const w = parseFloat(data.weight);
            const wEl = document.getElementById('currentWeightDisplayInStep5');
            if (wEl) wEl.textContent = w.toFixed(3);
            // 更新药片计数
            const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
            if (details && details.wpp > 0.001) {
              const count = Math.round(w / details.wpp);
              const countEl = document.getElementById('pillCountDisplayInStep5');
              if (countEl) countEl.textContent = count;
              // 更新进度条
              const pct = Math.min(100, Math.round((count / 100) * 100));
              const bar = document.getElementById('pillCountProgressBarInStep5');
              if (bar) { bar.style.width = pct + '%'; bar.setAttribute('aria-valuenow', pct); }
            }
          }
        }).catch(err => console.error('读取当前重量失败:', err));
    }

    // 修改自动刷新逻辑
    function startStep5WeightMonitoring() {
      if (window.step5WeightInterval) clearInterval(window.step5WeightInterval);
      // 立即刷新一次
      refreshWeightStep5();
      // 周期刷新
      window.step5WeightInterval = setInterval(refreshWeightStep5, 2000);
    }

    // 修改moveToWppStep函数，添加对步骤5的特殊处理
    const originalMoveToWppStep = window.moveToWppStep;
    window.moveToWppStep = function(stepNumber, mode) {
        // 先调用原始函数
        originalMoveToWppStep(stepNumber, mode);
        
        // 如果是步骤5，启动重量监测
        if (stepNumber === 5) {
            // 延迟一点启动，确保UI已更新
            setTimeout(() => {
                startStep5WeightMonitoring();
                
                // 更新WPP显示
                if (pcActiveMedicationNameGlobal && pc_managed_medication_details[pcActiveMedicationNameGlobal]) {
                    const wpp = pc_managed_medication_details[pcActiveMedicationNameGlobal].wpp;
                    $("#wppDisplayInStep5").text(wpp.toFixed(3) + " g");
                } else {
                    $("#wppDisplayInStep5").text("未设置");
                }
            }, 300);
        } else if (window.step5WeightInterval) {
            // 如果离开步骤5，停止重量监测
            clearInterval(window.step5WeightInterval);
            window.step5WeightInterval = null;
        }
    };

    // 在PC活动药物变更时更新WPP显示
    const originalSetPcActiveMedication = window.setPcActiveMedication;
    window.setPcActiveMedication = function(medName) {
        // 调用原始函数
        originalSetPcActiveMedication(medName);
        
        // 更新步骤5的WPP显示
        setTimeout(() => {
            if (medName && pc_managed_medication_details[medName]) {
                const wpp = pc_managed_medication_details[medName].wpp;
                $("#wppDisplayInStep5").text(wpp.toFixed(3) + " g");
            } else {
                $("#wppDisplayInStep5").text("未设置");
            }
        }, 500);
    };
</script>
</body>
</html>
