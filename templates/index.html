<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Pillbox Controller V6_fix_4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <style>
        body { 
            padding: 20px; 
            background-color: #f8f9fa; 
            font-size: 0.95rem;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        .card { 
            margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            border-radius: 12px; 
            border: none;
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .card-header { 
            background-color: #0d6efd; 
            color: white; 
            font-weight: 600; 
            border-top-left-radius: 12px; 
            border-top-right-radius: 12px; 
            padding: 1rem;
            border-bottom: none;
        }
        .card-body { 
            padding: 1.25rem; 
            background-color: #fff;
        }
        .status-disconnected { 
            color: #dc3545; 
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        .status-connected { 
            color: #198754; 
            font-weight: 600;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .mode-indicator { 
            font-size: 0.9em; 
            padding: 8px 16px; 
            border-radius: 20px; 
            display: inline-block; 
            margin-left: 15px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mode-simulation { 
            background-color: #ffc107; 
            color: #000; 
        }
        .mode-real { 
            background-color: #20c997; 
            color: white; 
        }
        .log-box { 
            max-height: 200px; 
            overflow-y: auto; 
            border: 1px solid #e9ecef; 
            padding: 15px; 
            font-family: 'Consolas', monospace; 
            font-size: 0.85em; 
            background-color: #f8f9fa; 
            border-radius: 8px; 
            margin-top: 15px;
        }
        .btn {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0b5ed7;
        }
        .form-control {
            border-radius: 8px;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            transition: border-color 0.2s ease-in-out;
        }
        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25);
        }
        .alert {
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .alert-info {
            background-color: #e7f5ff;
            color: #0c5460;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease-in-out;
        }
        .step-circle.active {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(13,110,253,0.2);
        }
        .real-time-weight {
            font-size: 1.2em;
            font-weight: 600;
            color: #0d6efd;
            padding: 10px;
            background-color: #e7f5ff;
            border-radius: 8px;
            margin-top: 10px;
        }
        .weight-stable {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .table {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .table td {
            vertical-align: middle;
        }
        .table-active-pc-med td:first-child {
            font-weight: 600;
            background-color: #e7f5ff !important;
        }
        .nav-pills .nav-link {
            border-radius: 20px;
            padding: 8px 16px;
            margin: 0 4px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            box-shadow: 0 2px 4px rgba(13,110,253,0.2);
        }
        .nav-pills .nav-link:hover:not(.active) {
            background-color: #e9ecef;
        }
        .section { display: none; } 
        .table th, .table td { vertical-align: middle; font-size: 0.9rem; }
        .table-active-pc-med td:first-child { font-weight: bold; background-color: #cfe2ff !important; }
        .small-text, .form-label-sm, small { font-size: 0.85em; color: #6c757d;}
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .form-control-sm { font-size: 0.875rem; padding: 0.25rem 0.5rem; }
        .nav-pills .nav-link { font-size: 0.9rem; cursor: pointer; } 
        .nav-pills .nav-link.active { background-color: #0d6efd; color: white; }
        .sub-section { margin-top: 1rem; padding: 0.75rem; border: 1px solid #e0e0e0; border-radius: 0.25rem; background-color: #fdfdfd; }
        h6.section-title { color: #0056b3; margin-bottom: 0.75rem; font-weight:600; font-size: 1rem; }
        .step-label { font-weight: 500; color: #333; display: block; margin-bottom: 0.3rem;}
        .consumption-log-entry { font-size: 0.9em; padding: 0.25rem 0.5rem; border-bottom: 1px dashed #eee; }
        .consumption-log-entry:last-child { border-bottom: none; }
        /* Lid Open/Close Indicator */
        .lid-indicator { display: inline-block; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-size: 0.9rem; }
        .lid-open { background-color: #d4edda; color: #155724; }
        .lid-closed { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0" style="font-size: 1.75rem;">Smart Pillbox Controller V6_fix_4</h1>
            <div>
                <span id="connectionStatus" class="status-disconnected">Disconnected</span>
                <div id="modeIndicator" class="mode-indicator mode-simulation">Simulation Mode</div>
                <div id="lidIndicator" class="lid-indicator lid-closed">Closed</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Global Control</div>
            <div class="card-body d-flex justify-content-start align-items-center">
                <button class="btn btn-warning me-2 btn-sm" onclick="setMode('simulation')">Simulation Mode</button>
                <button class="btn btn-success me-2 btn-sm" onclick="setMode('real')">Real Mode</button>
                <div class="vr mx-2"></div>
                <button class="btn btn-primary me-2 btn-sm" onclick="setStage(0)">Weighing/Setup Stage</button>
                <button class="btn btn-info me-2 btn-sm" onclick="setStage(1)">Medication Stage</button>
                <button class="btn btn-secondary me-2 btn-sm" onclick="location.href='/calendar'">Calendar Reminders</button>
                <button class="btn btn-danger btn-sm" onclick="setStage(2)">Reset System (Arduino)</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header">Arduino Real-Time Status</div>
                    <div class="card-body">
                        <p class="mb-1 small-text"><strong>Stage:</strong> <span id="arduinoStageName">N/A</span></p>
                        <p class="mb-1 small-text"><strong>Current Medication:</strong> <span id="arduinoCurrentMed">N/A</span></p>
                        <p class="mb-1 small-text"><strong>Medication WPP (g):</strong> <span id="arduinoCurrentMedWPP">N/A</span></p>
                        <p class="mb-1 small-text"><strong>Pillbox Total Weight (g):</strong> <span id="arduinoTotalWeight">N/A</span></p>
                        <p class="mb-1 small-text"><strong>Pill Count:</strong> <span id="arduinoCurrentMedCount">N/A</span></p>
                        <details class="mt-2"><summary class="small-text text-muted" style="cursor:pointer;">Raw Data</summary>
                            <code id="rawData" style="font-size:0.8em; display:block; max-height: 50px; overflow-y:auto;">N/A</code>
                        </details>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header">Managed Medication Status (<span id="pcActiveMedicationDisplay" class="text-warning">Current: None</span>)</div>
                    <div class="card-body">
                        <!-- Add new medication input section -->
                        <div class="row g-3 align-items-end mb-3">
                            <div class="col-md-6">
                                <label for="newMedNameInput" class="form-label form-label-sm">Add New Medication:</label>
                                <input type="text" id="newMedNameInput" class="form-control form-control-sm" placeholder="Enter medication name">
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-success btn-sm w-100" onclick="addOrUpdateKnownMedication()">Add to Medication List</button>
                            </div>
                        </div>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead><tr><th>Medication</th><th>WPP (g)</th><th>Total Weight (g)</th><th>Count</th></tr></thead>
                                <tbody id="pcManagedMedicationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="medicationManagementCard" class="card">
            <div class="card-header">Medication Management (Defined Medication List)</div>
            <div class="card-body">
                <!-- Step 1: Add or Select Medication -->
                <div id="wppStep1" class="wpp-step-content">
                    <h6 class="step-label">Step 1: Add or Select Medication</h6>
                    <hr>
                    <h6 class="section-title">Pillbox Known Medication List (Click Name to Set as Current Medication)</h6>
                    <table class="table table-hover table-sm mb-3">
                        <thead><tr><th>Medication Name (Set Active)</th><th>WPP (g)</th><th>Total Weight (g)</th><th>Estimated Count</th></tr></thead>
                        <tbody id="knownMedicationsClickableTableBody"></tbody>
                    </table>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary btn-sm" onclick="moveToWppStep(2)">Next: Select Measurement Mode</button>
                    </div>
                </div>
                <!-- Only show subsequent steps after selecting a medication -->
                <div id="wppSettingSectionForActiveMed" class="sub-section" style="display:none;"> 
                    <!-- Step-by-Step WPP Measurement Interface (Steps 2-6) -->
                    <div class="card bg-light mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Step-by-Step WPP Measurement</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-center align-items-center mb-3">
                                <div id="wppStepCircle1" class="rounded-circle d-flex justify-content-center align-items-center me-2" style="width:50px; height:50px; background-color:#007bff; color:white; font-weight:bold;">1</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="wppStepCircle2" class="rounded-circle d-flex justify-content-center align-items-center mx-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">2</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="wppStepCircle3" class="rounded-circle d-flex justify-content-center align-items-center mx-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">3</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="wppStepCircle4" class="rounded-circle d-flex justify-content-center align-items-center mx-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">4</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="wppStepCircle5" class="rounded-circle d-flex justify-content-center align-items-center mx-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">5</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="wppStepCircle6" class="rounded-circle d-flex justify-content-center align-items-center ms-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">6</div>
                            </div>
                            
                            <!-- Step 2: Select Measurement Mode -->
                            <div id="wppStep2" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 2: Select Measurement Mode</h6>
                                <p class="small-text mb-2">Choose an appropriate setting for WPP measurement of single pill weight</p>
                                <div class="d-flex mb-3">
                                    <button class="btn btn-outline-primary me-2" onclick="moveToWppStep(3, 'simulated')">Manual Input of Single Pill Weight</button>
                                    <button class="btn btn-outline-success" onclick="moveToWppStep(3, 'real')">Measure Single Pill by Weight</button>
                                </div>
                            </div>
                            
                            <!-- Step 3: Simulated Environment Input -->
                            <div id="wppStep3-simulated" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 3: Input Single Pill Weight</h6>
                                <div class="row g-2 align-items-end mb-3">
                                    <div class="col">
                                        <label for="simulatedSinglePillWeightInput" class="form-label form-label-sm">Input the weight of this <strong class="text-danger">single pill</strong> in simulated mode (g):</label>
                                        <input type="number" step="0.001" id="simulatedSinglePillWeightInput" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-success btn-sm" onclick="setWPPFromSimulatedSinglePillWeight()">Confirm and Update WPP</button>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="moveToWppStep(2, 'simulated')">Back</button>
                                    <button class="btn btn-sm btn-primary" onclick="moveToWppStep(4)">Next: Confirm WPP Settings</button>
                                </div>
                            </div>
                            
                            <!-- Step 3: Real Environment Measurement -->
                            <div id="wppStep3-real" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 3: Prepare to Measure Single Pill Weight</h6>
                                <p class="small-text">In real mode, WPP is set through actual sensor readings. In simulated mode, you can manually input simulated values.</p>
                                <div id="realMeasureWPPButtonContainer">
                                    <button class="btn btn-outline-secondary btn-sm mb-2" onclick="tareArduinoForMeasurement()">Prepare Measurement: Tare (Arduino Zero) the Pillbox</button>
                                    <p class="small-text mb-1">(Physical operation) Place '<span class="current-active-med-name-wpp text-primary"></span>'s <strong class="text-danger">single pill</strong> in the pillbox and wait for weight stabilization.</p>
                                    
                                    <!-- Display real-time weight in real mode -->
                                    <div id="realTimeWeightContainerInStep3" class="real-time-weight mt-3" style="display:none;">
                                        <strong>Real-Time Weight:</strong> <span id="realTimeWeightValueInStep3">0.00</span>g
                                        <div class="small-text text-muted">(From Arduino real-time data)</div>
                                        <button class="btn btn-sm btn-outline-warning mt-2" onclick="tareArduinoForMeasurement()">Sensor Tare/Zero</button>
                                    </div>
                                    
                                    <!-- Add manual input for simulated mode -->
                                    <div id="simulatedWPPInputContainer" style="display:none;" class="mt-3">
                                        <div class="row g-2 align-items-end">
                                            <div class="col">
                                                <label for="simulatedRealModeWeightInput" class="form-label form-label-sm">Simulated Measurement: Input the weight of this <strong class="text-danger">single pill</strong> (g):</label>
                                                <input type="number" step="0.001" id="simulatedRealModeWeightInput" class="form-control form-control-sm">
                                            </div>
                                            <div class="col-auto">
                                                <button class="btn btn-success btn-sm" onclick="setWPPFromRealModeSimulatedWeight()">Confirm and Update WPP</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="moveToWppStep(2, 'real')">Back</button>
                                    <button class="btn btn-sm btn-primary" onclick="moveToStep4WithCurrentWeight()">Next: Confirm Measurement</button>
                                </div>
                            </div>
                            
                            <!-- Step 4: Confirm WPP -->
                            <div id="wppStep4" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 4: Confirm WPP Settings</h6>
                                <p class="small-text mb-2">WPP has been set up correctly, please confirm the information is accurate</p>
                                <div class="alert alert-info">
                                    <div><strong>Medication:</strong> <span id="wppConfirmMedName">-</span></div>
                                    <div><strong>Single Pill Weight (WPP):</strong> <span id="wppConfirmValue">-</span>g</div>
                                    <div id="realTimeWeightContainer" style="display:none;">
                                        <div class="mt-2"><strong>Real-Time Weight:</strong> <span id="realTimeWeightValue">-</span>g</div>
                                        <div class="small-text text-muted">(From Arduino real-time data)</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="moveToWppStep(3)">Back</button>
                                    <button class="btn btn-sm btn-primary" onclick="moveToWppStep(5)">Next: Set Inventory</button>
                                </div>
                            </div>

                            <!-- Step 5: Set Inventory -->
                            <div id="wppStep5" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 5: Set Medication Inventory</h6>
                                <p class="small-text mb-2">Set the number/total weight of '<span class="current-active-med-name-wpp text-primary"></span>' in the pillbox</p>
                                
                                <!-- Real-time weight display card -->
                                <div class="card mb-3" id="realTimeWeightCard">
                                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Current Pillbox Real-Time Weight</h6>
                                        <button type="button" class="btn btn-sm btn-light" id="refreshWeightBtnStep5" onclick="refreshWeightStep5()">
                                            <i class="fas fa-sync-alt"></i> Refresh Weight
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center mb-3">
                                            <h3 id="currentWeightDisplayInStep5">0.000</h3>
                                            <p class="text-muted mb-0">g</p>
                                            <small id="weightUpdateStatusInStep5" class="text-muted">Waiting for data...</small>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <h6>Pill Calculation</h6>
                                            <div class="d-flex justify-content-between">
                                                <span>Single Pill Weight:</span>
                                                <span id="wppDisplayInStep5">0.000 g</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Estimated Pill Count:</span>
                                                <span id="pillCountDisplayInStep5">0</span>
                                            </div>
                                            <div class="progress mt-2">
                                                <div id="pillCountProgressBarInStep5" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid gap-2 mt-3">
                                            <button type="button" class="btn btn-success" id="confirmWeightBtnInStep5" onclick="confirmWeightAndSetInventory()">
                                                Confirm Weight and Pill Count
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="tareWeightBtnInStep5" onclick="tareArduinoForMeasurement()">
                                                <i class="fas fa-balance-scale"></i> Tare/Calibrate
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="weighingSimModeOnlyControls"> 
                                    <ul class="nav nav-pills mb-3 nav-fill" id="simInventoryUpdateModeTab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="inv-sim-measure-total-tab" data-bs-toggle="pill" data-bs-target="#inv-sim-measure-total-pane" type="button" role="tab" aria-controls="inv-sim-measure-total-pane" aria-selected="true" onclick="showTab('inv-sim-measure-total-pane', this)">Update via Total Weight (Simulated Measurement)</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="inv-sim-manual-count-tab" data-bs-toggle="pill" data-bs-target="#inv-sim-manual-count-pane" type="button" role="tab" aria-controls="inv-sim-manual-count-pane" aria-selected="false" onclick="showTab('inv-sim-manual-count-pane', this)">Update via Manual Count</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content" id="simInventoryUpdateModeTabContent">
                                        <div class="tab-pane fade show active" id="inv-sim-measure-total-pane" role="tabpanel" aria-labelledby="inv-sim-measure-total-tab">
                                            <p class="small-text">Simulated measurement of the total weight of active medication in the pillbox.</p>
                                            <button class="btn btn-outline-secondary btn-sm mb-2" onclick="tareArduinoForMeasurement()">Step A1: Tare (Arduino Zero) Current Medication Batch</button>
                                            <p class="small-text mb-1">Step A2: (Virtual operation) Place all pills of '<span class="current-active-med-name-wpp text-primary"></span>' into the pillbox.</p>
                                            <div class="row g-2 align-items-end">
                                                <div class="col">
                                                    <label for="simBatchTotalWeightInput" class="form-label form-label-sm">Step A3: Input the simulated total weight of this batch of medication (g):</label>
                                                    <input type="number" step="0.01" id="simBatchTotalWeightInput" class="form-control form-control-sm">
                                                </div>
                                                <div class="col-auto">
                                                    <button class="btn btn-primary btn-sm" onclick="setInventoryBySimulatedBatchWeight()">Set Total Weight & Calculate Count</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="inv-sim-manual-count-pane" role="tabpanel" aria-labelledby="inv-sim-manual-count-tab">
                                            <p class="small-text">Manual input of the total number of active medication in the pillbox.</p>
                                            <div class="row g-2 align-items-end">
                                                <div class="col">
                                                    <label for="inventoryManualPillCountInput" class="form-label form-label-sm">Step B1: Input the total number of pills of '<span class="current-active-med-name-wpp text-primary"></span>' (as counted by hand):</label>
                                                    <input type="number" id="inventoryManualPillCountInput" class="form-control form-control-sm" min="0">
                                                </div>
                                                <div class="col-auto">
                                                    <button class="btn btn-primary btn-sm" onclick="setInventoryByManualPillCount()">Set Count & Calculate Total Weight</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="small-text mt-2" id="weighingRealModeInfoForInventory" style="display:none;">In real mode, the total weight and count of the pillbox are determined by actual sensor readings, and WPP has been set up correctly. <br>The real-time weight will automatically update, please confirm that the medication count has been calculated correctly before clicking the button below to complete the setup.</p>
                                
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="moveToWppStep(4)">Back</button>
                                </div>
                            </div>

                            <!-- Step 6: Complete Setup -->
                            <div id="wppStep6" class="wpp-step-content" style="display:none;">
                                <h6 class="step-label">Step 6: Complete Setup</h6>
                                <div class="alert alert-success">
                                    <div><strong>Medication Name:</strong> <span id="summaryMedName">-</span></div>
                                    <div><strong>Single Pill Weight (WPP):</strong> <span id="summaryWPP">-</span>g</div>
                                    <div><strong>Total Count:</strong> <span id="summaryCount">-</span> pills</div>
                                    <div><strong>Total Weight:</strong> <span id="summaryTotalWeight">-</span>g</div>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-sm btn-outline-primary" onclick="startNewMedicationSetup()">Continue Adding Other Medications</button>
                                    <button class="btn btn-sm btn-success" onclick="completeAllMedicationSetup()">Complete All Medication Setup</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="small-text mt-1" id="wppSettingNoActiveMedInfo">Please select a medication from the list above to operate on.</p>
            </div>
        </div>
        
        <div id="stageMedicationContent" class="section card">
             <div class="card-header bg-light text-dark">Stage: Medication (Operated Medication: <span class="current-active-med-name-stage text-primary">No Medication Selected</span>)</div>
            <div class="card-body">
                <div id="medicationStageActiveMedControls" style="display:none;">
                    <p class="small-text">Arduino currently believes the selected medication is "<span id="medStageArduinoMedName" class="text-info">N/A</span>", with an estimated count: <strong id="medStageArduinoMedCount" class="text-info">0</strong></p>
                    
                    <!-- Sequential Medication Process - Precise Record of Medication Consumption -->
                    <div class="card bg-light mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Sequential Medication Process - Precise Record of Medication Consumption</h6>
                        </div>
                        <div class="card-body">
                            <p class="small-text" id="medicationSessionStatus" class="alert alert-secondary" style="display:none;">
                                Medication Session Status: <span id="sessionStatusText">Not Started</span>
                            </div>
                            
                            <div class="d-flex justify-content-center align-items-center mb-3">
                                <div id="stepCircle1" class="rounded-circle d-flex justify-content-center align-items-center me-2" style="width:50px; height:50px; background-color:#007bff; color:white; font-weight:bold;">1</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="stepCircle2" class="rounded-circle d-flex justify-content-center align-items-center mx-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">2</div>
                                <div class="flex-grow-1" style="height:2px; background-color:#dee2e6;"></div>
                                <div id="stepCircle3" class="rounded-circle d-flex justify-content-center align-items-center ms-2" style="width:50px; height:50px; background-color:#6c757d; color:white; font-weight:bold;">3</div>
                            </div>
                            
                            <!-- Step 1: Start Medication Session -->
                            <div id="medicationStep1" class="step-content">
                                <h6 class="step-label">Step 1: Select a medication and start the medication session</h6>
                                <p class="small-text mb-2">Select the medication you want to take; the system will record the initial weight</p>
                                <div class="row g-2 mb-3">
                                    <div class="col">
                                        <select id="medicationToTakeSelect" class="form-select form-select-sm">
                                            <option value="" disabled selected>Select medication...</option>
                                            <!-- Medication options will be populated dynamically via JS -->
                                        </select>
                                    </div>
                                    <div class="col-auto">
                                        <button id="startMedicationSessionBtn" class="btn btn-primary btn-sm" onclick="startMedicationSession()">Start Medication Session</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Unlock Compartment and Take Medication -->
                            <div id="medicationStep2" class="step-content" style="display:none;">
                                <h6 class="step-label">Step 2: Unlock Compartment and Take Medication</h6>
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-2">Current Medication: </span>
                                    <span id="currentSessionMedName" class="badge bg-info me-2">None Selected</span>
                                    <span class="me-2">Initial Weight: </span>
                                    <span id="sessionStartWeight" class="badge bg-secondary">0.00g</span>
                                </div>
                                <p class="small-text mb-2">Click the button below to unlock the compartment, then remove the required medication</p>
                                <div class="d-flex mb-3">
                                    <button id="unlockCompartmentBtn" class="btn btn-warning btn-sm me-2" onclick="unlockMedicationCompartment()">Unlock Compartment</button>
                                    <button id="cancelSessionBtn" class="btn btn-outline-danger btn-sm" onclick="cancelMedicationSession()">Cancel Session</button>
                                </div>
                            </div>
                            
                            <!-- Step 3: Lock Compartment and Record Medication Consumption -->
                            <div id="medicationStep3" class="step-content" style="display:none;">
                                <h6 class="step-label">Step 3: Lock Compartment and Record Medication Consumption</h6>
                                <p class="small-text mb-2">After removing medication, click the button below to lock the compartment and automatically record consumption</p>
                                <!-- Added: Measure weight reduction and calculate consumption amount -->
                                <div class="mb-3 d-flex align-items-center">
                                    <button id="measureConsumptionBtn" class="btn btn-outline-primary btn-sm me-2" onclick="measureConsumption()">Measure Weight Reduction</button>
                                    <div>
                                        <span>Weight Reduced: <strong id="measuredWeightReduced">-</strong> g</span>
                                        <span class="ms-3">Pills Consumed: <strong id="measuredPillCount">-</strong> pills</span>
                                    </div>
                                </div>
                                <div class="d-flex mb-3">
                                    <button id="lockAndRecordBtn" class="btn btn-success btn-sm" onclick="lockAndRecordConsumption()">Complete Medication and Record</button>
                                </div>

                                <!-- Traditional Medication Method -->
                                <div class="mt-4">
                                    <h6 class="section-title">Traditional Medication Method</h6>
                                    <ul class="nav nav-pills mb-3 nav-fill" id="simConsumeModeTab" role="tablist">
                                        <!-- Hidden: Consume by count option -->
                                        <li class="nav-item" style="display:none;" role="presentation">
                                            <button class="nav-link" id="consume-manual-count-tab" data-bs-toggle="pill" data-bs-target="#consume-manual-count-pane" type="button" role="tab" aria-controls="consume-manual-count-pane" aria-selected="false">Consume by Count</button>
                                        </li>
                                        <li class="nav-item" role="presentation" id="consumeByWeightTabItem">
                                            <button class="nav-link" id="consume-sim-weight-tab" data-bs-toggle="pill" data-bs-target="#consume-sim-weight-pane" type="button" role="tab" aria-controls="consume-sim-weight-pane" aria-selected="false" onclick="showTab('consume-sim-weight-pane', this)">Consume by Weight (Simulated)</button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content">
                                        <!-- Hidden: Manual count panel -->
                                        <div class="tab-pane fade" id="consume-manual-count-pane" role="tabpanel" aria-labelledby="consume-manual-count-tab" style="display:none;"></div>
                                        <div class="tab-pane fade" id="consume-sim-weight-pane" role="tabpanel" aria-labelledby="consume-sim-weight-tab">
                                            <div class="input-group mb-3">
                                                <input type="number" step="0.01" id="weightToReduceInput" class="form-control form-control-sm" placeholder="Enter weight reduction (g)" min="0.01">
                                                <button class="btn btn-info btn-sm" onclick="consumePillsBySimulatedWeight()">Confirm Consumption (by Weight)</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Medication Result Display -->
                            <div id="medicationResult" class="mt-3 p-3 border rounded" style="display:none;">
                                <h6>Medication Records:</h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="mb-1"><strong>Medication:</strong> <span id="resultMedName">-</span></div>
                                        <div class="mb-1"><strong>Pills Consumed:</strong> <span id="resultPillCount">-</span> pills</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-1"><strong>Initial Weight:</strong> <span id="resultStartWeight">-</span>g</div>
                                        <div class="mb-1"><strong>Weight Reduced:</strong> <span id="resultWeightReduced">-</span>g</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="resetMedicationUI()">Start New Medication Session</button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="section-title">Current Session Medication Records</h6>
                    <div id="consumptionLogThisSession" class="log-box" style="max-height: 100px;">
                        <p class="small-text text-center">No medication records yet</p>
                    </div>
                </div>
                 <p class="small-text mt-1" id="medicationStageNoActiveMedInfo">Please select a medication to operate on from the Medication Management section.</p>
            </div>
        </div>
        <div id="stageResetContent" class="section card">
            <div class="card-header bg-light text-dark">Stage: Resetting</div>
            <div class="card-body"><p>System is resetting... Arduino will clear its weight and medication state.</p></div>
        </div>
        
        <div class="card"><div class="card-header">Operation Log (Global)</div><div class="card-body"><div id="logBox" class="log-box"></div></div></div>
    </div>

<script>
    // --- Global Variables ---
    let currentIsSimulationGlobal = true; 
    let pcActiveMedicationNameGlobal = null; 
    let arduinoRawStateGlobal = {}; 
    let pc_managed_medication_details = {}; // Ensure this global variable is initialized
    let consumptionLogEntries = []; 
    // Added: Record lid open/close state for change logs
    let lastLidOpenState = null; 
    // Added: Real-time medication weight reduction measurement timer
    let consumptionUpdateInterval = null;
    // Flag to disable measurement logs after completion
    window.disableMeasurementLogs = false;

    // Add explicit Tab switching function
    function showTab(tabPaneId, tabButton) {
        console.log(`Showing tab: ${tabPaneId}`);
        
        // Remove all active classes
        const navPills = tabButton.closest('.nav-pills');
        navPills.querySelectorAll('.nav-link').forEach(el => {
            el.classList.remove('active');
            el.setAttribute('aria-selected', 'false');
        });
        
        // Remove all tab-pane active classes
        const tabContent = document.getElementById(tabButton.getAttribute('aria-controls')).closest('.tab-content');
        tabContent.querySelectorAll('.tab-pane').forEach(el => {
            el.classList.remove('show', 'active');
        });
        
        // Add active class to current button and panel
        tabButton.classList.add('active');
        tabButton.setAttribute('aria-selected', 'true');
        
        const tabPane = document.getElementById(tabPaneId);
        if(tabPane) {
            tabPane.classList.add('show', 'active');
            addLog(`Switching to tab: ${tabButton.textContent}`, "info");
        }
    }

    // --- Utility Functions ---
    function addLog(message, type = 'info') {
        const logContainer = document.getElementById('logBox');
        if (!logContainer) return;
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${type}`;
        logEntry.innerHTML = `
            <span class="log-time">[${timeStr}]</span>
            <span class="log-message">${message}</span>
        `;
        
        logContainer.insertBefore(logEntry, logContainer.firstChild);
        
        // Keep only the latest 100 entries
        while (logContainer.children.length > 100) {
            logContainer.removeChild(logContainer.lastChild);
        }
        
        // Auto-scroll to the latest entry
        logContainer.scrollTop = 0;
    }
     function addConsumptionLogEntry(medicationName, count, weightReduced) {
        // Try table output first
        const logTable = document.getElementById('consumptionLogTable');
        if (logTable) {
            const tbody = logTable.querySelector('tbody');
            if (!tbody) return;
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            const dateStr = now.toLocaleDateString();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${dateStr}</td>
                <td>${timeStr}</td>
                <td>${medicationName}</td>
                <td>${count}</td>
                <td>${weightReduced ? weightReduced.toFixed(2) + 'g' : '-'}</td>
            `;
            tbody.insertBefore(row, tbody.firstChild);
            while (tbody.children.length > 50) tbody.removeChild(tbody.lastChild);
            return;
        }
        // Fallback to session log div
        const container = document.getElementById('consumptionLogThisSession');
        if (!container) return;
        // Remove placeholder
        if (container.children.length === 1 && container.firstChild.tagName === 'P') {
            container.innerHTML = '';
        }
        const entry = document.createElement('div');
        entry.className = 'consumption-log-entry';
        const wrText = (typeof weightReduced === 'number') ? weightReduced.toFixed(2) + 'g' : '-';
        entry.textContent = `${medicationName}: ${count} pills, weight reduced: ${wrText}`;
        container.appendChild(entry);
        // Keep only latest 50 entries
        while (container.children.length > 50) container.removeChild(container.firstChild);
    }

    // --- Status Fetching Functions ---
    let lastStatusFetch = null;
    let statusFetchPromise = null;
    let consecutiveErrors = 0;

    function fetchStatus() {
        // If there is a previous status fetch Promise still in progress, return it
        if (statusFetchPromise) {
            return statusFetchPromise;
        }
        
        // Record request timestamp
        const now = Date.now();
        
        // Create new status fetch request
        statusFetchPromise = fetch('/get_status')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Clear error counter as request succeeded
                consecutiveErrors = 0;
                
                // Update global variables
                pcActiveMedicationNameGlobal = data.active_medication_name;
                pc_managed_medication_details = data.managed_medication_details || {};
                
                // Update UI
                updateSummaryInfo();
                
                return data;
            })
            .catch(error => {
                // Increment error count
                consecutiveErrors++;
                
                // If consecutive errors exceed 5 times, show more obvious error
                if (consecutiveErrors >= 5) {
                    addLog(`Failed to fetch status (${consecutiveErrors} times): ${error.message}`, 'error');
                }
                
                // Only log on 5th and 10th error to avoid excessive logging
                if (consecutiveErrors === 5 || consecutiveErrors === 10) {
                    console.error(`Status fetch error (${consecutiveErrors} times):`, error);
                }
                
                // Propagate error up the Promise chain
                throw error;
            })
            .finally(() => {
                // Request completed, clear reference
                statusFetchPromise = null;
                lastStatusFetch = now;
            });
        
        return statusFetchPromise;
    }

    function sendCommand(endpoint, body = {}, method = 'POST', successMessagePrefix = 'Operation') {
        console.log(`Sending command to ${endpoint} with body:`, body);
        addLog(`Sending request to ${endpoint}...`, "info");
        return fetch(endpoint, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: method !== 'GET' ? JSON.stringify(body) : null
        })
        .then(response => {
            if (!response.ok) { 
                return response.json().then(errData => {
                    const errorMessage = errData.message || response.statusText;
                    addLog(`Request failed (${response.status}): ${errorMessage}`, 'error');
                    throw new Error(errorMessage);
                }).catch(() => { 
                    const errorMessage = `HTTP error ${response.status}: ${response.statusText}`;
                    addLog(errorMessage, 'error');
                    throw new Error(errorMessage);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log(`Response from ${endpoint}:`, data);
            if (data.status === 'success') {
                addLog((successMessagePrefix ? successMessagePrefix + ": " : "") + (data.message || 'Success'), 'success');
                if (endpoint.includes('consume_pills')) {
                    if (data.consumed_med && data.consumed_count !== undefined) {
                         addConsumptionLogEntry(data.consumed_med, data.consumed_count, data.weight_reduced_approx);
                    }
                }
                // Actively refresh status to get latest data
                return fetchStatus()
                    .then(() => data)
                    .catch(error => {
                        console.error("Error calling fetchStatus:", error);
                        addLog("Failed to get latest status, but operation may have succeeded", "warn");
                        return data;
                    });
            } else {
                const errorMessage = (successMessagePrefix ? successMessagePrefix + " failed: " : "Failed: ") + (data.message || 'Unknown error');
                addLog(errorMessage, 'error');
                throw new Error(errorMessage);
            }
        })
        .catch(error => {
            console.error(`Error sending command to ${endpoint}:`, error);
            addLog(`Command send error (${endpoint}): ${error.message || String(error)}`, 'error');
            return Promise.reject(error);
        });
    }

    // --- Global Control ---
    function setMode(modeName) { 
        console.log("setMode called with:", modeName); 
        addLog(`Switching to ${modeName === 'simulation' ? 'Simulation' : 'Real'} Mode...`, "info");
        
        // Update UI style immediately for instant feedback
        const modeIndicator = document.getElementById('modeIndicator');
        if (modeIndicator) {
            modeIndicator.textContent = modeName === 'simulation' ? 'Simulation Mode' : 'Real Mode';
            modeIndicator.className = `mode-indicator mode-${modeName}`;
        }
        
        sendCommand(`/set_mode/${modeName}`, {}, 'POST', `Switching to ${modeName} Mode`);
    }
    function setStage(stageId) { 
        console.log("setStage called with:", stageId);
        
        if(stageId === 2) { // Reset system
            if(!confirm("Warning: This will reset the entire system and clear all medication data! Are you sure you want to continue?")) {
                return;
            }
            addLog("Resetting system...", "warn");
        }
        
        sendCommand(`/set_stage/${stageId}`, {}, 'POST', `Switching to Stage ID ${stageId}`)
            .then(data => {
                if(data.status === 'success') {
                    if(stageId === 1) { 
                        consumptionLogEntries = []; 
                        const consumptionLogDiv = document.getElementById('consumptionLogThisSession');
                        if (consumptionLogDiv) consumptionLogDiv.innerHTML = '<p class="small-text text-center">No medication records yet</p>';
                    } else if(stageId === 2) { // Reset system
                        // Clear all UI states
                        resetMedicationUI();
                        
                        // Clear medication selection dropdown
                        const medicationToTakeSelect = document.getElementById('medicationToTakeSelect');
                        if(medicationToTakeSelect) {
                            while(medicationToTakeSelect.options.length > 1) {
                                medicationToTakeSelect.remove(1);
                            }
                        }
                        
                        // Clear medication table
                        const pcManagedTableBody = document.getElementById('pcManagedMedicationsTable');
                        if(pcManagedTableBody) {
                            pcManagedTableBody.innerHTML = '<tr><td colspan="4" class="text-center small-text">No medications defined on PC</td></tr>';
                        }
                        
                        const knownMedsClickableTable = document.getElementById('knownMedicationsClickableTableBody');
                        if(knownMedsClickableTable) {
                            knownMedsClickableTable.innerHTML = '<tr><td colspan="4" class="text-center small-text">Please add a medication first</td></tr>';
                        }
                        
                        addLog("System has been completely reset, all data cleared", "success");
                        
                        // Force refresh status
                        setTimeout(fetchStatus, 500);
                    }
                }
            });
    }

    // --- Medication Definition & WPP (Section 1) ---
    function addOrUpdateKnownMedication() {
        console.log("addOrUpdateKnownMedication called");
        const nameEl = document.getElementById('newMedNameInput');
        if (!nameEl) { console.error("Medication input element not found"); return; }

        const name = nameEl.value.trim();
        if (!name) { addLog("Medication name cannot be empty.", "error"); return; }
        
        sendCommand('/add_or_update_known_medication', { name: name, wpp: 0.0 }, 'POST', 'Add/Update PC Medication List')
            .then(() => {
                nameEl.value = '';
                // 添加成功后自动刷新状态
                fetchStatus();
            });
    }

    function tareArduinoForMeasurement() { 
        console.log("tareArduinoForMeasurement called");
        sendCommand('/tare_arduino_sim_only', {}, 'POST', `Tare Arduino for Measurement`);
    }

    // --- 顺序服药流程函数 ---
    function startMedicationSession() {
        const select = document.getElementById('medicationToTakeSelect');
        const medicationName = select.value;
        if (!medicationName) {
            addLog("Please select a medication to take first", "error");
            return;
        }

        addLog(`Starting medication session for '${medicationName}'...`, "info");
        sendCommand('/start_medication_session', { medication_name: medicationName }, 'POST', `Start Medication Session`)
            .then(data => {
                if (data.status === 'success') {
                    // 更新UI到步骤2
                    moveToMedicationStep(2);
                    
                    // 更新会话状态显示
                    updateSessionStatus(true, `Medication session in progress for '${medicationName}'`);
                    
                    // 显示当前药物和初始重量
                    const medNameEl = document.getElementById('currentSessionMedName');
                    const startWeightEl = document.getElementById('sessionStartWeight');
                    if (medNameEl) medNameEl.textContent = medicationName;
                    if (startWeightEl) startWeightEl.textContent = `${data.session_data.start_weight.toFixed(2)}g`;
                }
            });
    }

    function unlockMedicationCompartment() {
        addLog("Unlocking medication compartment...", "info");
        sendCommand('/unlock_medication_compartment', {}, 'POST', `Unlock Medication Compartment`)
            .then(data => {
                if (data.status === 'success') {
                    // 更新UI到步骤3
                    moveToMedicationStep(3);
                    
                    // 更新会话状态
                    updateSessionStatus(true, `Compartment unlocked, please take out '${data.session_data.current_medication}' medication`);
                }
            });
    }

    /**
     * 测量当前减少重量并估算服用数量（直接使用去皮后的原始重量绝对值）
     */
    function measureConsumption() {
        // 获取 Arduino 缓存的当前重量，避免串口冲突导致超时
        fetch('/get_current_weight')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success' && data.weight !== undefined) {
                    const currentWeight = parseFloat(data.weight) || 0;
                    // 直接用绝对值作为消耗重量
                    const weightReduced = Math.abs(currentWeight);
                    const weightReducedEl = document.getElementById('measuredWeightReduced');
                    const pillCountEl = document.getElementById('measuredPillCount');
                    if (weightReducedEl) weightReducedEl.textContent = weightReduced.toFixed(2);
                    const details = pc_managed_medication_details[pcActiveMedicationNameGlobal] || {};
                    const wpp = parseFloat(details.wpp) || 0;
                    const pillCount = wpp > 0 ? Math.round(weightReduced / wpp) : 0;
                    if (pillCountEl) pillCountEl.textContent = pillCount;
                    if (!window.disableMeasurementLogs) {
                        addLog(`Measured weight reduction: ${weightReduced.toFixed(2)}g, estimated consumption: ${pillCount} pills`, 'info');
                    }
                } else {
                    addLog('Failed to measure weight reduction: invalid data', 'error');
                }
            })
            .catch(error => {
                console.error('Failed to measure weight reduction:', error);
                addLog('Error measuring weight reduction', 'error');
            });
    }

    function lockAndRecordConsumption() {
        // Disable measurement logs after completing medication
        window.disableMeasurementLogs = true;
        // 在模拟模式下，直接使用模拟消费功能
        if (currentIsSimulationGlobal) {
            addLog("In simulation mode, using weight reduction function for medication", "info");
            consumePillsBySimulatedWeight();
            return;
        }
        // 实时模式下，获取当前重量并锁定记录
        addLog("Fetching current weight for latest data...", "info");
        fetch('/get_current_weight')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog('Weight fetched successfully', 'success');
                } else {
                    addLog(`Failed to fetch weight: ${data.message || 'Unknown error'}`, 'error');
                }
            })
            .catch(err => {
                console.error('Error fetching weight:', err);
                addLog('Error fetching weight request', 'error');
            })
            .finally(() => {
                addLog("Locking compartment and recording medication consumption...", "info");
                sendCommand('/lock_and_record_consumption', {}, 'POST', `Complete Medication and Record`)
                    .then(data => {
                        if (data.status === 'success') {
                            updateSessionStatus(false, `Medication session completed`);
                            showMedicationResult(data.completed_session);
                        }
                    });
            });
    }

    function cancelMedicationSession() {
        if (!confirm("Are you sure you want to cancel the current medication session?")) {
            return;
        }
        
        addLog("Canceling medication session...", "info");
        sendCommand('/cancel_medication_session', {}, 'POST', `Cancel Medication Session`)
            .then(data => {
                if (data.status === 'success') {
                    // 重置UI
                    resetMedicationUI();
                    addLog("Medication session cancelled", "warn");
                }
            });
    }

    function updateSessionStatus(isActive, statusText) {
        const statusEl = document.getElementById('medicationSessionStatus');
        const statusTextEl = document.getElementById('sessionStatusText');
        
        if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.className = isActive ? 'alert alert-info' : 'alert alert-secondary';
        }
        
        if (statusTextEl) {
            statusTextEl.textContent = statusText || (isActive ? 'In Progress' : 'Not Started');
        }
    }

    function moveToMedicationStep(stepNumber) {
        // 隐藏所有步骤
        document.querySelectorAll('.step-content').forEach(el => {
            el.style.display = 'none';
        });
        
        // 重置所有步骤圆圈样式
        for (let i = 1; i <= 3; i++) {
            const stepCircle = document.getElementById(`stepCircle${i}`);
            if (stepCircle) {
                stepCircle.style.backgroundColor = i <= stepNumber ? '#007bff' : '#6c757d';
            }
        }
        
        // 显示当前步骤
        const currentStep = document.getElementById(`medicationStep${stepNumber}`);
        if (currentStep) {
            currentStep.style.display = 'block';
        }
        
        // 隐藏结果区域
        const resultEl = document.getElementById('medicationResult');
        if (resultEl) {
            resultEl.style.display = 'none';
        }
        
        // 新增：进入步骤3时开启实时测量减少重量，并在离开时停止
        if (stepNumber === 3) {
            if (!consumptionUpdateInterval) {
                consumptionUpdateInterval = setInterval(measureConsumption, 200);
            }
        } else {
            if (consumptionUpdateInterval) {
                clearInterval(consumptionUpdateInterval);
                consumptionUpdateInterval = null;
            }
        }
    }

    function showMedicationResult(sessionData) {
        // 清除实时测量减少重量定时器，避免在结果页继续测量
        if (consumptionUpdateInterval) {
            clearInterval(consumptionUpdateInterval);
            consumptionUpdateInterval = null;
        }
        // 隐藏所有步骤
        document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
        
        // 更新结果信息
        document.getElementById('resultMedName').textContent = sessionData.current_medication || '-';
        document.getElementById('resultPillCount').textContent = sessionData.pills_consumed || '0';
        document.getElementById('resultStartWeight').textContent = sessionData.start_weight.toFixed(2);
        document.getElementById('resultWeightReduced').textContent = sessionData.weight_consumed.toFixed(2);
        
        // 显示结果区域
        const resultEl = document.getElementById('medicationResult');
        if (resultEl) {
            resultEl.style.display = 'block';
        }
        // 将本次服药记录添加到日志
        addConsumptionLogEntry(sessionData.current_medication, sessionData.pills_consumed, sessionData.weight_consumed);
    }

    function resetMedicationUI() {
        // 重置为步骤1
        moveToMedicationStep(1);
        
        // 重置会话状态
        updateSessionStatus(false, 'Not Started');
        
        // 清空选择框
        const select = document.getElementById('medicationToTakeSelect');
        if (select) {
            select.selectedIndex = 0;
        }
    }

    // --- WPP测量步骤式UI函数 ---
    function moveToWppStep(stepNumber, mode) {
        console.log(`Moving to WPP step ${stepNumber}, mode=${mode}`);
        
        // 在进入步骤5之前，检查WPP是否已正确设置
        if (stepNumber === 5) {
            const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
            if (!details || !details.wpp || details.wpp <= 0.0001) {
                addLog("Warning: WPP not properly set, will use real-time weight for temporary calculation", "warn");
                // 在真实模式下，我们只发出警告，但不使用模拟接口
                if (!currentIsSimulationGlobal) {
                    addLog("In real mode, please ensure WPP has been properly measured and set through Arduino", "warn");
                }
                // 允许继续，但在模拟模式下使用实时重量作为临时WPP
                else if (arduinoRawStateGlobal.total_weight_in_box_arduino !== undefined) {
                    const tempWPP = parseFloat(arduinoRawStateGlobal.total_weight_in_box_arduino);
                    if (tempWPP > 0) {
                        sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: tempWPP }, 'POST', `Set Temporary WPP to ${tempWPP.toFixed(2)}g`)
                            .then(data => {
                                if (data.status === 'success') {
                                    addLog(`Temporary WPP set to ${tempWPP.toFixed(2)}g`, "info");
                                }
                            });
                    }
                }
            }
        }
        
        // 隐藏所有WPP步骤内容
        document.querySelectorAll('.wpp-step-content').forEach(el => {
            el.style.display = 'none';
        });
        
        // 重置所有步骤圆圈样式
        for (let i = 1; i <= 6; i++) {
            const stepCircle = document.getElementById(`wppStepCircle${i}`);
            if (stepCircle) {
                stepCircle.style.backgroundColor = i <= stepNumber ? '#007bff' : '#6c757d';
            }
        }
        
        // 确保wppSettingSectionForActiveMed显示
        const wppSettingSection = document.getElementById('wppSettingSectionForActiveMed');
        if (wppSettingSection) {
            wppSettingSection.style.display = 'block';
        }
        
        // 根据步骤号显示对应内容
        if (stepNumber === 4) {
            const step4El = document.getElementById('wppStep4');
            if (step4El) {
                step4El.style.display = 'block';
                // 强制刷新数据
                fetchStatus();
                // 更新确认信息
                setTimeout(function() {
                    document.getElementById('wppConfirmMedName').textContent = pcActiveMedicationNameGlobal || '-';
                    const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
                    if (details && details.wpp) {
                        document.getElementById('wppConfirmValue').textContent = details.wpp.toFixed(3);
                    } else {
                        document.getElementById('wppConfirmValue').textContent = '-';
                    }
                    
                    // 在真实模式下，显示实时重量
                    if (!currentIsSimulationGlobal) {
                        const realTimeWeightContainer = document.getElementById('realTimeWeightContainer');
                        if (realTimeWeightContainer) {
                            realTimeWeightContainer.style.display = 'block';
                            // 开始实时重量监测
                            startRealTimeWeightMeasurement();
                        }
                    }
                }, 300);
            }
        } else if (stepNumber === 5) {
            const step5El = document.getElementById('wppStep5');
            if (step5El) {
                step5El.style.display = 'block';
                
                // 根据模式显示或隐藏控件
                const simControls = document.getElementById('weighingSimModeOnlyControls');
                const realModeInfo = document.getElementById('weighingRealModeInfoForInventory');
                
                if (simControls && realModeInfo) {
                    if (currentIsSimulationGlobal) {
                        simControls.style.display = 'block';
                        realModeInfo.style.display = 'none';
                    } else {
                        simControls.style.display = 'none';
                        realModeInfo.style.display = 'block';
                        
                        // 在真实模式下，自动开始测量总重
                        startRealTimeWeightMeasurement();
                    }
                }
            }
        } else if (stepNumber === 1) {
            const step1El = document.getElementById('wppStep1');
            if (step1El) step1El.style.display = 'block';
        } else if (stepNumber === 2) {
            const step2El = document.getElementById('wppStep2');
            if (step2El) {
                step2El.style.display = 'block';
                console.log("显示步骤2:", step2El);
            } else {
                console.error("Step 2 element does not exist!");
                addLog("UI error: Step 2 element does not exist", "error");
            }
        } else if (stepNumber === 3 && mode) {
            const step3El = document.getElementById(`wppStep3-${mode}`);
            if (step3El) {
                step3El.style.display = 'block';
                // 为"真实/模拟环境"测量模式设置正确的UI
                if (mode === 'real') {
                    // 显示或隐藏模拟输入容器
                    const simulatedInputContainer = document.getElementById('simulatedWPPInputContainer');
                    if (simulatedInputContainer) {
                        simulatedInputContainer.style.display = currentIsSimulationGlobal ? 'block' : 'none';
                    }
                    
                    // 在真实模式下显示实时重量区域
                    const realTimeWeightContainerInStep3 = document.getElementById('realTimeWeightContainerInStep3');
                    if (realTimeWeightContainerInStep3 && !currentIsSimulationGlobal) {
                        realTimeWeightContainerInStep3.style.display = 'block';
                        
                        // 开始实时重量监测，并更新步骤3的实时重量显示
                        if (!window.step3WeightUpdateInterval) {
                            // 添加错误计数和最后成功时间
                            window.weightUpdateErrorCount = 0;
                            window.lastSuccessfulWeightUpdate = Date.now();
                            
                            window.step3WeightUpdateInterval = setInterval(() => {
                                fetch('/get_current_weight')
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log("Got real-time weight data:", data);
                                        
                                        // 检查返回的状态
                                        if (data.status === 'error') {
                                            console.error("Error getting weight:", data.message);
                                            window.weightUpdateErrorCount++;
                                            
                                            // 显示错误状态
                                            const weightValueEl = document.getElementById('realTimeWeightValueInStep3');
                                            if (weightValueEl) {
                                                weightValueEl.textContent = "Read Error";
                                                weightValueEl.classList.add('text-danger');
                                            }
                                            return;
                                        }
                                        
                                        // 检查数据是否过期
                                        if (data.age && data.age > 10) {
                                            console.warn(`Weight data may be outdated (${data.age.toFixed(1)} seconds)`);
                                            const weightValueEl = document.getElementById('realTimeWeightValueInStep3');
                                            if (weightValueEl) {
                                                weightValueEl.textContent = parseFloat(data.weight).toFixed(2) + " (old data)";
                                                weightValueEl.classList.add('text-warning');
                                            }
                                            return;
                                        }
                                        
                                        if (data.weight !== undefined) {
                                            // 重置错误计数
                                            window.weightUpdateErrorCount = 0;
                                            window.lastSuccessfulWeightUpdate = Date.now();
                                            
                                            const weight = parseFloat(data.weight);
                                            const weightValueEl = document.getElementById('realTimeWeightValueInStep3');
                                            if (weightValueEl) {
                                                weightValueEl.textContent = weight.toFixed(2);
                                                console.log("Updating real-time weight display:", weight.toFixed(2));
                                                
                                                // 添加重量变化视觉反馈
                                                if (weight > 0.01) {
                                                    weightValueEl.classList.add('text-success');
                                                    weightValueEl.classList.remove('text-danger', 'text-warning');
                    } else {
                                                    weightValueEl.classList.add('text-danger');
                                                    weightValueEl.classList.remove('text-success', 'text-warning');
                                                }
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        console.error("Failed to get weight:", error);
                                        window.weightUpdateErrorCount++;
                                        
                                        // 检查是否需要显示连接问题警告
                                        if (window.weightUpdateErrorCount >= 3) {
                                            const weightValueEl = document.getElementById('realTimeWeightValueInStep3');
                                            if (weightValueEl) {
                                                weightValueEl.textContent = "Connection Issue";
                                                weightValueEl.classList.add('text-danger');
                                                weightValueEl.classList.remove('text-success', 'text-warning');
                                            }
                                            
                                            // 如果连续失败太多次，减慢请求频率
                                            if (window.weightUpdateErrorCount > 10) {
                                                clearInterval(window.step3WeightUpdateInterval);
                                                window.step3WeightUpdateInterval = setInterval(() => {
                                                    // 完整的重量获取代码
                                                    fetch('/get_current_weight')
                                                        .then(response => response.json())
                                                        .then(data => {
                                                            // 重置错误计数器
                                                            if (data.status === 'success' && data.weight !== undefined) {
                                                                window.weightUpdateErrorCount = 0;
                                                                const weightValueEl = document.getElementById('realTimeWeightValueInStep3');
                                                                if (weightValueEl) {
                                                                    const weight = parseFloat(data.weight);
                                                                    weightValueEl.textContent = weight.toFixed(2);
                                                                    weightValueEl.classList.remove('text-danger');
                                                                    weightValueEl.classList.add('text-success');
                                                                    console.log("Connection restored, weight update normal");
                                                                }
                                                            }
                                                        })
                                                        .catch(error => {
                                                            console.error("Still failed to get weight after reconnection:", error);
                                                        });
                                                }, 2000); // 增加到2秒一次
                                                console.log("Due to consecutive errors, slowing down weight update frequency");
                                            }
                                        }
                                    });
                            }, 500); // 更新频率改为500ms，更快地反馈重量变化
                        }
                    }
                }
            }
        } else if (stepNumber === 6) {
            const step6El = document.getElementById('wppStep6');
            if (step6El) {
                step6El.style.display = 'block';
                // 强制刷新数据
                fetchStatus();
                setTimeout(function() {
                    const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
                    if (details) {
                        document.getElementById('summaryMedName').textContent = pcActiveMedicationNameGlobal;
                        document.getElementById('summaryWPP').textContent = details.wpp ? details.wpp.toFixed(3) : '-';
                        document.getElementById('summaryCount').textContent = details.count_in_box !== undefined ? details.count_in_box : '-';
                        document.getElementById('summaryTotalWeight').textContent = details.total_weight_in_box ? details.total_weight_in_box.toFixed(2) : '-';
                    } else {
                        document.getElementById('summaryMedName').textContent = '-';
                        document.getElementById('summaryWPP').textContent = '-';
                        document.getElementById('summaryCount').textContent = '-';
                        document.getElementById('summaryTotalWeight').textContent = '-';
                    }
                }, 300);
            }
        }
        
        // 如果离开步骤3，清除步骤3的实时重量更新定时器
        if (stepNumber !== 3 && window.step3WeightUpdateInterval) {
            clearInterval(window.step3WeightUpdateInterval);
            window.step3WeightUpdateInterval = null;
        }
        
        addLog(`WPP Measurement: Enter Step ${stepNumber}${mode ? ` (${mode === 'simulated' ? 'Simulated' : 'Real'} Mode)` : ''}`, "info");
    }

    // 添加实时重量测量函数
    function startRealTimeWeightMeasurement() {
        if (!currentIsSimulationGlobal) {
            addLog("Starting real-time total weight measurement...", "info");
            // 显示实时重量显示区域
            const realTimeWeightContainer = document.getElementById('realTimeWeightContainer');
            if (realTimeWeightContainer) {
                realTimeWeightContainer.style.display = 'block';
            }
            
            // 清除之前可能存在的定时器
            if (window.currentWeightUpdateInterval) {
                clearInterval(window.currentWeightUpdateInterval);
            }
            
            // 创建错误计数器
            window.weightUpdateErrorCount = 0;
            
            // 每1000ms更新一次重量显示，减少请求频率
            const weightUpdateInterval = setInterval(() => {
                // 每次新的请求前检查是否有太多错误
                if (window.weightUpdateErrorCount > 10) {
                    addLog("Stopping automatic weight updates due to connection issues", "warn");
                    clearInterval(weightUpdateInterval);
                    
                    // 添加手动刷新按钮
                    const realTimeWeightContainer = document.getElementById('realTimeWeightContainer');
                    if (realTimeWeightContainer) {
                        const refreshBtn = document.createElement('button');
                        refreshBtn.className = 'btn btn-sm btn-outline-secondary mt-2';
                        refreshBtn.textContent = 'Manually Refresh Weight';
                        refreshBtn.onclick = function() {
                            fetchStatus()
            .then(() => {
                                    addLog("Manual weight refresh successful", "success");
                                })
                                .catch(() => {
                                    addLog("Manual weight refresh failed", "error");
                                });
                        };
                        realTimeWeightContainer.appendChild(refreshBtn);
                    }
                    return;
                }
                
                // 使用缓存接口获取重量，避免串口冲突导致超时
                fetch('/get_current_weight')
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success' && data.weight !== undefined) {
                            const realTimeWeightValue = document.getElementById('realTimeWeightValueInStep3');
                            if (realTimeWeightValue) {
                                realTimeWeightValue.textContent = parseFloat(data.weight).toFixed(2);
                            }
                            window.weightUpdateErrorCount = 0;
                        }
                    })
                    .catch(error => {
                        console.error("获取重量失败:", error);
                        window.weightUpdateErrorCount++;
                    });
            }, 2000); // 调整为2秒一次，减少请求频率
            
            // 存储interval ID以便后续清除
            window.currentWeightUpdateInterval = weightUpdateInterval;
            
            // 在真实模式下，添加一个按钮让用户手动完成步骤
            const step5El = document.getElementById('wppStep5');
            if (step5El) {
                // 检查是否已经添加了完成按钮
                let completeRealModeBtn = document.getElementById('completeRealModeBtn');
                if (!completeRealModeBtn) {
                    completeRealModeBtn = document.createElement('button');
                    completeRealModeBtn.id = 'completeRealModeBtn';
                    completeRealModeBtn.className = 'btn btn-success btn-sm mt-3';
                    completeRealModeBtn.textContent = 'Confirm Real-Time Weight and Complete Setup';
                    completeRealModeBtn.onclick = function() {
                        // 直接移动到步骤6，不调用模拟接口
                        if (window.currentWeightUpdateInterval) {
                            clearInterval(window.currentWeightUpdateInterval);
                        }
                        
                        // 即使无法获取最新状态，也允许继续
                        fetchStatus()
                            .then(() => {
                                setTimeout(() => {
                                    moveToWppStep(6);
                                    updateSummaryInfo();
                }, 500);
            })
                            .catch(() => {
                                // 即使状态获取失败，也继续流程
                                addLog("Unable to refresh status, but will continue with setup", "warn");
                                setTimeout(() => {
                                    moveToWppStep(6);
                                    updateSummaryInfo();
                                }, 500);
                            });
                    };
                    
                    // 找到合适的位置添加按钮
                    const realModeInfoEl = document.getElementById('weighingRealModeInfoForInventory');
                    if (realModeInfoEl) {
                        realModeInfoEl.after(completeRealModeBtn);
                        realModeInfoEl.style.display = 'block';
                    } else {
                        step5El.appendChild(completeRealModeBtn);
                    }
                }
            }
        }
    }

    // 添加使用实时重量更新库存的函数
    function setInventoryByRealTimeWeight(weight) {
        if (!pcActiveMedicationNameGlobal) {
            addLog("Please select a medication first", "error");
            return;
        }
        
        // 在真实模式下，不应该调用模拟接口
        if (!currentIsSimulationGlobal) {
            addLog(`In real mode, the pillbox total weight and count are determined by actual sensor readings, no manual update needed`, "info");
            
            // 直接获取最新数据并进入完成步骤
            fetchStatus().then(() => {
                setTimeout(() => {
                    moveToWppStep(6);
                    updateSummaryInfo();
                }, 500);
            });
            
            return;
        }
        
        // 在模拟模式下继续使用模拟接口
        addLog(`Updating '${pcActiveMedicationNameGlobal}' inventory using real-time weight ${weight.toFixed(2)}g...`, "info");
        
        sendCommand('/set_simulated_total_weight_for_active_med', { weight: weight }, 'POST', `Update '${pcActiveMedicationNameGlobal}' inventory via real-time weight`)
                .then(data => {
                if (data && data.status === 'success') {
                    addLog(`Inventory updated successfully, proceeding to completion step...`, "success");
                            fetchStatus().then(() => {
                        setTimeout(() => {
                            moveToWppStep(6);
                            updateSummaryInfo();
                        }, 500);
                    });
                }
            });
    }

    // --- Weighing Stage: Update Inventory for Active Med (Section 2) ---
    function setInventoryBySimulatedBatchWeight() { 
        console.log("setInventoryBySimulatedBatchWeight called");
        if (!currentIsSimulationGlobal) { addLog("This feature is only available in simulation mode.", "warn"); return; }
        if (!pcActiveMedicationNameGlobal) { addLog("Please select a medication first.", "error"); return; }
        const inputEl = document.getElementById('simBatchTotalWeightInput');
        if (!inputEl) { console.error("simBatchTotalWeightInput not found"); return; }
        const weightStr = inputEl.value;
        if (weightStr === "" || isNaN(parseFloat(weightStr)) || parseFloat(weightStr) < 0) { 
            addLog("Please enter a valid simulated total weight (non-negative number).", "error"); return; 
        }
        
        const weight = parseFloat(weightStr);
        addLog(`Updating '${pcActiveMedicationNameGlobal}' inventory via total weight ${weight}g...`, "info");
        
        sendCommand('/set_simulated_total_weight_for_active_med', { weight: weight }, 'POST', `Update '${pcActiveMedicationNameGlobal}' inventory via total weight`)
            .then(data => {
                if(data && data.status === 'success') {
                    inputEl.value = '';
                    
                    addLog(`Refreshing data and proceeding to completion step...`, "info");
                    
                    // Ensure we have the latest data before proceeding
                    fetchStatus().then(() => {
                        // Get and output latest data again for debugging
                        console.log("Latest medication data:", pc_managed_medication_details);
                        if(pcActiveMedicationNameGlobal && pc_managed_medication_details[pcActiveMedicationNameGlobal]) {
                            console.log("Current medication details:", pc_managed_medication_details[pcActiveMedicationNameGlobal]);
                        }
                        
                        setTimeout(() => {
                            moveToWppStep(6);
                            updateSummaryInfo();  // Extra call to update summary info
                        }, 500);
                    });
                }
            });
    }

    function setInventoryByManualPillCount() {
        console.log("setInventoryByManualPillCount called");
        if (!pcActiveMedicationNameGlobal) { addLog("Please select a medication first.", "error"); return; }
        const inputEl = document.getElementById('inventoryManualPillCountInput');
        if (!inputEl) { console.error("inventoryManualPillCountInput not found"); return; }
        const countStr = inputEl.value;
        if (countStr === "" || isNaN(parseInt(countStr)) || parseInt(countStr) < 0) {
            addLog("Please enter a valid pill count (non-negative integer).", "error"); return;
        }
        
        const count = parseInt(countStr);
        addLog(`Updating "${pcActiveMedicationNameGlobal}" inventory with manual count of ${count} pills...`, "info");
        
        sendCommand('/update_state_from_manual_count_for_active_med', { count: count }, 'POST', `Update '${pcActiveMedicationNameGlobal}' inventory via count`)
            .then(data => {
                if(data && data.status === 'success') {
                    inputEl.value = '';
                    
                    addLog(`Refreshing data and proceeding to completion step...`, "info");
                    
                    // Ensure we have the latest data before proceeding
                    fetchStatus().then(() => {
                        // Get and output latest data again for debugging
                        console.log("Latest medication data:", pc_managed_medication_details);
                        if(pcActiveMedicationNameGlobal && pc_managed_medication_details[pcActiveMedicationNameGlobal]) {
                            console.log("Current medication details:", pc_managed_medication_details[pcActiveMedicationNameGlobal]);
                        }
                        
                        setTimeout(() => {
                            moveToWppStep(6);
                            updateSummaryInfo();  // Extra call to update summary info
                        }, 500);
                    });
                }
            });
    }

    // --- Medication Stage ---
    function consumePillsForActiveMedPC() {
        console.log("consumePillsForActiveMedPC called");
        if (!pcActiveMedicationNameGlobal) { addLog("Please select a medication to take first.", "error"); return; }
        const inputEl = document.getElementById('pillsToConsumeInput');
        if (!inputEl) { console.error("pillsToConsumeInput not found"); return; }
        const countStr = inputEl.value;
        if (countStr === "" || isNaN(parseInt(countStr)) || parseInt(countStr) <= 0) { addLog("Please enter a valid consumption amount (positive integer).", "error"); return; }
        sendCommand('/consume_pills_for_active_med', { count: parseInt(countStr) }, 'POST', `服用 '${pcActiveMedicationNameGlobal}'`)
            .then(()=> { if(inputEl) inputEl.value = ''; });
    }
    function consumePillsBySimulatedWeight() {
        console.log("consumePillsBySimulatedWeight called");
        if (!currentIsSimulationGlobal) { addLog("Weight reduction function is only available in simulation mode.", "warn"); return; }
        if (!pcActiveMedicationNameGlobal) { addLog("Please select a medication to take first.", "error"); return; }
        const inputEl = document.getElementById('weightToReduceInput');
        if (!inputEl) { console.error("weightToReduceInput not found"); return; }
        const weightStr = inputEl.value;
        if (weightStr === "" || isNaN(parseFloat(weightStr)) || parseFloat(weightStr) <= 0) {
            addLog("Please enter a valid weight reduction (positive number).", "error"); return;
        }
        const weightValue = parseFloat(weightStr);
        sendCommand('/consume_pills_by_weight_simulated', { weight_to_reduce: weightValue }, 'POST', `Consume '${pcActiveMedicationNameGlobal}' by weight`)
            .then(data => {
                if (inputEl) inputEl.value = '';
                // 更新界面显示消费结果
                const weightReducedEl = document.getElementById('measuredWeightReduced');
                const pillCountEl = document.getElementById('measuredPillCount');
                if (weightReducedEl) weightReducedEl.textContent = data.weight_reduced_approx.toFixed(2);
                if (pillCountEl) pillCountEl.textContent = data.consumed_count;
                addLog(`Traditional simulated consumption completed: ${data.consumed_count} pills, weight reduced: ${data.weight_reduced_approx.toFixed(2)}g`, 'success');
                // 刷新状态并更新 PC 表格
                fetchStatus();
            });
    }
    
    // --- PC Active Medication Selection ---
    function setPcActiveMedication(medName) {
        console.log("setPcActiveMedication called with:", medName);
        sendCommand('/set_pc_active_medication', { name: medName }, 'POST', `Set PC active medication to '${medName}'`);
    }

    // --- UI Update Function ---
    function updateUI(data) {
        try { 
            arduinoRawStateGlobal = data.arduino_state || {}; 
            // Important: Update global variables
            pc_managed_medication_details = data.pc_managed_medication_details || {};
            
            console.log("UI update, current medication:", pcActiveMedicationNameGlobal);
            console.log("Medication details data:", pc_managed_medication_details);
            
            const connStatusEl = document.getElementById('connectionStatus');
            const arduinoStage = arduinoRawStateGlobal.stage_name || 'Unknown';
            // Automatically measure weight reduction in Medication stage
            if (arduinoStage === 'Medication') {
                measureConsumption();
            }
            if (connStatusEl) {
                connStatusEl.textContent = (arduinoStage === 'Disconnected' || arduinoStage === 'Initializing' || arduinoStage === 'Unknown') ? arduinoStage : 'Connected';
                connStatusEl.className = (arduinoStage === 'Disconnected' || arduinoStage === 'Initializing' || arduinoStage === 'Unknown') ? 'status-disconnected' : 'status-connected';
            }
            
            currentIsSimulationGlobal = data.is_simulation;
            const modeIndicator = document.getElementById('modeIndicator');
            if (modeIndicator) {
                modeIndicator.textContent = currentIsSimulationGlobal ? 'Simulation Mode' : 'Real Mode';
                modeIndicator.className = `mode-indicator mode-${currentIsSimulationGlobal ? 'simulation' : 'real'}`;
            }
            // Update lid state indicator
            const lidIndicator = document.getElementById('lidIndicator');
            if (lidIndicator) {
                const open = arduinoRawStateGlobal.lid_open;
                lidIndicator.textContent = open ? 'Open' : 'Closed';
                lidIndicator.className = `lid-indicator lid-${open ? 'open' : 'closed'}`;
            }
            // New: Detect lid open/close state changes and log
            if (typeof lastLidOpenState === 'boolean') {
                if (arduinoRawStateGlobal.lid_open !== lastLidOpenState) {
                    addLog(arduinoRawStateGlobal.lid_open ? 'Pillbox lid opened' : 'Pillbox lid closed', arduinoRawStateGlobal.lid_open ? 'success' : 'warn');
                }
            }
            lastLidOpenState = arduinoRawStateGlobal.lid_open;

            const arduinoStageNameEl = document.getElementById('arduinoStageName');
            if (arduinoStageNameEl) arduinoStageNameEl.textContent = arduinoStage;
            
            const arduinoTotalWeightEl = document.getElementById('arduinoTotalWeight');
            if (arduinoTotalWeightEl) arduinoTotalWeightEl.textContent = arduinoRawStateGlobal.total_weight_in_box_arduino !== undefined ? parseFloat(arduinoRawStateGlobal.total_weight_in_box_arduino).toFixed(2) : 'N/A';
            
            const arduinoCurrentMedEl = document.getElementById('arduinoCurrentMed');
            if (arduinoCurrentMedEl) arduinoCurrentMedEl.textContent = arduinoRawStateGlobal.current_med_on_arduino || 'N/A';

            const arduinoCurrentMedWPPEl = document.getElementById('arduinoCurrentMedWPP');
            if (arduinoCurrentMedWPPEl) arduinoCurrentMedWPPEl.textContent = arduinoRawStateGlobal.wpp_arduino_current_med !== undefined ? parseFloat(arduinoRawStateGlobal.wpp_arduino_current_med).toFixed(3) : 'N/A';
            
            const arduinoCurrentMedCountEl = document.getElementById('arduinoCurrentMedCount');
            if (arduinoCurrentMedCountEl) arduinoCurrentMedCountEl.textContent = arduinoRawStateGlobal.pill_count_arduino_current_med !== undefined ? parseInt(arduinoRawStateGlobal.pill_count_arduino_current_med) : 'N/A';
            
            const rawDataEl = document.getElementById('rawData');
            if (rawDataEl) rawDataEl.textContent = arduinoRawStateGlobal.raw_data || 'N/A';
            
            pcActiveMedicationNameGlobal = data.pc_active_medication_name;
            const pcActiveMedDisplayEl = document.getElementById('pcActiveMedicationDisplay');
            if (pcActiveMedDisplayEl) pcActiveMedDisplayEl.textContent = pcActiveMedicationNameGlobal || 'None';
            
            document.querySelectorAll('.current-active-med-name-stage').forEach(el => el.textContent = pcActiveMedicationNameGlobal || 'No Medication Selected');
            document.querySelectorAll('.current-active-med-name-wpp').forEach(el => el.textContent = pcActiveMedicationNameGlobal || 'No Medication Selected');
            
            const pcManagedMeds = data.pc_managed_medication_details || {};
            const pcManagedTableBody = document.getElementById('pcManagedMedicationsTable');
            if (pcManagedTableBody) {
                pcManagedTableBody.innerHTML = '';
                if (Object.keys(pcManagedMeds).length === 0) {
                    pcManagedTableBody.innerHTML = '<tr><td colspan="4" class="text-center small-text">No medications defined on PC</td></tr>';
                } else {
                    for (const medName in pcManagedMeds) {
                        const details = pcManagedMeds[medName];
                        const tr = document.createElement('tr');
                        if (medName === pcActiveMedicationNameGlobal) tr.classList.add('table-active-pc-med');
                        tr.innerHTML = `
                            <td>${medName}</td>
                            <td>${parseFloat(details.wpp).toFixed(3)}</td>
                            <td>${parseFloat(details.total_weight_in_box).toFixed(2)}</td>
                            <td>${parseInt(details.count_in_box)}</td>
                        `;
                        pcManagedTableBody.appendChild(tr);
                    }
                }
            }
            
            const knownMedsClickableTable = document.getElementById('knownMedicationsClickableTableBody');
            if (knownMedsClickableTable) {
                knownMedsClickableTable.innerHTML = '';
                 if (Object.keys(pcManagedMeds).length === 0) {
                    knownMedsClickableTable.innerHTML = '<tr><td colspan="4" class="text-center small-text">Please add a medication first</td></tr>';
                } else {
                    for (const medName in pcManagedMeds) {
                        const details = pcManagedMeds[medName];
                        const tr = document.createElement('tr');
                        if (medName === pcActiveMedicationNameGlobal) tr.classList.add('table-active');
                        tr.innerHTML = `
                            <td style="cursor:pointer;" onclick="setPcActiveMedication('${medName}')">${medName} ${medName === pcActiveMedicationNameGlobal ? '<span class="badge bg-primary ms-1">Active</span>' : ''}</td>
                            <td>${parseFloat(details.wpp).toFixed(3)}</td>
                            <td>${parseFloat(details.total_weight_in_box).toFixed(2)}</td>
                            <td>${parseInt(details.count_in_box)}</td>
                        `;
                        knownMedsClickableTable.appendChild(tr);
                    }
                }
            }

            // 隐藏所有阶段内容
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            
            // 根据当前阶段显示对应内容
            const medManagementCard = document.getElementById('medicationManagementCard');
            if (medManagementCard) {
                // 只在称重或未知阶段显示药物管理卡片
                medManagementCard.style.display = (arduinoStage === 'Weighing' || arduinoStage === 'Unknown' || arduinoStage === 'Initializing') ? 'block' : 'none';
            }
            
            // 根据当前阶段显示对应内容
            if (arduinoStage === 'Weighing') {
                const stageWeighingContentEl = document.getElementById('stageWeighingContent');
                if(stageWeighingContentEl) stageWeighingContentEl.style.display = 'block';
                
                // 隐藏重置阶段内容
                const stageResetContentEl = document.getElementById('stageResetContent');
                if(stageResetContentEl) stageResetContentEl.style.display = 'none';
                
                // 隐藏服药阶段内容
                const stageMedicationContentEl = document.getElementById('stageMedicationContent');
                if(stageMedicationContentEl) stageMedicationContentEl.style.display = 'none';
                
            } else if (arduinoStage === 'Medication') {
                const stageMedicationContentEl = document.getElementById('stageMedicationContent');
                if(stageMedicationContentEl) stageMedicationContentEl.style.display = 'block';
                
                // 隐藏称重阶段内容
                const stageWeighingContentEl = document.getElementById('stageWeighingContent');
                if(stageWeighingContentEl) stageWeighingContentEl.style.display = 'none';
                
                // 隐藏重置阶段内容
                const stageResetContentEl = document.getElementById('stageResetContent');
                if(stageResetContentEl) stageResetContentEl.style.display = 'none';
                
                const medStageArduinoMedNameEl = document.getElementById('medStageArduinoMedName');
                if(medStageArduinoMedNameEl) medStageArduinoMedNameEl.textContent = arduinoRawStateGlobal.current_med_on_arduino || 'N/A';
                
                const medStageArduinoMedCountEl = document.getElementById('medStageArduinoMedCount');
                if(medStageArduinoMedCountEl) medStageArduinoMedCountEl.textContent = arduinoRawStateGlobal.pill_count_arduino_current_med !== undefined ? parseInt(arduinoRawStateGlobal.pill_count_arduino_current_med) : '0';
                
                // 在服药阶段始终显示药物管理流程，隐藏未选药物提示
                const medicationStageActiveMedControlsEl = document.getElementById('medicationStageActiveMedControls');
                if (medicationStageActiveMedControlsEl) medicationStageActiveMedControlsEl.style.display = 'block';
                const medicationStageNoActiveMedInfoEl = document.getElementById('medicationStageNoActiveMedInfo');
                if (medicationStageNoActiveMedInfoEl) medicationStageNoActiveMedInfoEl.style.display = 'none';
                
                const consumeByWeightTabItemEl = document.getElementById('consumeByWeightTabItem');
                if(consumeByWeightTabItemEl) consumeByWeightTabItemEl.style.display = currentIsSimulationGlobal ? 'block' : 'none';
                
                const consumeSimWeightTab = document.getElementById('consume-sim-weight-tab');
                const consumeManualCountTabEl = document.getElementById('consume-manual-count-tab');
                if(!currentIsSimulationGlobal && consumeSimWeightTab && consumeSimWeightTab.classList.contains('active')){
                     if(consumeManualCountTabEl){
                        const consumeManualCountTabInstance = bootstrap.Tab.getInstance(consumeManualCountTabEl) || new bootstrap.Tab(consumeManualCountTabEl);
                        if(consumeManualCountTabInstance) consumeManualCountTabInstance.show();
                     }
                }
            } else if (arduinoStage === 'Resetting') {
                const stageResetContentEl = document.getElementById('stageResetContent');
                if(stageResetContentEl) stageResetContentEl.style.display = 'block';
                
                // 隐藏称重阶段内容
                const stageWeighingContentEl = document.getElementById('stageWeighingContent');
                if(stageWeighingContentEl) stageWeighingContentEl.style.display = 'none';
                
                // 隐藏服药阶段内容
                const stageMedicationContentEl = document.getElementById('stageMedicationContent');
                if(stageMedicationContentEl) stageMedicationContentEl.style.display = 'none';
            }

            // 更新药物选择下拉列表
            const medicationToTakeSelect = document.getElementById('medicationToTakeSelect');
            if (medicationToTakeSelect) {
                // 保存当前选中值
                const currentValue = medicationToTakeSelect.value;
                
                // 清空旧选项（除了第一个）
                while (medicationToTakeSelect.options.length > 1) {
                    medicationToTakeSelect.remove(1);
                }
                
                // 添加药物选项
                for (const medName in pcManagedMeds) {
                    const option = document.createElement('option');
                    option.value = medName;
                    option.textContent = `${medName} (${pcManagedMeds[medName].count_in_box} pills)`;
                    medicationToTakeSelect.appendChild(option);
                }
                
                // 恢复之前的选择（如果存在）
                if (currentValue) {
                    for (let i = 0; i < medicationToTakeSelect.options.length; i++) {
                        if (medicationToTakeSelect.options[i].value === currentValue) {
                            medicationToTakeSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
            }
            
            // 检查并更新会话状态
            fetch('/get_medication_session_status')
                .then(response => response.json())
                .then(sessionData => {
                    if (sessionData.session_active) {
                        const session = sessionData.session_data;
                        
                        // 更新会话状态显示
                        updateSessionStatus(true, `正在进行 '${session.current_medication}' 的服药会话`);
                        
                        // 显示当前药物和初始重量
                        const medNameEl = document.getElementById('currentSessionMedName');
                        const startWeightEl = document.getElementById('sessionStartWeight');
                        if (medNameEl) medNameEl.textContent = session.current_medication;
                        if (startWeightEl) startWeightEl.textContent = `${session.start_weight.toFixed(2)}g`;
                        
                        // 移动到正确的步骤
                        moveToMedicationStep(session.compartment_unlocked ? 3 : 2);
                    }
                })
                .catch(error => {
                    console.error("获取会话状态失败:", error);
                });
                
            // 更新实时重量显示
            const realTimeWeightContainer = document.getElementById('realTimeWeightContainer');
            const realTimeWeightValue = document.getElementById('realTimeWeightValue');
            if (realTimeWeightContainer && realTimeWeightValue) {
                if (!currentIsSimulationGlobal && arduinoRawStateGlobal.total_weight_in_box_arduino !== undefined) {
                    realTimeWeightContainer.style.display = 'block';
                    realTimeWeightValue.textContent = parseFloat(arduinoRawStateGlobal.total_weight_in_box_arduino).toFixed(2);
                    
                    // 只在模拟模式下检测重量稳定并自动更新库存
                    if (currentIsSimulationGlobal && window.lastWeightReadings) {
                        window.lastWeightReadings.push(parseFloat(arduinoRawStateGlobal.total_weight_in_box_arduino));
                        if (window.lastWeightReadings.length > 3) {
                            window.lastWeightReadings.shift();
                        }
                        
                        if (window.lastWeightReadings.length === 3) {
                            const maxDiff = Math.max(...window.lastWeightReadings) - Math.min(...window.lastWeightReadings);
                            if (maxDiff < 0.01) {
                                // 重量稳定，自动更新库存
                                const stableWeight = window.lastWeightReadings.reduce((a, b) => a + b) / 3;
                                setInventoryByRealTimeWeight(stableWeight);
                                // 清除定时器
                                if (window.currentWeightUpdateInterval) {
                                    clearInterval(window.currentWeightUpdateInterval);
                                }
                            }
                        }
                    } else if (currentIsSimulationGlobal) {
                        window.lastWeightReadings = [];
                    }
                } else {
                    realTimeWeightContainer.style.display = 'none';
                }
            }
        } catch (e) {
            console.error("Error in updateUI:", e);
            addLog("UI 更新时发生错误: " + e.message, "error");
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded: Script starting.");
        addLog("Smart Pillbox Controller V6_fix_4 loaded.");
        
        // 初始化WPP步骤UI
        moveToWppStep(1);
        
        // 初始化顺序服药UI（如果已实现moveToMedicationStep函数）
        if(typeof moveToMedicationStep === 'function') {
            moveToMedicationStep(1);
        }
        
        // 获取初始状态并更新UI
        fetchStatus().then(updateUI);
        setInterval(() => fetchStatus().then(updateUI), 200);
        
        // 显式初始化所有Bootstrap Tab组件
        document.querySelectorAll('.nav-pills .nav-link[data-bs-toggle="pill"]').forEach(function(tabEl) {
            // 手动初始化每个tab元素
            new bootstrap.Tab(tabEl);
            
            // 添加额外的点击事件监听，防止Bootstrap事件失效
            tabEl.addEventListener('click', function() {
                const target = document.querySelector(this.dataset.bsTarget);
                if (target) {
                    // 先移除所有active类
                    this.closest('.nav-pills').querySelectorAll('.nav-link').forEach(el => {
                        el.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-pane').forEach(el => {
                        el.classList.remove('show', 'active');
                    });
                    
                    // 添加active类到当前tab和目标面板
                    this.classList.add('active');
                    target.classList.add('show', 'active');
                }
            });
        });
        
        console.log("DOMContentLoaded: Tab initialization completed.");
    });

    function showMedicationSummary() {
        // 隐藏所有WPP步骤内容
        document.querySelectorAll('.wpp-step-content').forEach(el => {
            el.style.display = 'none';
        });
        
        // 更新摘要信息
        const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
        if (details) {
            document.getElementById('summaryMedName').textContent = pcActiveMedicationNameGlobal;
            document.getElementById('summaryWPP').textContent = details.wpp.toFixed(3);
            document.getElementById('summaryCount').textContent = details.count_in_box;
            document.getElementById('summaryTotalWeight').textContent = details.total_weight_in_box.toFixed(2);
        }
        
        // 显示摘要区域
        const summaryEl = document.getElementById('medicationSummary');
        if (summaryEl) {
            summaryEl.style.display = 'block';
        }
        
        addLog(`Setup completed for '${pcActiveMedicationNameGlobal}'`, "success");
    }

    function startNewMedicationSetup() {
        // 重置到步骤1
        moveToWppStep(1);
        
        // 清空当前选中的药物
        setPcActiveMedication(null);
        
        addLog("Preparing to add new medication", "info");
    }

    function completeAllMedicationSetup() {
        // 重置到步骤1
        moveToWppStep(1);
        
        // 清空当前选中的药物
        setPcActiveMedication(null);
        
        addLog("All medication setup completed", "success");
    }

    // 新增函数：更新摘要信息
    function updateSummaryInfo() {
        console.log("Executing updateSummaryInfo, current medication:", pcActiveMedicationNameGlobal);
        console.log("Medication details data:", pc_managed_medication_details);
        
        // Update medication name
        const medNameEl = document.getElementById('currentMedicationName');
        if (medNameEl) {
            medNameEl.textContent = pcActiveMedicationNameGlobal || 'No medication selected';
        }
        
        // Update medication details
        const details = pc_managed_medication_details[pcActiveMedicationNameGlobal] || {};
        const wpp = parseFloat(details.wpp) || 0;
        const totalWeight = parseFloat(details.total_weight) || 0;
        const pillCount = wpp > 0 ? Math.round(totalWeight / wpp) : 0;
        
        // Update weight per pill
        const wppEl = document.getElementById('weightPerPill');
        if (wppEl) {
            wppEl.textContent = wpp.toFixed(2);
        }
        
        // Update total weight
        const totalWeightEl = document.getElementById('totalWeight');
        if (totalWeightEl) {
            totalWeightEl.textContent = totalWeight.toFixed(2);
        }
        
        // Update estimated pill count
        const pillCountEl = document.getElementById('estimatedPillCount');
        if (pillCountEl) {
            pillCountEl.textContent = pillCount;
        }
        
        // Update lid state indicator
        const lidStateEl = document.getElementById('lidState');
        if (lidStateEl) {
            const isLidOpen = details.lid_open === true;
            lidStateEl.textContent = isLidOpen ? 'Open' : 'Closed';
            lidStateEl.className = isLidOpen ? 'text-danger' : 'text-success';
        }
        
        // New: Detect lid open/close state changes and log
        if (details.lid_open !== undefined) {
            const prevLidState = window.prevLidState;
            if (prevLidState !== undefined && prevLidState !== details.lid_open) {
                addLog(`Lid state changed: ${details.lid_open ? 'Opened' : 'Closed'}`, 'info');
            }
            window.prevLidState = details.lid_open;
        }
    }

    // --- Inventory Management Functions ---
    function setInventoryBySimulatedBatchWeight() {
        console.log("setInventoryBySimulatedBatchWeight called");
        const weightInput = document.getElementById('simulatedBatchWeight');
        const weight = parseFloat(weightInput.value);
        
        if (isNaN(weight) || weight < 0) {
            addLog("Please enter a valid simulated total weight (non-negative number).", "error");
            return;
        }
        
        // Ensure we have the latest data before proceeding
        fetchStatus()
            .then(() => {
                const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
                if (!details) {
                    addLog("No medication selected or data not available", "error");
                    return;
                }
                
                const wpp = parseFloat(details.wpp) || 0;
                if (wpp <= 0) {
                    addLog("Invalid weight per pill value", "error");
                    return;
                }
                
                const pillCount = Math.round(weight / wpp);
                addLog(`Setting inventory: ${pillCount} pills (${weight.toFixed(2)}g)`, "info");
                
                return sendCommand('/set_inventory', {
                    medication_name: pcActiveMedicationNameGlobal,
                    total_weight: weight,
                    pill_count: pillCount
                }, 'POST', 'Set Inventory');
            })
            .then(data => {
                if (data && data.status === 'success') {
                    updateSummaryInfo();
                }
            })
            .catch(error => {
                console.error("Error setting inventory:", error);
                addLog("Failed to set inventory: " + error.message, "error");
            });
    }

    function setInventoryByManualPillCount() {
        console.log("setInventoryByManualPillCount called");
        const countInput = document.getElementById('manualPillCount');
        const count = parseInt(countInput.value);
        
        if (isNaN(count) || count < 0) {
            addLog("Please enter a valid pill count (non-negative integer).", "error");
            return;
        }
        
        // Ensure we have the latest data before proceeding
        fetchStatus()
            .then(() => {
                const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
                if (!details) {
                    addLog("No medication selected or data not available", "error");
                    return;
                }
                
                const wpp = parseFloat(details.wpp) || 0;
                if (wpp <= 0) {
                    addLog("Invalid weight per pill value", "error");
                    return;
                }
                
                const totalWeight = count * wpp;
                addLog(`Setting inventory: ${count} pills (${totalWeight.toFixed(2)}g)`, "info");
                
                return sendCommand('/set_inventory', {
                    medication_name: pcActiveMedicationNameGlobal,
                    total_weight: totalWeight,
                    pill_count: count
                }, 'POST', 'Set Inventory');
            })
            .then(data => {
                if (data && data.status === 'success') {
                    updateSummaryInfo();
                }
            })
            .catch(error => {
                console.error("Error setting inventory:", error);
                addLog("Failed to set inventory: " + error.message, "error");
            });
    }

    // 修改现有的WPP相关函数
    function setWPPFromSimulatedSinglePillWeight() {
        console.log("setWPPFromSimulatedSinglePillWeight called");
        if (!pcActiveMedicationNameGlobal) { 
            addLog("Please select a medication from the list as the current active medication before setting its WPP.", "error"); 
            return; 
        }
        const inputEl = document.getElementById('simulatedSinglePillWeightInput');
        if (!inputEl) { 
            console.error("simulatedSinglePillWeightInput not found"); 
            return; 
        }
        const singlePillWeightStr = inputEl.value.trim();
        if (singlePillWeightStr === "" || isNaN(parseFloat(singlePillWeightStr))) {
            addLog("Please enter a valid number.", "error"); 
            return;
        }
        const wpp = parseFloat(singlePillWeightStr);
        if (wpp <= 0.0001) {
            addLog("Single pill weight must be greater than 0.0001g.", "error"); 
            return;
        }
        
        addLog(`Setting WPP for '${pcActiveMedicationNameGlobal}' to ${wpp}g...`, "info");
        
        sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: wpp }, 'POST', `Set '${pcActiveMedicationNameGlobal}' WPP`)
            .then(data => {
                if (data.status === 'success') {
                    // Clear input field
                    inputEl.value = '';
                    
                    // Delay getting latest data and moving to step 4
                    setTimeout(() => {
                        fetchStatus()
                            .then(() => {
                                moveToWppStep(4);
                                updateSummaryInfo();
                            })
                            .catch(err => {
                                console.error("Failed to get status:", err);
                                addLog("Failed to get latest status, but WPP setting may have succeeded.", "warn");
                                moveToWppStep(4);
                            });
                    }, 500);
        } else {
                    addLog(`Failed to set WPP: ${data.message || 'Unknown error'}`, "error");
                }
            })
            .catch(err => {
                console.error("Error setting WPP:", err);
                addLog(`Failed to set WPP: ${err.message || err}`, "error");
            });
    }
    
    // 添加"真实/模拟"模式下的模拟重量输入处理函数
    function setWPPFromRealModeSimulatedWeight() {
        console.log("setWPPFromRealModeSimulatedWeight called");
        if (!pcActiveMedicationNameGlobal) { 
            addLog("Please select a medication from the list as the current active medication before setting its WPP.", "error"); 
            return; 
        }
        const inputEl = document.getElementById('simulatedRealModeWeightInput');
        if (!inputEl) { 
            console.error("simulatedRealModeWeightInput not found"); 
            return; 
        }
        const singlePillWeightStr = inputEl.value.trim();
        if (singlePillWeightStr === "" || isNaN(parseFloat(singlePillWeightStr))) {
            addLog("Please enter a valid number.", "error"); 
            return;
        }
        const wpp = parseFloat(singlePillWeightStr);
        if (wpp <= 0.0001) {
            addLog("Single pill weight must be greater than 0.0001g.", "error"); 
            return;
        }
        
        addLog(`Setting WPP for '${pcActiveMedicationNameGlobal}' to ${wpp}g...`, "info");
        
        sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: wpp }, 'POST', `Set '${pcActiveMedicationNameGlobal}' WPP`)
            .then(data => {
                if (data.status === 'success') {
                    // 清空输入框
                    inputEl.value = '';
                    
                    // 延迟获取最新数据并移动到步骤4
                    setTimeout(() => {
                        fetchStatus()
                            .then(() => {
                                moveToWppStep(4);
                                updateSummaryInfo();
                            })
                            .catch(err => {
                                console.error("获取状态失败:", err);
                                addLog("获取最新状态失败，但WPP设置可能已成功。", "warn");
                                moveToWppStep(4);
                            });
                    }, 500);
                } else {
                    addLog(`Failed to set WPP: ${data.message || 'Unknown error'}`, "error");
                }
            })
            .catch(err => {
                console.error("Error setting WPP:", err);
                addLog(`Failed to set WPP: ${err.message || err}`, "error");
            });
    }
    
     function measureSinglePillForActiveMedReal() {
        console.log("measureSinglePillForActiveMedReal called, sim mode:", currentIsSimulationGlobal);
        if (!pcActiveMedicationNameGlobal) { addLog("Please select a medication first to measure its single pill weight.", "error"); return; }
        
        if (currentIsSimulationGlobal) { 
            const singlePillWeightStr = prompt(`Simulated real measurement: Please enter the simulated weight (g) for a single pill of "${pcActiveMedicationNameGlobal}":`, "0.25");
            if (singlePillWeightStr === null) { console.log("Simulated real measurement cancelled by user."); return; }
            if (singlePillWeightStr === "" || isNaN(parseFloat(singlePillWeightStr)) || parseFloat(singlePillWeightStr) <= 0.0001) {
                 addLog("Invalid simulated measurement weight.", "error"); return;
            }
            const wpp = parseFloat(singlePillWeightStr);
            sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: wpp }, 'POST', `(Simulated Real Measurement) Set '${pcActiveMedicationNameGlobal}' WPP`)
                .then(data => {
                    if(data.status === 'success') {
                        // 移动到步骤4
                        moveToWppStep(4);
                    }
                });
        } else { 
            // 在真实模式下测量单片药重
            // 首先显示加载指示和反馈
            const confirmBtn = document.getElementById('confirmRealMeasurementBtn');
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 测量中...';
            }
            
            addLog(`Commanding Arduino to measure single pill weight for '${pcActiveMedicationNameGlobal}', please wait...`, "info");
            
            sendCommand('/measure_single_pill_real_mode_for_active_med', {}, 'POST', `Command Arduino to measure '${pcActiveMedicationNameGlobal}' single pill weight`)
                .then(data => {
                    if(data.status === 'success') {
                        addLog(`Measuring single pill weight for '${pcActiveMedicationNameGlobal}', waiting for results...`, "info");
                        
                        // 获取初始WPP以便检测变化
                        let initialWpp = null;
                        if (pcActiveMedicationNameGlobal && pc_managed_medication_details[pcActiveMedicationNameGlobal]) {
                            initialWpp = pc_managed_medication_details[pcActiveMedicationNameGlobal].wpp;
                        }
                        
                        // 定义一个函数来检查WPP是否已更新
                        let attempts = 0;
                        const checkWppUpdated = function() {
                            attempts++;
                            
                            // 尝试获取最新状态
                            fetchStatus()
                                .then(() => {
                                    // 检查WPP是否已更新
                                    if (pcActiveMedicationNameGlobal && pc_managed_medication_details[pcActiveMedicationNameGlobal]) {
                                        const currentWpp = pc_managed_medication_details[pcActiveMedicationNameGlobal].wpp;
                                        
                                        // 如果WPP已更新或已有有效WPP
                                        if ((initialWpp === null && currentWpp > 0.0001) || 
                                            (initialWpp !== null && Math.abs(currentWpp - initialWpp) > 0.0001)) {
                                            addLog(`Successfully measured and updated WPP for '${pcActiveMedicationNameGlobal}' to ${currentWpp.toFixed(3)}g`, "success");
                                            
                                            // 重置按钮状态
                                            if (confirmBtn) {
                                                confirmBtn.disabled = false;
                                                confirmBtn.textContent = 'Confirm Single Pill Weight Measurement';
                                            }
                                            
                                            // 移动到步骤4
                                            moveToWppStep(4);
                                            return;
                                        }
                                    }
                                    
                                    // 如果尚未更新但尝试次数未达上限，继续尝试
                                    if (attempts < 10) {
                                        setTimeout(checkWppUpdated, 1000);
                                    } else {
                                        // 尝试次数过多，提供手动继续选项
                                        addLog(`Could not automatically detect WPP update, but operation may have succeeded. You can click the button below to continue.`, "warn");
                                        
                                        // 重置按钮状态并更改为继续按钮
                                        if (confirmBtn) {
                                            confirmBtn.disabled = false;
                                            confirmBtn.textContent = 'Manually Continue to Next Step';
                                            confirmBtn.onclick = function() {
                                                moveToWppStep(4);
                                            };
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error("Error checking WPP update:", error);
                                    
                                    // 如果出错但尝试次数未达上限，继续尝试
                                    if (attempts < 5) {
                                        setTimeout(checkWppUpdated, 1000);
                                    } else {
                                        // 尝试次数过多，提供手动继续选项
                                        addLog(`Due to connection issues, unable to detect WPP update, but operation may have succeeded.`, "warn");
                                        
                                        // 重置按钮状态并更改为继续按钮
                                        if (confirmBtn) {
                                            confirmBtn.disabled = false;
                                            confirmBtn.textContent = 'Manually Continue to Next Step';
                                            confirmBtn.onclick = function() {
                                                moveToWppStep(4);
                                            };
                                        }
                                    }
                                });
                        };
                        
                        // 开始检查WPP更新
                        setTimeout(checkWppUpdated, 1500);
                    } else {
                        // 命令发送失败，重置按钮状态
                        if (confirmBtn) {
                            confirmBtn.disabled = false;
                            confirmBtn.textContent = 'Confirm Single Pill Weight Measurement';
                        }
                        addLog(`Failed to command Arduino to measure single pill weight: ${data.message || 'Unknown error'}`, "error");
                    }
                })
                .catch(error => {
                    // 出错时重置按钮状态
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Confirm Single Pill Weight Measurement';
                    }
                    addLog(`Error when commanding Arduino to measure single pill weight: ${error.message || error}`, "error");
                });
        }
    }

    function moveToStep4WithCurrentWeight() {
        // 在真实模式下，使用当前重量作为WPP值
        if (!currentIsSimulationGlobal) {
            // 显示加载指示器
            addLog("Getting latest weight data...", "info");
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'text-center mt-2';
            loadingIndicator.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><div class="mt-1">Getting weight...</div>';
            
            const weightContainer = document.getElementById('realTimeWeightContainerInStep3');
            if (weightContainer) {
                weightContainer.appendChild(loadingIndicator);
            }
            
            // 主动获取一次最新重量，确保数据准确
            fetch('/get_current_weight')
                .then(response => response.json())
                .then(data => {
                    // 移除加载指示器
                    if (loadingIndicator && loadingIndicator.parentNode) {
                        loadingIndicator.parentNode.removeChild(loadingIndicator);
                    }
                    
                    let currentWeight = 0;
                    let weightSource = "";
                    
                    if (data.status === 'success' && data.weight !== undefined) {
                        currentWeight = parseFloat(data.weight);
                        weightSource = "API";
                        console.log("获取到最新重量:", currentWeight);
                    } else {
                        // 如果API返回错误，尝试使用显示的值
                        try {
                            currentWeight = parseFloat(document.getElementById('realTimeWeightValueInStep3').textContent);
                            weightSource = "显示值";
                            console.log("使用显示的重量:", currentWeight);
                        } catch (e) {
                            console.error("无法解析显示的重量值:", e);
                        }
                    }
                    
                    if (!isNaN(currentWeight) && currentWeight > 0.0001) {
                        addLog(`Using weight obtained from ${weightSource}: ${currentWeight.toFixed(3)}g`, "info");
                        
                        sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: currentWeight }, 'POST', `Set WPP to current weight`)
                            .then(data => {
                                if (data.status === 'success') {
                                    addLog(`WPP has been set to current weight: ${currentWeight.toFixed(3)}g`, "success");
                                    
                                    // 清除步骤3的实时重量更新定时器
                                    if (window.step3WeightUpdateInterval) {
                                        clearInterval(window.step3WeightUpdateInterval);
                                        window.step3WeightUpdateInterval = null;
                                    }
                                    
                                    moveToWppStep(4);
                                } else {
                                    addLog(`设置WPP失败: ${data.message || '未知错误'}`, "error");
                                }
                            })
                            .catch(error => {
                                addLog(`设置WPP时发生错误: ${error.message || error}`, "error");
                            });
                    } else {
                                            addLog("Current weight is invalid or too small (less than 0.0001g), please measure again", "error");
                }
            })
            .catch(error => {
                // 移除加载指示器
                if (loadingIndicator && loadingIndicator.parentNode) {
                    loadingIndicator.parentNode.removeChild(loadingIndicator);
                }
                
                console.error("Failed to get latest weight:", error);
                addLog("Failed to get latest weight, trying to use displayed value", "warn");
                    
                    // 尝试使用显示的值
                    try {
                        let displayedWeight = parseFloat(document.getElementById('realTimeWeightValueInStep3').textContent);
                        if (!isNaN(displayedWeight) && displayedWeight > 0.0001) {
                            addLog(`Using displayed weight value: ${displayedWeight.toFixed(3)}g`, "info");
                            
                            sendCommand('/set_wpp_for_active_med_pc_and_arduino', { wpp: displayedWeight }, 'POST', `Set WPP to displayed weight`)
                                .then(data => {
                                    if (data.status === 'success') {
                                        addLog(`WPP has been set to displayed weight: ${displayedWeight.toFixed(3)}g`, "success");
                                        moveToWppStep(4);
                                    } else {
                                        addLog(`设置WPP失败: ${data.message || '未知错误'}`, "error");
                                    }
                                })
                                .catch(error => {
                                    addLog(`设置WPP时发生错误: ${error.message || error}`, "error");
                                });
                        } else {
                                                    addLog("Displayed weight value is invalid, please measure again", "error");
                    }
                } catch (e) {
                    addLog("Unable to read displayed weight value, please measure again", "error");
                    console.error("Error parsing displayed weight:", e);
                }
            });
        } else {
            // 在模拟模式下，检查是否已输入重量
            const inputEl = document.getElementById('simulatedRealModeWeightInput');
            if (inputEl && inputEl.value && parseFloat(inputEl.value) > 0.0001) {
                setWPPFromRealModeSimulatedWeight();
            } else {
                addLog("Please enter a valid simulated weight first", "warn");
                moveToWppStep(4);
            }
        }
    }

    // 添加到index.html的JS代码部分，放在script部分最后
    function forceRefreshWeight() {
        const refreshBtn = document.getElementById('refreshWeightBtn');
        const statusEl = document.getElementById('weightUpdateStatusInStep5');
        const weightEl = document.getElementById('currentWeightDisplayInStep5');
                                if (refreshBtn) { refreshBtn.disabled = true; refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing'; }
        if (statusEl) { statusEl.textContent = 'Refreshing...'; statusEl.classList.remove('text-success','text-danger'); }
        
        fetch('/force_refresh_weight', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const weight = parseFloat(data.weight);
                if (weightEl) weightEl.textContent = weight.toFixed(3);
                if (statusEl) { statusEl.textContent = 'Refresh successful: ' + (data.message || ''); statusEl.classList.add('text-success'); statusEl.classList.remove('text-danger'); }
            } else {
                if (statusEl) { statusEl.textContent = 'Refresh failed: ' + (data.message || 'Unknown error'); statusEl.classList.add('text-danger'); statusEl.classList.remove('text-success'); }
            }
        })
        .catch(error => {
            console.error("Failed to get weight:", error);
            if (statusEl) { statusEl.textContent = 'Failed to get weight, please try again'; statusEl.classList.add('text-danger'); statusEl.classList.remove('text-success'); }
        })
        .finally(() => {
            if (refreshBtn) { refreshBtn.disabled = false; refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Weight'; }
        });
    }

    function updateStep5WeightDisplay(weight) {
        const el = document.getElementById('currentWeightDisplayInStep5');
        if (el) el.textContent = weight.toFixed(3);
    }

    function confirmWeightAndSetInventory() {
        if (!pcActiveMedicationNameGlobal) {
            addLog("Please select a medication first", "error");
            return;
        }
        
        const currentWeightEl = document.getElementById('currentWeightDisplayInStep5');
        const currentWeight = currentWeightEl ? parseFloat(currentWeightEl.textContent) : 0;
        const wpp = pc_managed_medication_details[pcActiveMedicationNameGlobal].wpp;
        
        if (wpp <= 0.001) {
            addLog("The selected medication's single pill weight is invalid, please set WPP first", "error");
            return;
        }
        
        const pillCount = Math.round(currentWeight / wpp);
        const confirmBtn = document.getElementById('confirmWeightBtnInStep5');
        if (confirmBtn) { confirmBtn.disabled = true; confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中'; }
        
        // 使用已有的API更新状态
        fetch('/update_state_from_manual_count_for_active_med', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ count: pillCount })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                addLog(`Inventory confirmed: ${pillCount} pills (${currentWeight.toFixed(3)}g)`, "success");
                // 进入下一步
                moveToWppStep(6);
            } else {
                addLog(data.message || "Failed to set inventory", "error");
            }
        })
        .catch(error => {
            console.error("Failed to set inventory:", error);
            addLog("Unable to connect to server", "error");
        })
        .finally(() => {
            if (confirmBtn) { confirmBtn.disabled = false; confirmBtn.textContent = 'Confirm Weight and Pill Count'; }
        });
    }

    // 每次切换到步骤5时，自动开始重量监测
    function startStep5WeightMonitoring() {
        // 停止之前可能存在的定时器
        if (window.step5WeightInterval) {
            clearInterval(window.step5WeightInterval);
        }
        // 立即刷新一次
        refreshWeightStep5();
        // 周期刷新
        window.step5WeightInterval = setInterval(refreshWeightStep5, 2000);
    }

    // 新增：仅使用缓存接口刷新步骤5重量
    function refreshWeightStep5() {
      fetch('/get_current_weight')
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            const w = parseFloat(data.weight);
            const wEl = document.getElementById('currentWeightDisplayInStep5');
            if (wEl) wEl.textContent = w.toFixed(3);
            // 更新药片计数
            const details = pc_managed_medication_details[pcActiveMedicationNameGlobal];
            if (details && details.wpp > 0.001) {
              const count = Math.round(w / details.wpp);
              const countEl = document.getElementById('pillCountDisplayInStep5');
              if (countEl) countEl.textContent = count;
              // 更新进度条
              const pct = Math.min(100, Math.round((count / 100) * 100));
              const bar = document.getElementById('pillCountProgressBarInStep5');
              if (bar) { bar.style.width = pct + '%'; bar.setAttribute('aria-valuenow', pct); }
            }
          }
        }).catch(err => console.error('Failed to read current weight:', err));
    }

    // 修改自动刷新逻辑
    function startStep5WeightMonitoring() {
      if (window.step5WeightInterval) clearInterval(window.step5WeightInterval);
      // 立即刷新一次
      refreshWeightStep5();
      // 周期刷新
      window.step5WeightInterval = setInterval(refreshWeightStep5, 2000);
    }

    // 修改moveToWppStep函数，添加对步骤5的特殊处理
    const originalMoveToWppStep = window.moveToWppStep;
    window.moveToWppStep = function(stepNumber, mode) {
        // 先调用原始函数
        originalMoveToWppStep(stepNumber, mode);
        
        // 如果是步骤5，启动重量监测
        if (stepNumber === 5) {
            // 延迟一点启动，确保UI已更新
            setTimeout(() => {
                startStep5WeightMonitoring();
                
                // 更新WPP显示
                if (pcActiveMedicationNameGlobal && pc_managed_medication_details[pcActiveMedicationNameGlobal]) {
                    const wpp = pc_managed_medication_details[pcActiveMedicationNameGlobal].wpp;
                    $("#wppDisplayInStep5").text(wpp.toFixed(3) + " g");
                } else {
                    $("#wppDisplayInStep5").text("未设置");
                }
            }, 300);
        } else if (window.step5WeightInterval) {
            // 如果离开步骤5，停止重量监测
            clearInterval(window.step5WeightInterval);
            window.step5WeightInterval = null;
        }
    };

    // 在PC活动药物变更时更新WPP显示
    const originalSetPcActiveMedication = window.setPcActiveMedication;
    window.setPcActiveMedication = function(medName) {
        // 调用原始函数
        originalSetPcActiveMedication(medName);
        
        // 更新步骤5的WPP显示
        setTimeout(() => {
            if (medName && pc_managed_medication_details[medName]) {
                const wpp = pc_managed_medication_details[medName].wpp;
                $("#wppDisplayInStep5").text(wpp.toFixed(3) + " g");
            } else {
                $("#wppDisplayInStep5").text("未设置");
            }
        }, 500);
    };

    function confirmConsumption() {
        const weightReducedEl = document.getElementById('measuredWeightReduced');
        const pillCountEl = document.getElementById('measuredPillCount');
        const weightReduced = parseFloat(weightReducedEl.textContent) || 0;
        const pillCount = parseInt(pillCountEl.textContent) || 0;
        
        if (weightReduced <= 0 || pillCount <= 0) {
            addLog("Please measure consumption first", "error");
            return;
        }

        addLog(`Confirming consumption: ${pillCount} pills (${weightReduced.toFixed(2)}g)...`, "info");
        sendCommand('/confirm_consumption', {
            weight_reduced: weightReduced,
            pill_count: pillCount
        }, 'POST', `Confirm Consumption`)
            .then(data => {
                if (data.status === 'success') {
                    // Update UI to step 5
                    moveToMedicationStep(5);
                    
                    // Update session status
                    updateSessionStatus(true, `Consumption confirmed: ${pillCount} pills (${weightReduced.toFixed(2)}g)`);
                    
                    // Update summary information
                    updateSummaryInfo();
                }
            });
    }

    function lockMedicationCompartment() {
        addLog("Locking medication compartment...", "info");
        sendCommand('/lock_medication_compartment', {}, 'POST', `Lock Medication Compartment`)
            .then(data => {
                if (data.status === 'success') {
                    // Update UI to step 6
                    moveToMedicationStep(6);
                    
                    // Update session status
                    updateSessionStatus(true, `Compartment locked, medication session completed`);
                    
                    // Update summary information
                    updateSummaryInfo();
                }
            });
    }

    function cancelMedicationSession() {
        addLog("Cancelling medication session...", "info");
        sendCommand('/cancel_medication_session', {}, 'POST', `Cancel Medication Session`)
            .then(data => {
                if (data.status === 'success') {
                    // Reset UI to step 1
                    moveToMedicationStep(1);
                    
                    // Update session status
                    updateSessionStatus(false, `Medication session cancelled`);
                    
                    // Update summary information
                    updateSummaryInfo();
                }
            });
    }

    // --- UI Update Functions ---
    function updateSessionStatus(isActive, message) {
        const statusEl = document.getElementById('sessionStatus');
        if (statusEl) {
            statusEl.textContent = message;
            statusEl.className = isActive ? 'text-warning' : 'text-success';
        }
    }

    function moveToMedicationStep(step) {
        // Hide all steps first
        for (let i = 1; i <= 6; i++) {
            const stepEl = document.getElementById(`medicationStep${i}`);
            if (stepEl) {
                stepEl.style.display = 'none';
            }
        }
        
        // Show the target step
        const targetStep = document.getElementById(`medicationStep${step}`);
        if (targetStep) {
            targetStep.style.display = 'block';
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize medication session UI
        moveToMedicationStep(1);
        updateSessionStatus(false, 'No active medication session');
        
        // Add event listeners for medication session buttons
        const startBtn = document.getElementById('startMedicationBtn');
        const unlockBtn = document.getElementById('unlockCompartmentBtn');
        const measureBtn = document.getElementById('measureConsumptionBtn');
        const confirmBtn = document.getElementById('confirmConsumptionBtn');
        const lockBtn = document.getElementById('lockCompartmentBtn');
        const cancelBtn = document.getElementById('cancelSessionBtn');
        
        if (startBtn) startBtn.addEventListener('click', startMedicationSession);
        if (unlockBtn) unlockBtn.addEventListener('click', unlockMedicationCompartment);
        if (measureBtn) measureBtn.addEventListener('click', measureConsumption);
        if (confirmBtn) confirmBtn.addEventListener('click', confirmConsumption);
        if (lockBtn) lockBtn.addEventListener('click', lockMedicationCompartment);
        if (cancelBtn) cancelBtn.addEventListener('click', cancelMedicationSession);
    });
</script>
</body>
</html>
